<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zhangliangnbu.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Developer For Android">
<meta property="og:type" content="website">
<meta property="og:title" content="æ°¸æ’çš„ç æµ">
<meta property="og:url" content="https://zhangliangnbu.github.io/index.html">
<meta property="og:site_name" content="æ°¸æ’çš„ç æµ">
<meta property="og:description" content="Developer For Android">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="ç« äº®">
<meta property="article:tag" content="Andriod">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://zhangliangnbu.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>æ°¸æ’çš„ç æµ</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">æ°¸æ’çš„ç æµ</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">ä¸‡ç‰©çš†æµï¼Œæ— ç‰©å¸¸é©»</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhangliangnbu.github.io/2021/12/17/android-activity-start-guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="ç« äº®">
      <meta itemprop="description" content="Developer For Android">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ°¸æ’çš„ç æµ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/17/android-activity-start-guide/" class="post-title-link" itemprop="url">Andoird 10 Activityå¯åŠ¨æµç¨‹æ¦‚è§ˆ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-12-17 15:49:34" itemprop="dateCreated datePublished" datetime="2021-12-17T15:49:34+08:00">2021-12-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-12-20 15:38:57" itemprop="dateModified" datetime="2021-12-20T15:38:57+08:00">2021-12-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">Androidç³»ç»Ÿå¼€å‘</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>åŸºäºAndroid 10 æºç  ã€‚Activityå¯åŠ¨åˆ†ä¸ºä¸¤ç§ï¼š</p>
<ul>
<li>æ™®é€šActivityå¯åŠ¨ï¼šAPPå·²ç»å¯åŠ¨ï¼Œä¸€èˆ¬åœ¨APPå†…ä»ä¸€ä¸ªActivityå¯åŠ¨å¦ä¸€ä¸ªActivityã€‚</li>
<li>æ ¹Activityå¯åŠ¨ï¼šä¹Ÿç§°ä¸ºAPPå†·å¯åŠ¨ï¼ŒAppè¿˜æ²¡æœ‰å¯åŠ¨ï¼Œä¸€èˆ¬ä»Launcherç•Œé¢å¯åŠ¨ã€‚</li>
</ul>
<p>ä¸¤è€…ä¸»æµç¨‹åŸºæœ¬ä¸€è‡´ï¼ŒåŒºåˆ«åœ¨äºæ ¹Activityå¯åŠ¨æµç¨‹è¿˜åŒ…å«å¯åŠ¨APPè¿›ç¨‹å’Œå®ä¾‹åŒ–Applicationçš„æµç¨‹ã€‚</p>
<h1 id="æ™®é€šActivityå¯åŠ¨æµç¨‹"><a href="#æ™®é€šActivityå¯åŠ¨æµç¨‹" class="headerlink" title="æ™®é€šActivityå¯åŠ¨æµç¨‹"></a>æ™®é€šActivityå¯åŠ¨æµç¨‹</h1><h2 id="æµç¨‹æ¦‚è¿°"><a href="#æµç¨‹æ¦‚è¿°" class="headerlink" title="æµç¨‹æ¦‚è¿°"></a>æµç¨‹æ¦‚è¿°</h2><p>åˆ†ææ–¹æ³•<code>Activity.startActivity()</code> åˆ°<code>Activity.onCreate()</code>çš„æµç¨‹ï¼Œæµç¨‹å›¾å¦‚ä¸‹ã€‚</p>
<p><img src="/images/aosp10-activity-start-create.svg" alt="aosp10-activity-start-create"></p>
<p>æµç¨‹è¯´æ˜ï¼š</p>
<ol>
<li>å®¢æˆ·ç«¯å‘èµ·å¯åŠ¨Activityè¯·æ±‚ã€‚å®¢æˆ·ç«¯é‡Œçš„Activityé€šè¿‡<code>Instrumentation.execStartActivity()</code>è¯·æ±‚æœåŠ¡ç«¯çš„ATMSå¯åŠ¨Activityã€‚</li>
<li>æœåŠ¡ç«¯å®ŒæˆIntentè§£æå’Œæ•°æ®ã€æƒé™ã€çŠ¶æ€ç­‰æ£€æŸ¥çš„å‡†å¤‡å·¥ä½œã€‚ATMSé€šè¿‡ActivityStarterã€ActivityStackã€ActivityStackSupervisorç­‰å®ŒæˆIntentè§£æã€æ£€æŸ¥ç­‰å‡†å¤‡å·¥ä½œï¼Œå¹¶å°†æ•°æ®ä¼ é€’ç»™å®¢æˆ·ç«¯çš„ApplicationThreadï¼Œè¯·æ±‚åè€…å®Œæˆå‰©ä½™å¯åŠ¨å·¥ä½œã€‚</li>
<li>å®¢æˆ·ç«¯å®ŒæˆActivityçš„åˆ›å»ºã€æ•°æ®ç»‘å®šã€onCreateå›è°ƒç­‰å·¥ä½œã€‚ApplicationThreadé€šè¿‡ActivityThreadå°†æ•°æ®ä¼ åˆ°å…¶ä¸»çº¿ç¨‹çš„Handlerä¸­è¿›è¡Œå¤„ç†ï¼Œå®ŒæˆActivityçš„åˆ›å»ºã€æ•°æ®ç»‘å®šå’ŒonCreateå›è°ƒç­‰å·¥ä½œã€‚</li>
</ol>
<h2 id="æ–¹æ³•è¯´æ˜"><a href="#æ–¹æ³•è¯´æ˜" class="headerlink" title="æ–¹æ³•è¯´æ˜"></a>æ–¹æ³•è¯´æ˜</h2><h3 id="Instrumentation-execStartActivity"><a href="#Instrumentation-execStartActivity" class="headerlink" title="Instrumentation.execStartActivity()"></a><code>Instrumentation.execStartActivity()</code></h3><p>è¯·æ±‚æœåŠ¡ç«¯çš„ATMSå¯åŠ¨Activity</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(Context who, IBinder contextThread, IBinder token ...)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// IPCï¼šè°ƒç”¨ ActivityTaskManagerService</span></span><br><span class="line">    <span class="keyword">int</span> result = ActivityTaskManager.getService().startActivity(</span><br><span class="line">        whoThread, <span class="comment">// å‘èµ·æ–¹ IApplicationThread</span></span><br><span class="line">        who.getBasePackageName(), <span class="comment">// å‘èµ·æ–¹ package name</span></span><br><span class="line">        intent, <span class="comment">// ç›®æ ‡</span></span><br><span class="line">        <span class="comment">// Data MIME ç±»å‹ï¼Œæ²¡æœ‰æ•°æ®æ—¶ä¸ºç©º</span></span><br><span class="line">        intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">        token,  <span class="comment">// å‘èµ·æ–¹ IBinder</span></span><br><span class="line">        target != <span class="keyword">null</span> ? target.mEmbeddedID : <span class="keyword">null</span>, <span class="comment">// mEmbeddedID ä½œç”¨ï¼ŸTODO</span></span><br><span class="line">        requestCode, </span><br><span class="line">        <span class="number">0</span>, <span class="comment">// startFlag</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// ProfilerInfo profilerInfo ä½œç”¨ï¼ŸTODO</span></span><br><span class="line">        options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ActivityStarter-startActivityMayWait"><a href="#ActivityStarter-startActivityMayWait" class="headerlink" title="ActivityStarter.startActivityMayWait()"></a><code>ActivityStarter.startActivityMayWait()</code></h3><p>è§£æIntent</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivityMayWait</span><span class="params">(IApplicationThread caller, <span class="keyword">int</span> callingUid ...)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è§£æIntentè·å–ResolveInfoï¼Œæ ¸å¿ƒæ˜¯è·å–å…¶æˆå‘˜ActivityInfoã€‚</span></span><br><span class="line">    <span class="comment">// æœ€ç»ˆè°ƒç”¨ PMS#queryIntentActivitiesInternal()ï¼š</span></span><br><span class="line">    <span class="comment">// 1. é€šè¿‡Intentä¸­ComponentNameè·å–å®‰è£…apkæˆ–æ‰«ææ—¶è§£æè¿‡å¹¶ä¿å­˜çš„ActivityInfo;</span></span><br><span class="line">    <span class="comment">// 2. è®¾ç½®ActivityInfoçš„metaDataå’ŒapplicationInfo</span></span><br><span class="line">    <span class="comment">// ä¸Šé¢çš„ActivityInfoä½œä¸ºæ–°å»ºçš„ResolveInfoæˆå‘˜ï¼Œè·Ÿéšåè€…ä¸€èµ·è¢«è¿”å›</span></span><br><span class="line">    ResolveInfo rInfo = mSupervisor.resolveIntent(intent, resolvedType, userId...);</span><br><span class="line">    <span class="comment">// æ™®é€šæƒ…å†µä»…ä»…å°†rInfoçš„æ•°æ®è®¾ç½®åˆ°intentä¸­</span></span><br><span class="line">    ActivityInfo aInfo = mSupervisor.resolveActivity(intent, rInfo, startFlags, profilerInfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ActivityStarter-startActivity"><a href="#ActivityStarter-startActivity" class="headerlink" title="ActivityStarter.startActivity()"></a><code>ActivityStarter.startActivity()</code></h3><p>æ£€æŸ¥æƒé™ç­‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, Intent intent ...)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥å¯åŠ¨æ–¹çš„æƒé™ï¼Œç³»ç»Ÿæ–¹æˆ–åŒä¸€ä¸ªAPPç­‰åˆ™å¯æˆæƒ</span></span><br><span class="line">    <span class="keyword">boolean</span> abort = !mSupervisor.checkStartAnyActivityPermission(intent, aInfo, resultWho ...);</span><br><span class="line">    abort |= !mService.mIntentFirewall.checkStartActivity(intent, callingUid ...);</span><br><span class="line">    abort |= !mService.getPermissionPolicyInternal().checkStartActivity(intent, callingUid,callingPackage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ActivityStackSupervisor-realStartActivityLocked"><a href="#ActivityStackSupervisor-realStartActivityLocked" class="headerlink" title="ActivityStackSupervisor.realStartActivityLocked()"></a><code>ActivityStackSupervisor.realStartActivityLocked()</code></h3><p>ç”Ÿæˆäº‹åŠ¡ï¼Œä¸ºIPCåˆ°å®¢æˆ·ç«¯åˆ›å»ºActivityå‡†å¤‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">realStartActivityLocked</span><span class="params">(ActivityRecord r, WindowProcessController proc...)</span></span>&#123;</span><br><span class="line">    <span class="comment">// å‡†å¤‡å·¥ä½œï¼šé”å®šå±å¹•ã€å¼€å§‹è®¡æ—¶ã€ç»‘å®šè¿›ç¨‹ã€ç¡®ä¿å¯è§å’Œé…ç½®...</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// æ·»åŠ å¯åŠ¨Activityäº‹åŠ¡é¡¹</span></span><br><span class="line">    <span class="keyword">final</span> ClientTransaction clientTransaction = ClientTransaction.obtain(proc.getThread(), r.appToken);</span><br><span class="line">    <span class="keyword">final</span> DisplayContent dc = r.getDisplay().mDisplayContent;</span><br><span class="line">	clientTransaction.addCallback(LaunchActivityItem.obtain(<span class="keyword">new</span> Intent(r.intent), ...));</span><br><span class="line">    <span class="comment">// æ·»åŠ ä½¿Activityå¤„äºresumeäº‹åŠ¡é¡¹</span></span><br><span class="line">    <span class="comment">// åœ¨TransactionExecutor.execute()é‡Œä¼šä¾æ¬¡å¤„ç†callbackã€LifecycleState</span></span><br><span class="line">    <span class="keyword">final</span> ActivityLifecycleItem lifecycleItem;</span><br><span class="line">    <span class="keyword">if</span> (andResume) &#123;</span><br><span class="line">        lifecycleItem = ResumeActivityItem.obtain(dc.isNextTransitionForward());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        lifecycleItem = PauseActivityItem.obtain();</span><br><span class="line">    &#125;</span><br><span class="line">    clientTransaction.setLifecycleStateRequest(lifecycleItem);</span><br><span class="line">    <span class="comment">// Schedule transaction.</span></span><br><span class="line">	<span class="comment">// ActivityTaskManagerService</span></span><br><span class="line">    mService.getLifecycleManager().scheduleTransaction(clientTransaction);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ActivityThread-performLaunchActivity"><a href="#ActivityThread-performLaunchActivity" class="headerlink" title="ActivityThread.performLaunchActivity()"></a><code>ActivityThread.performLaunchActivity()</code></h3><p>åˆ›å»ºActivityï¼Œç»‘å®šæ•°æ®ç­‰ï¼Œæ‰§è¡Œ<code>Activity.onCreate()</code>å›è°ƒã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// activity å‡†å¤‡åˆ›å»ºéœ€è¦çš„ç›¸å…³æ•°æ®ï¼Œåˆ›å»º</span></span><br><span class="line">    ActivityInfo aInfo = r.activityInfo;</span><br><span class="line">    ComponentName component = r.intent.getComponent();</span><br><span class="line">    ContextImpl appContext = createBaseContextForActivity(r);</span><br><span class="line">    java.lang.ClassLoader cl = appContext.getClassLoader();</span><br><span class="line">    <span class="comment">// åå°„åˆ›å»ºActivityå¯¹è±¡ï¼Œè¿˜ä¸èƒ½äº¤äº’</span></span><br><span class="line">    Activity activity = mInstrumentation.newActivity(cl, component.getClassName(), r.intent);</span><br><span class="line">    <span class="comment">// å¦‚æœå·²ç»å­˜åœ¨ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">    Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line">    <span class="comment">// ç»‘å®šActivityä¸å…¶ä»–æ•°æ®ï¼šç»‘å®šContextï¼Œåˆ›å»ºPhoneWindowï¼Œç»‘å®šçº¿ç¨‹ã€Tokenã€Applicationç­‰</span></span><br><span class="line">    activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token...);</span><br><span class="line">    <span class="comment">// è§¦å‘onCreateè°ƒç”¨</span></span><br><span class="line">    mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="æ ¹Activityå¯åŠ¨æµç¨‹"><a href="#æ ¹Activityå¯åŠ¨æµç¨‹" class="headerlink" title="æ ¹Activityå¯åŠ¨æµç¨‹"></a>æ ¹Activityå¯åŠ¨æµç¨‹</h1><h2 id="æµç¨‹æ¦‚è¿°-1"><a href="#æµç¨‹æ¦‚è¿°-1" class="headerlink" title="æµç¨‹æ¦‚è¿°"></a>æµç¨‹æ¦‚è¿°</h2><p>ä¸€èˆ¬ä¹Ÿç§°ä¸ºAPPå†·å¯åŠ¨æµç¨‹ï¼Œåˆ†æä»Launcherç•Œé¢ç‚¹å‡»APPå›¾æ ‡åˆ°APPæ˜¾ç¤ºå®Œæˆçš„æµç¨‹ã€‚ç›¸æ¯”ä»æ™®é€šActivityå¯åŠ¨æµç¨‹ï¼ŒAppçš„å†·å¯åŠ¨æµç¨‹å¤šäº†ä¸¤ä¸ªæ­¥éª¤ï¼šåˆ›å»ºè¿›ç¨‹ï¼Œç»‘å®šå¹¶åˆ›å»ºApplicationå¯¹è±¡ã€‚</p>
<p><img src="/images/aosp10-app-start-cold.svg" alt="aosp10_app_start_cold"></p>
<p>å›¾ä¸­è™šçº¿éƒ¨åˆ†æ˜¯åˆ›å»ºAPPè¿›ç¨‹å’Œå¯åŠ¨Applicationçš„æµç¨‹ã€‚</p>
<p>æ™®é€šActivityå¯åŠ¨æµç¨‹èµ°åˆ°<code>ActivityStackSupervisor.startSpecificActivityLocked()</code>æ—¶ï¼Œæœ‰ä¸€ä¸ªè¿›ç¨‹ç›¸å…³çš„åˆ¤æ–­ï¼šå¦‚æœåº”ç”¨è¿›ç¨‹å­˜åœ¨åˆ™å»å¯åŠ¨Activityï¼Œå¦åˆ™å»åˆ›å»ºè¿›ç¨‹ã€‚å†·å¯åŠ¨æ—¶ï¼ŒAppè¿›ç¨‹è¿˜ä¸å­˜åœ¨ï¼Œå› æ­¤éœ€è¦å»åˆ›å»ºè¿›ç¨‹ï¼Œå…¶å…¥å£ä¾¿æ˜¯è¿™é‡Œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">startSpecificActivityLocked</span><span class="params">(ActivityRecord r, <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Is this activity&#x27;s application already running?</span></span><br><span class="line">    <span class="keyword">final</span> WindowProcessController wpc =</span><br><span class="line">            mService.getProcessController(r.processName, r.info.applicationInfo.uid);</span><br><span class="line">    <span class="keyword">boolean</span> knownToBeDead = <span class="keyword">false</span>;</span><br><span class="line">	<span class="comment">// APPè¿›ç¨‹å­˜åœ¨æ—¶ï¼Œå¯åŠ¨Activity</span></span><br><span class="line">    <span class="keyword">if</span> (wpc != <span class="keyword">null</span> &amp;&amp; wpc.hasThread()) &#123;</span><br><span class="line">        <span class="comment">// å¯åŠ¨ Activity</span></span><br><span class="line">        realStartActivityLocked(r, wpc, andResume, checkConfig);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// APPè¿›ç¨‹ä¸å­˜åœ¨æ—¶ï¼Œåˆ›å»ºè¿›ç¨‹</span></span><br><span class="line">    <span class="comment">// Message é‡Œè®¾ç½®äº†ä¸€ä¸ªå›è°ƒï¼Œå³ ActivityManagerInternal.startProcess</span></span><br><span class="line">    <span class="keyword">final</span> Message msg = PooledLambda.obtainMessage(</span><br><span class="line">            ActivityManagerInternal::startProcess, mService.mAmInternal, r.processName,</span><br><span class="line">            r.info.applicationInfo, knownToBeDead, <span class="string">&quot;activity&quot;</span>, r.intent.getComponent());</span><br><span class="line">		<span class="comment">// å‘é€æ¶ˆæ¯åˆ°&quot;android.display&quot;çº¿ç¨‹å¤„ç†</span></span><br><span class="line">    mService.mH.sendMessage(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>APPçš„å†·å¯åŠ¨è¿‡ç¨‹ä¸»æ¶‰åŠåˆ°å››ä¸ªè¿›ç¨‹ï¼šLauncherè¿›ç¨‹ï¼ˆå¯åŠ¨APPçš„è¿›ç¨‹ï¼‰ã€SystemServerè¿›ç¨‹ã€APPè¿›ç¨‹ã€Zygoteè¿›ç¨‹ï¼›ä¸‰ä¸ªé‡è¦å·¥ä½œï¼šå¯åŠ¨è¿›ç¨‹ã€å¯åŠ¨Applicationã€å¯åŠ¨Activityã€‚</p>
<p>æ•´ä¸ªæµç¨‹ç®€è¿°ä¸ºï¼š</p>
<ul>
<li>Launcherè¿›ç¨‹è¯·æ±‚SystemServerè¿›ç¨‹åˆ›å»ºActivity</li>
<li>SystemServerè¿›ç¨‹è§£æIntentç­‰ï¼Œå¹¶æ£€æŸ¥ç›®æ ‡APPè¿›ç¨‹æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™å»åˆ›å»ºè¿›ç¨‹ã€‚</li>
<li>SystemServerè¿›ç¨‹é€šè¿‡Socketæ–¹å¼è¯·æ±‚Zygoteè¿›ç¨‹åˆ›å»ºAPPè¿›ç¨‹ï¼Œè¿”å›è¿›ç¨‹å·ç­‰ä¿¡æ¯ã€‚</li>
<li>Appè¿›ç¨‹å…¥å£ä¸º<code>ActivityThread.main()</code>æ–¹æ³•ï¼Œæ‰§è¡Œæ­¤æ–¹æ³•ï¼Œåˆå§‹åŒ–è¿›ç¨‹å¹¶è¯·æ±‚SystemServerç»‘å®šAPPè¿›ç¨‹ã€‚ç»‘å®šè¿›ç¨‹çš„å·¥ä½œåŒ…æ‹¬ï¼Œä¸€ï¼Œé€šçŸ¥APPè¿›ç¨‹å»å¯åŠ¨Applicationï¼›äºŒï¼Œé€šçŸ¥APPè¿›ç¨‹å»å¯åŠ¨Activityã€‚</li>
</ul>
<aside> ğŸ’¡ è¿™é‡Œè¯´çš„å¯åŠ¨åŒ…å«åˆ›å»ºå®ä¾‹ä»¥åŠæ‰§è¡Œå›è°ƒæ–¹æ³•ç­‰æ“ä½œã€‚

<h2 id="æ–¹æ³•è¯´æ˜-1"><a href="#æ–¹æ³•è¯´æ˜-1" class="headerlink" title="æ–¹æ³•è¯´æ˜"></a>æ–¹æ³•è¯´æ˜</h2><p>ä¸æ™®é€šActivityå¯åŠ¨æµç¨‹é‡å¤çš„æ–¹æ³•ä¸å†è¿›è¡Œè¯´æ˜</p>
<h3 id="ProcessList-startProcessLocked"><a href="#ProcessList-startProcessLocked" class="headerlink" title="ProcessList.startProcessLocked()"></a><code>ProcessList.startProcessLocked()</code></h3><p>æŒ‡å®šè¿›ç¨‹æ‰§è¡Œå…¥å£ä¸º<code>android.app.ActivityThread.main()</code>æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¾ç½®è¿›ç¨‹å¯åŠ¨ç›¸å…³å‚æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">startProcessLocked</span><span class="params">(ProcessRecord app, HostingRecord hostingRecord ...)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è¿›ç¨‹æ‰§è¡Œå…¥å£</span></span><br><span class="line">    <span class="keyword">final</span> String entryPoint = <span class="string">&quot;android.app.ActivityThread&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> startProcessLocked(hostingRecord, entryPoint, app, uid, gids,</span><br><span class="line">                              runtimeFlags, mountExternal, seInfo, requiredAbi, </span><br><span class="line">                              instructionSet, invokeWith,startTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ZygoteProcess-startViaZygote"><a href="#ZygoteProcess-startViaZygote" class="headerlink" title="ZygoteProcess.startViaZygote()"></a><code>ZygoteProcess.startViaZygote()</code></h3><p>è®¾ç½®zygoteå¯åŠ¨è¿›ç¨‹çš„å‚æ•°</p>
<h3 id="ZygoteProcess-attemptZygoteSendArgsAndGetResult"><a href="#ZygoteProcess-attemptZygoteSendArgsAndGetResult" class="headerlink" title="ZygoteProcess.attemptZygoteSendArgsAndGetResult()"></a><code>ZygoteProcess.attemptZygoteSendArgsAndGetResult()</code></h3><p>å‘é€æ•°æ®ä»¥å¯åŠ¨è¿›ç¨‹ï¼Œè·å–è¿›ç¨‹å¯åŠ¨åçš„è¿›ç¨‹å·ç­‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‘é€æ•°æ®ä»¥å¯åŠ¨è¿›ç¨‹ï¼Œè·å–è¿›ç¨‹å¯åŠ¨åçš„è¿›ç¨‹å·ç­‰</span></span><br><span class="line"><span class="keyword">private</span> Process.<span class="function">ProcessStartResult <span class="title">attemptZygoteSendArgsAndGetResult</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        ZygoteState zygoteState, String msgStr)</span> <span class="keyword">throws</span> ZygoteStartFailedEx </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> BufferedWriter zygoteWriter = zygoteState.mZygoteOutputWriter;</span><br><span class="line">    <span class="keyword">final</span> DataInputStream zygoteInputStream = zygoteState.mZygoteInputStream;</span><br><span class="line">	<span class="comment">// å‘æ¶ˆæ¯ç»™Zygoteè¿›ç¨‹ï¼Œå„ç§å‚æ•°</span></span><br><span class="line">    zygoteWriter.write(msgStr);</span><br><span class="line">    zygoteWriter.flush();</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// å¯åŠ¨è¿›ç¨‹ä¸­...æœ€ç»ˆä¼šæ‰§è¡ŒActivityThread.mainæ–¹æ³•</span></span><br><span class="line">    </span><br><span class="line">	<span class="comment">// è·å–å¯åŠ¨è¿›ç¨‹åç»“æœï¼Œè¿›ç¨‹å·ç­‰</span></span><br><span class="line">    Process.ProcessStartResult result = <span class="keyword">new</span> Process.ProcessStartResult();</span><br><span class="line">    result.pid = zygoteInputStream.readInt();</span><br><span class="line">    result.usingWrapper = zygoteInputStream.readBoolean();</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ActivityThread-main"><a href="#ActivityThread-main" class="headerlink" title="ActivityThread.main()"></a><code>ActivityThread.main()</code></h3><p>è¿›ç¨‹å…¥å£æ–¹æ³•ï¼Œåˆå§‹åŒ–ä¸»çº¿ç¨‹ï¼Œç»‘å®šè¿›ç¨‹ï¼Œå¯åŠ¨åº”ç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ä¸»çº¿ç¨‹Looper</span></span><br><span class="line">    Looper.prepareMainLooper();</span><br><span class="line">	<span class="comment">// å½“å‰å¯åŠ¨ä¸­è¿›ç¨‹çš„æ ‡è¯†ç¬¦ï¼Œä»ZygoteProcessç›¸å…³æ–¹æ³•ä¼ å…¥</span></span><br><span class="line">    <span class="keyword">long</span> startSeq = <span class="number">0</span>;</span><br><span class="line">	ActivityThread thread = <span class="keyword">new</span> ActivityThread();</span><br><span class="line">	<span class="comment">// ç»‘å®šè¿›ç¨‹ï¼Œfalse è¡¨ç¤ºéç³»ç»Ÿè¿›ç¨‹ï¼Œä¼šè°ƒç”¨AMS.attachApplication()</span></span><br><span class="line">    thread.attach(<span class="keyword">false</span>, startSeq);</span><br><span class="line">	<span class="comment">// ä¸»çº¿ç¨‹ç»‘å®šçš„Handler</span></span><br><span class="line">    sMainThreadHandler = thread.getHandler();</span><br><span class="line">	<span class="comment">// é˜²æ­¢çº¿ç¨‹ç»“æŸï¼Œç­‰å¾…å¦‚Application.onCreate()ã€Activity.onCreate()ç­‰å‘¨æœŸå›è°ƒæ–¹æ³•</span></span><br><span class="line">    Looper.loop();</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Main thread loop unexpectedly exited&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ActivityManagerService-attachApplicationLocked"><a href="#ActivityManagerService-attachApplicationLocked" class="headerlink" title="ActivityManagerService.attachApplicationLocked()"></a><code>ActivityManagerService.attachApplicationLocked()</code></h3><p> å¯åŠ¨Applicationã€å¯åŠ¨Activity</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–å¹¶è®¾ç½®Application Recordï¼Œå¯åŠ¨Applicationï¼Œå¯åŠ¨Activityç­‰</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(<span class="meta">@NonNull</span> IApplicationThread thread,<span class="keyword">int</span> pid, <span class="keyword">int</span> callingUid, <span class="keyword">long</span> startSeq)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// zygoteå¯åŠ¨è¿›ç¨‹è¿”å›ç»“æœåï¼Œpidä¼šè¢«ä¿å­˜åˆ°mPidsSelfLockedä¸­</span></span><br><span class="line">    <span class="comment">// è§ ProcessList.startProcessLocked æ–¹æ³•ä¸­æ‰§è¡Œçš„</span></span><br><span class="line">    <span class="comment">// ProcessList.handleProcessStartedLockedï¼Œå¯åŠ¨è¿›ç¨‹åæ›´æ–°çŠ¶æ€</span></span><br><span class="line">    <span class="comment">// æœ‰æ¦‚ç‡å‘ç”Ÿå½“å‰æ–¹æ³•å…ˆäºhandleProcessStartedLockedæ‰§è¡Œï¼Œåˆ™app=null</span></span><br><span class="line">    ProcessRecord app = mPidsSelfLocked.get(pid);</span><br><span class="line">    <span class="comment">// è®¾ç½®appå‚æ•°</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// ipc å¯åŠ¨Application, æœ€ç»ˆåœ¨APPè¿›ç¨‹è°ƒç”¨ActivityThread.handleBindApplication()</span></span><br><span class="line">    thread.bindApplication(processName, appInfo, providers, ...);</span><br><span class="line">    <span class="comment">// å»å¯åŠ¨Activityã€‚æœ€ç»ˆè°ƒç”¨ActivityStackSupervisor.realStartActivityLocked()</span></span><br><span class="line">    didSomething = mAtmInternal.attachApplication(app.getWindowProcessController());</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ActivityThread-handleBindApplication"><a href="#ActivityThread-handleBindApplication" class="headerlink" title="ActivityThread.handleBindApplication()"></a><code>ActivityThread.handleBindApplication()</code></h3><p>è®¾ç½®APPæ•°æ®ï¼Œåˆ›å»ºApplicationå®ä¾‹ï¼Œè°ƒç”¨<code>Application.onCreate()</code>æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleBindApplication</span><span class="params">(AppBindData data)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è®¾ç½®APPåç§°</span></span><br><span class="line">    Process.setArgV0(data.processName);</span><br><span class="line">    android.ddm.DdmHandleAppName.setAppName(data.processName, UserHandle.myUserId());</span><br><span class="line">    VMRuntime.setProcessPackageName(data.appInfo.packageName);</span><br><span class="line">    <span class="comment">// è®¾ç½®åº”ç”¨ç¼“å­˜æ•°æ®ç›®å½•</span></span><br><span class="line">    VMRuntime.setProcessDataDirectory(data.appInfo.dataDir);</span><br><span class="line">    <span class="comment">// è®¾ç½®æ—¶åŒºå’Œæœ¬åœ°åŒ–</span></span><br><span class="line">    TimeZone.setDefault(<span class="keyword">null</span>);</span><br><span class="line">    LocaleList.setDefault(data.config.getLocales());</span><br><span class="line">    <span class="comment">// åˆ›å»ºåº”ç”¨åŒ…çš„æ•°æ®</span></span><br><span class="line">    data.info = getPackageInfoNoCheck(data.appInfo, data.compatInfo);</span><br><span class="line">    <span class="keyword">if</span> (agent != <span class="keyword">null</span>) &#123;</span><br><span class="line">        handleAttachAgent(agent, data.info);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®¾ç½®å±å¹•åˆ†è¾¨ç‡(ç”¨äºå…¼å®¹)ã€æ—¶é—´æ ¼å¼ã€ç½‘ç»œä»£ç†</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// åˆ¤æ–­å¹¶è·å–æˆ–åˆ›å»º Instrumentationï¼Œä¹‹åä¼šç”¨æ¥åˆ›å»ºApplication</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// åˆ›å»ºApplicationã€é‡å†™èµ„æºç›¸å…³çš„Rå¸¸é‡</span></span><br><span class="line">    Application app = data.info.makeApplication(data.restrictedBackupMode, <span class="keyword">null</span>);</span><br><span class="line">	mInstrumentation.onCreate(data.instrumentationArgs);</span><br><span class="line">	<span class="comment">// æ‰§è¡ŒApplication.onCreateå›è°ƒ</span></span><br><span class="line">	mInstrumentation.callApplicationOnCreate(app);</span><br><span class="line">	<span class="comment">// åŠ è½½å­—ä½“èµ„æº</span></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="ç›¸å…³ç±»"><a href="#ç›¸å…³ç±»" class="headerlink" title="ç›¸å…³ç±»"></a>ç›¸å…³ç±»</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core</span><br><span class="line">    com.android.server.wm.ActivityTaskManagerService </span><br><span class="line">    com.android.server.wm.ActivityStarter</span><br><span class="line">    com.android.server.wm.RootActivityContainer</span><br><span class="line">    com.android.server.wm.ActivityStack</span><br><span class="line">    com.android.server.wm.ActivityStackSupervisor</span><br><span class="line">    com.android.server.wm.ClientLifecycleManager</span><br><span class="line">    com.android.server.am.ActivityManagerService</span><br><span class="line">    com.android.server.am.ActivityManagerService.LocalService</span><br><span class="line">    com.android.server.am.ProcessList</span><br><span class="line">frameworks/base/core</span><br><span class="line">    android.app.Activity</span><br><span class="line">    android.app.Instrumentation</span><br><span class="line">    android.app.ActivityThread</span><br><span class="line">    android.app.ActivityThread.ApplicationThread</span><br><span class="line">    android.app.servertransaction.LaunchActivityItem</span><br><span class="line">    android.app.servertransaction.TransactionExecutor</span><br><span class="line">    android.app.servertransaction.ClientTransaction</span><br><span class="line">    android.os.Process</span><br><span class="line">    android.os.ZygoteProcess</span><br><span class="line">    android.app.LoadedApk</span><br><span class="line">    android.app.AppComponentFactory</span><br><span class="line">    android.app.Application</span><br></pre></td></tr></table></figure>

<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul>
<li><a target="_blank" rel="noopener" href="http://aospxref.com/android-10.0.0_r47/">Android 10 æºç </a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhangliangnbu.github.io/2021/12/15/android-aosp-compile-flashing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="ç« äº®">
      <meta itemprop="description" content="Developer For Android">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ°¸æ’çš„ç æµ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/15/android-aosp-compile-flashing/" class="post-title-link" itemprop="url">Android10ç³»ç»Ÿç¼–è¯‘å’Œçƒ§å½•</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-12-15 15:10:20" itemprop="dateCreated datePublished" datetime="2021-12-15T15:10:20+08:00">2021-12-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-12-17 15:51:08" itemprop="dateModified" datetime="2021-12-17T15:51:08+08:00">2021-12-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">Androidç³»ç»Ÿå¼€å‘</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h1><p>åŸºäºUbuntu 20.04ç¼–è¯‘AOSPé‡Œçš„Android 10ç³»ç»Ÿï¼Œå¹¶çƒ§å½•è¿›Pixel 2å®æœºè®¾å¤‡é‡Œã€‚</p>
<blockquote>
<p>çƒ§å½•æŒ‡å°†ç¼–è¯‘åçš„ç³»ç»Ÿæ–‡ä»¶åˆ·å…¥å®æœºæˆ–æ¨¡æ‹Ÿå™¨ä¸­</p>
</blockquote>
<p>ä¹Ÿé€‚ç”¨Ubuntu18.4ï¼Œä¸ä¸€è‡´çš„åœ°æ–¹ä¼šåšè¯´æ˜ï¼Œä¸»è¦æ˜¯pythonç‰ˆæœ¬æœ‰å·®å¼‚ã€‚</p>
<p>åº”è¯¥è¯´<a target="_blank" rel="noopener" href="https://developer.android.google.cn/">AOSPå®˜ç½‘</a>å¯¹æ•´ä¸ªæµç¨‹éƒ½æœ‰æè¿°ï¼Œä½†æœ‰äº›åœ°æ–¹å¯èƒ½è¯´å¾—ä¸å¤Ÿæ¸…æ¥šæ˜ç™½ï¼Œä¸ºé¿å…ä¸å¸¸ç¼–è¯‘ç³»ç»Ÿçš„å¼€å‘è€…å°‘èµ°å¼¯è·¯ï¼Œæ•…æœ‰æ­¤æ€»ç»“ã€‚å¦å¤–éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œä¼˜å…ˆçœ‹å®˜ç½‘æ–‡æ¡£ï¼Œå®˜ç½‘æœ‰ä¸æ¸…æ¥šåœ°æ–¹å†çœ‹å…¶ä»–èµ„æ–™æ¯”å¦‚æœ¬æ–‡ã€‚</p>
<p>AOSPå®˜ç½‘æœ‰ä¸¤ä¸ªï¼Œå›½é™…ç‰ˆæœ¬å’Œå›½å†…ç‰ˆæœ¬ï¼Œå†…å®¹ä¸€è‡´ï¼Œä½†å›½å†…ç‰ˆæœ¬é€Ÿåº¦è¾ƒå¿«äº›ã€‚</p>
<ul>
<li>å›½é™…ç‰ˆæœ¬ï¼š<a target="_blank" rel="noopener" href="https://source.android.com/">https://source.android.com</a></li>
<li>å›½å†…ç‰ˆæœ¬ï¼š<a target="_blank" rel="noopener" href="https://source.android.google.cn/">https://source.android.google.cn</a></li>
</ul>
<h1 id="æ­å»ºç¼–è¯‘ç¯å¢ƒ"><a href="#æ­å»ºç¼–è¯‘ç¯å¢ƒ" class="headerlink" title="æ­å»ºç¼–è¯‘ç¯å¢ƒ"></a>æ­å»ºç¼–è¯‘ç¯å¢ƒ</h1><p><strong>ç¡¬ä»¶ç¯å¢ƒè¯´æ˜</strong></p>
<p><a target="_blank" rel="noopener" href="https://source.android.google.cn/setup/build/requirements">å®˜ç½‘æ„å»ºç¯å¢ƒç« èŠ‚</a>ä¸Šè¯´äº†ç¼–è¯‘Android 10å¿…é¡»ä¿è¯æœºå™¨çš„å†…å­˜åœ¨16Gä»¥ä¸Šï¼Œå®è·µè¿‡ç¨‹ä¸­å‘ç°ä½äº16Gå†…å­˜ä¼šæŠ¥å„ç§é”™è¯¯ã€‚ç½‘ä¸Šæœ‰ä¸€äº›æ–¹æ³•å¯ä»¥åœ¨ä½äº16Gå†…å­˜çš„æœºå™¨ä¸Šé€šè¿‡ç¼–è¯‘ï¼Œå°è¯•äº†å…¶ä¸­çš„ä¸€äº›ï¼Œä¾æ—§ä¸èƒ½å®Œæˆç¼–è¯‘ï¼Œæ•…æœ€å¥½ä¿è¯æœºå™¨å†…å­˜åœ¨16Gä»¥ä¸Šï¼Œå†…å­˜è¶Šå¤§ç¼–è¯‘é€Ÿåº¦è¶Šå¿«ï¼Œè¡€çš„æ•™è®­ï¼Œæ³¨æ„ã€‚</p>
<p><strong>å¼€å‘å¹³å°ç‰ˆæœ¬è¯´æ˜</strong></p>
<ul>
<li>Ubuntu 20.04</li>
<li>Python 3.6+</li>
<li>Android 10 ç³»ç»Ÿä¿¡æ¯ï¼šQP1A.190711.019ï¼Œandroid-10.0.0_r1    Android10ï¼ŒPixel 3a XL, Pixel 3a, Pixel 3 XL, Pixel 3, Pixel 2 XL, Pixel 2, Pixel XL, Pixel    2019-09-05</li>
<li>å…¶ä»–</li>
</ul>
<aside> ğŸ’¡ Ubuntu 20.4 need Python 3.6+, Ubuntu 18.4 need Python 2.7+

<p><strong>è®¾ç½®è½¯ä»¶ç¯å¢ƒ</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install git-core gnupg flex bison build-essential zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 libncurses5-dev lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig</span><br></pre></td></tr></table></figure>

<p><strong>é…ç½®Git</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.email <span class="string">&quot;you@example.com&quot;</span></span><br><span class="line">git config --global user.name <span class="string">&quot;Your Name&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>æ£€æŸ¥Python</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">python --version</span><br><span class="line"><span class="comment"># if no python, then set a link</span></span><br><span class="line"><span class="comment"># use &#x27;whereis python&#x27; to find where python locate.</span></span><br><span class="line">sudo ln -s /usr/bin/python3 /usr/bin/python</span><br></pre></td></tr></table></figure>

<p><strong>å®‰è£…Repoå·¥å…·</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/bin</span><br><span class="line">PATH=~/bin:<span class="variable">$PATH</span></span><br><span class="line">curl https://storage.googleapis.com/git-repo-downloads/repo &gt; ~/bin/repo</span><br><span class="line">chmod a+x ~/bin/repo</span><br></pre></td></tr></table></figure>

<p><strong>å°†REPO_URLæ”¹æ¸…åçš„æº</strong></p>
<p>æˆ‘ä½¿ç”¨çš„æ˜¯æ¸…åæºï¼Œä½¿ç”¨å…¶ä»–æºä¹Ÿå¯ä»¥</p>
<p>æ–¹æ³•ä¸€ï¼šé…ç½®ç¯å¢ƒå˜é‡ï¼ˆæ¨èï¼‰</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi ~/.bashrc</span><br><span class="line"><span class="comment"># export REPO_URL=&#x27;https://mirrors.tuna.tsinghua.edu.cn/git/git-repo/&#x27;</span></span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure>

<p>æ–¹æ³•äºŒï¼šç›´æ¥æ›´æ”¹repoæ–‡ä»¶é…ç½®</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‰¾åˆ°repo</span></span><br><span class="line">whereis repo</span><br><span class="line"><span class="comment"># æ›¿æ¢</span></span><br><span class="line">sudo vim /usr/bin/repo</span><br><span class="line"><span class="comment"># REPO_URL = &#x27;https://gerrit.googlesource.com/git-repo&#x27;</span></span><br><span class="line"><span class="comment"># æ”¹ä¸ºï¼š</span></span><br><span class="line"><span class="comment"># REPO_URL = &#x27;https://mirrors.tuna.tsinghua.edu.cn/git/git-repo/&#x27;</span></span><br></pre></td></tr></table></figure>

<h1 id="ä¸‹è½½ç³»ç»Ÿæºä»£ç "><a href="#ä¸‹è½½ç³»ç»Ÿæºä»£ç " class="headerlink" title="ä¸‹è½½ç³»ç»Ÿæºä»£ç "></a>ä¸‹è½½ç³»ç»Ÿæºä»£ç </h1><p>Android 10æºä»£ç ä¹Ÿæœ‰å¾ˆå¤šå°çš„ç‰ˆæœ¬ï¼Œæˆ‘ä»¬è¿™é‡Œåªä¸‹è½½æœ€åˆçš„ç‰ˆæœ¬<code>android-10.0.0_r1</code>ï¼Œå®˜ç½‘å¯æŸ¥çœ‹ç‰ˆæœ¬ï¼Œè§<a target="_blank" rel="noopener" href="https://source.android.google.cn/setup/start/build-numbers">ä»£å·ã€æ ‡è®°å’Œ Build å·</a>ï¼Œå…¶ä¸­æˆ‘ä»¬éœ€è¦çš„æ˜¯æ ‡è®°ï¼ˆTagsï¼‰ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mkdir aosp10</span><br><span class="line"><span class="built_in">cd</span> aosp10</span><br><span class="line"><span class="comment"># æ³¨æ„è¿™é‡Œçš„è¿æ¥è¦æ”¹ä¸ºæ¸…åé•œåƒçš„ -båé¢ä¸ºåˆ†æ”¯ç‰ˆæœ¬ï¼Œå¦‚å¯æ”¹ä¸º android-10.0.0_r47 </span></span><br><span class="line"><span class="comment"># repo init -u https://android.googlesource.com/platform/manifest</span></span><br><span class="line"><span class="comment"># repo init -u https://mirrors.tuna.tsinghua.edu.cn/git/AOSP/platform/manifest -b android-9.0.0_r1 --depth=1</span></span><br><span class="line">repo init -u https://mirrors.tuna.tsinghua.edu.cn/git/AOSP/platform/manifest -b android-10.0.0_r1 --depth=1</span><br><span class="line"><span class="comment"># å¼€å§‹ä¸‹è½½ jåé¢çš„æ•°å­—æ˜¯çº¿ç¨‹æ•°ï¼Œæ¨èå†™4</span></span><br><span class="line">repo sync -c -j4</span><br></pre></td></tr></table></figure>

<aside> ğŸ’¡ å¦å¤–ä¸€ç§ä¸‹è½½æºç çš„æ–¹æ³•æ˜¯ å…ˆç”¨wgetå‘½ä»¤ä¸‹è½½ï¼Œç„¶åè§£å‹ã€åŒæ­¥ã€‚

<h1 id="ç¼–è¯‘æºä»£ç "><a href="#ç¼–è¯‘æºä»£ç " class="headerlink" title="ç¼–è¯‘æºä»£ç "></a>ç¼–è¯‘æºä»£ç </h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">source</span> build/envsetup.sh</span><br><span class="line">$ lunch aosp_walleye-userdebug</span><br><span class="line">$ m</span><br><span class="line">...ç­‰å¾…ç¼–è¯‘å®Œæˆï¼Œæ²¡æœ‰æŠ¥errorå°±è¡¨ç¤ºç¼–è¯‘é€šè¿‡</span><br><span class="line">...ä¸€èˆ¬éœ€è¦å‡ ä¸ªå°æ—¶åˆ°åå‡ ä¸ªå°æ—¶ä¸ç­‰ï¼Œæˆ‘ä½¿ç”¨32Gå†…å­˜æ—¶ï¼Œå¤§çº¦éœ€è¦3~4ä¸ªå°æ—¶</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼Œ<code>lunch</code>åçš„å‚æ•°<code>aosp_walleye-userdebug</code>ä¸ºPixel 2æ‰‹æœºçš„è®¾å¤‡Buildç¼–å·ï¼Œå› ä¸ºæˆ‘åé¢ä¼šå°†ç¼–è¯‘åçš„ç³»ç»Ÿåˆ·å…¥è°·æ­Œpixel 2æ‰‹æœºä¸­ï¼Œæ•…é€‰æ‹©æ­¤Buildç¼–å·ã€‚</p>
<p>è®¾å¤‡Buildç¼–å·é€‰æ‹©è¯´æ˜è§å®˜ç½‘<a target="_blank" rel="noopener" href="https://source.android.google.cn/setup/build/running#selecting-device-build">è®¾å¤‡Buildç¼–å·</a>ã€‚</p>
<h1 id="å®æœºçƒ§å½•"><a href="#å®æœºçƒ§å½•" class="headerlink" title="å®æœºçƒ§å½•"></a>å®æœºçƒ§å½•</h1><p><strong>ä¸‹è½½å¹¶å®‰è£…ç¡¬ä»¶é©±åŠ¨æ–‡ä»¶</strong></p>
<p>ç¡¬ä»¶çƒ§å½•æ—¶éœ€è¦ï¼Œå¦‚æœä¸çƒ§å½•åˆ°ç¡¬ä»¶åˆ™ä¸éœ€è¦ä¸‹è½½ã€‚</p>
<p>æ ¹æ®ä»£å·<code>qp1a.190711.019</code>æŸ¥æ‰¾Googleå’Œé«˜é€šç›¸å…³é©±åŠ¨ï¼Œåœ°å€ï¼š<a target="_blank" rel="noopener" href="https://developers.google.cn/android/drivers#walleyeqp1a.190711.019">Pixel 2 binaries for Android 10.0.0 (QP1A.190711.019)</a></p>
<p>ä¸‹è½½å®Œåè§£å‹æ”¾åœ¨aospæºç æ ¹ç›®å½•ï¼Œå¹¶å®‰è£…ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sh extract-google_devices-walleye.sh</span><br><span class="line">sh extract-qcom-walleye.sh</span><br><span class="line"><span class="comment"># çœ‹å®Œlicenseè¾“å…¥ I ACCEPT å®‰è£…å®Œæˆ, æ­¤æ—¶lsä¼šçœ‹åˆ°vendoræ–‡ä»¶å¤¹</span></span><br></pre></td></tr></table></figure>

<p><strong>å®‰è£…åˆ·æœºå·¥å…·</strong></p>
<p>å®‰è£…å’Œé…ç½®ADBã€FASTBOOTå·¥å…·ã€‚</p>
<p>å®‰è£…ï¼šæœ‰ä¸¤ç§æ–¹æ³•å®‰è£…å·¥å…·ï¼Œä»SDKé…ç½®æˆ–ç›´æ¥å‘½ä»¤è¡Œå®‰è£…ä¸‹è½½</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install android-tools-adb</span><br><span class="line">$ sudo apt-get install android-tools-fastboot</span><br></pre></td></tr></table></figure>

<p>é…ç½®ï¼šå¯¹äºUbuntuç³»ç»Ÿéœ€è¦è¿›è¡Œä¸¤é¡¹é…ç½®ï¼Œä¸€æ˜¯æ·»åŠ å½“å‰ç”¨æˆ·åˆ° plugdev ç»„ä¸­ï¼ŒäºŒæ˜¯é…ç½®udev è§„åˆ™ï¼Œè¯¦æƒ…è¯·è§<a target="_blank" rel="noopener" href="https://developer.android.com/studio/run/device">å®˜ç½‘-åœ¨ç¡¬ä»¶è®¾å¤‡ä¸Šè¿è¡Œåº”ç”¨</a></p>
<aside> ğŸ’¡ æ³¨æ„ä½¿ç”¨æ•°æ®çº¿æ—¶ï¼Œéœ€è¦æœ‰é€šä¿¡èƒ½åŠ›çš„ï¼Œæœ‰çš„usbæ•°æ®çº¿ä»…ä»…åªæœ‰å……ç”µåŠŸèƒ½ï¼Œæœ¬äººäº²èº«ç»å†è¿‡ï¼

<p><strong>åˆ·æœº</strong></p>
<p>å‰ææ˜¯æ‰‹æœºå·²ç»è§£é”ï¼Œæˆ‘ä½¿ç”¨çš„Pixel 2æ‰‹æœºå·²ç»è§£é”ï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œçƒ§å½•ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨lunchç¯å¢ƒé‡Œ</span></span><br><span class="line">$ <span class="built_in">source</span> build/envsetup.sh</span><br><span class="line">$ lunch aosp_walleye-userdebug</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›å…¥BootLoader</span></span><br><span class="line">$ adb reboot bootloader</span><br><span class="line"></span><br><span class="line"><span class="comment"># çƒ§å½•</span></span><br><span class="line">$ fastboot flashall -w</span><br></pre></td></tr></table></figure>

<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul>
<li><a target="_blank" rel="noopener" href="https://source.android.google.cn/setup/start?hl=zh-cn">å®˜ç½‘-AOSPç¼–è¯‘</a>ï¼šèµ·å§‹é¡µ</li>
<li><a target="_blank" rel="noopener" href="https://source.android.google.cn/setup/start/build-numbers">å®˜ç½‘-ä»£å·ã€æ ‡è®°å’Œ Build å·</a>ï¼šæ ¹æ®æ ‡è®°ä¸‹è½½æºç ç‰ˆæœ¬ï¼Œæ ¹æ®ä»£å·ä¸‹è½½å®æœºè®¾å¤‡é©±åŠ¨ã€‚</li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/studio/run/device">å®˜ç½‘-åœ¨ç¡¬ä»¶è®¾å¤‡ä¸Šè¿è¡Œåº”ç”¨</a>ï¼šè®¾ç½®Linuxç³»ç»Ÿä»¥æ£€æµ‹USBè®¾å¤‡</li>
<li><a target="_blank" rel="noopener" href="https://source.android.com/setup/build/running?hl=zh-cn#flashing-a-device">å®˜ç½‘-åˆ·å†™è®¾å¤‡</a></li>
<li><a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/help/AOSP/">æ¸…åæº-Android é•œåƒä½¿ç”¨å¸®åŠ©</a>ï¼šæ¸…åæºä¸‹è½½AOSPä»£ç </li>
<li><a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/help/git-repo/">æ¸…åæº-Git Repo é•œåƒä½¿ç”¨å¸®åŠ©</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/ciml/p/13714036.html">ä¸‰æ–¹åšå®¢-ç¼–è¯‘AOSPå¹¶åˆ·å…¥Pixelè®¾å¤‡</a>ï¼šå‚è€ƒçƒ§å½•ç« èŠ‚</li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904104368537613">ä¸‰æ–¹åšå®¢-Android 9.0ç¼–è¯‘</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/mvp_Dawn/article/details/107624203">ä¸‰æ–¹åšå®¢-ubuntu20.4ç¼–è¯‘AOSPå®‰å“æºç ï¼ˆAndroidP android-9.0.0_r9ï¼‰</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.hanschen.site/2019/09/12/aosp_compile_and_flash/">ä¸‰æ–¹åšå®¢-AOSP ç¼–è¯‘å’Œçƒ§å†™ï¼ˆå®æœºçƒ§å½•ï¼‰</a></li>
<li><a target="_blank" rel="noopener" href="https://debugtalk.com/post/android-development-environment-adb-and-fastboot/">ä¸‰æ–¹åšå®¢-Androidå¼€å‘ç¯å¢ƒé…ç½®0ï¼šadbå’Œfastboot</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhangliangnbu.github.io/2021/12/09/android-jni-guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="ç« äº®">
      <meta itemprop="description" content="Developer For Android">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ°¸æ’çš„ç æµ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/09/android-jni-guide/" class="post-title-link" itemprop="url">JNIå¼€å‘æ¦‚è§ˆ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-12-09 17:14:28" itemprop="dateCreated datePublished" datetime="2021-12-09T17:14:28+08:00">2021-12-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-12-17 12:13:59" itemprop="dateModified" datetime="2021-12-17T12:13:59+08:00">2021-12-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">Androidå¼€å‘</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h1><p>JNIï¼Œå³Javaæœ¬åœ°æ¥å£ï¼ˆJava Native Interfaceï¼‰ï¼Œå…è®¸Javaä»£ç ä¸C/C++ç­‰æœ¬åœ°è¯­è¨€ç¼–å†™çš„ä»£ç è¿›è¡Œäº¤äº’æ“ä½œã€‚</p>
<p>JNIæä¾›çš„æ¥å£å£°æ˜ä½äºï¼š<code>&lt;JDK_HOME&gt;/include/jni.h</code>ä¸­</p>
<blockquote>
<p>æ³¨æ„ï¼šJNIæ˜¯Javaçš„ç‰¹æ€§è€ŒéAndroidç‹¬æœ‰ç‰¹æ€§ï¼Œåªå› ä¸ºAndroidä½¿ç”¨äº†Javaè¯­è¨€ï¼Œå› æ­¤å¯ä»¥åˆ©ç”¨JNIçš„åŠŸèƒ½ã€‚</p>
</blockquote>
<h2 id="åŸºæœ¬åŸç†"><a href="#åŸºæœ¬åŸç†" class="headerlink" title="åŸºæœ¬åŸç†"></a>åŸºæœ¬åŸç†</h2><p><strong>Javaè™šæ‹Ÿæœº</strong>åˆ©ç”¨<strong>å‡½æ•°åŸå‹</strong>å°†Javaå£°æ˜çš„æœ¬åœ°æ–¹æ³•ä¸è¿è¡Œåº“ä¸­çš„Cå‡½æ•°é€šè¿‡å‡½æ•°æ˜ å°„è¡¨å¯¹åº”èµ·æ¥ï¼Œè¿™æ ·Javaä»£ç å°±èƒ½ä¸C/C++ä»£ç äº¤äº’ã€‚</p>
<blockquote>
<p><strong>å‡½æ•°åŸå‹</strong>ï¼ˆè‹±è¯­ï¼š<strong>Function prototype</strong>ï¼‰æˆ–<strong>å‡½æ•°æ¥å£</strong>ï¼ˆè‹±è¯­ï¼š<strong>Function interface</strong>ï¼‰æ˜¯ç”¨äºæŒ‡å®šå‡½æ•°çš„åç§°å’Œ<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%B1%BB%E5%9E%8B%E7%AD%BE%E5%90%8D">ç±»å‹ç­¾å</a>ï¼ˆ<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%85%83%E6%95%B0">å…ƒæ•°</a>ï¼Œå‚æ•°çš„<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%B3%87%E6%96%99%E9%A1%9E%E5%9E%8B">æ•°æ®ç±»å‹</a>å’Œè¿”å›å€¼ç±»å‹ï¼‰çš„ä¸€ç§çœç•¥äº†å‡½æ•°ä½“çš„<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%AD%90%E7%A8%8B%E5%BA%8F">å‡½æ•°</a><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/w/index.php?title=%E5%A3%B0%E6%98%8E&action=edit&redlink=1">å£°æ˜</a>ã€‚</p>
</blockquote>
<blockquote>
<p>æ€è€ƒä¸€ï¼šJavaè™šæ‹Ÿæœºä½œä¸ºæ¡¥æ¢ã€‚Javaä»£ç å’ŒC/C++æœ¬åœ°ä»£ç è¿è¡Œç¯å¢ƒä¸ä¸€æ ·ï¼Œå› æ­¤ä¸èƒ½ç›´æ¥äº¤äº’ï¼Œè€ŒJavaä»£ç çš„å®¹å™¨Javaè™šæ‹Ÿæœºæ˜¯C/C++ä»£ç ç¼–å†™çš„ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨Javaè™šæ‹Ÿæœºä½œä¸ºæ¡¥æ¢å°†Javaä»£ç å’ŒC/C++æœ¬åœ°ä»£ç è”ç³»èµ·æ¥ã€‚</p>
<p>æ€è€ƒäºŒï¼šä¸ºä»€ä¹ˆç”¨å‡½æ•°åŸå‹ï¼ŸJavaæ–¹æ³•å’ŒC/C++å‡½æ•°æ˜¯ä¸ä¸€æ ·çš„ï¼Œä½†å®ƒä»¬å¯ä»¥åœ¨å‡½æ•°åŸå‹ä¸Šå˜ä¸ºä¸€è‡´ï¼Œéƒ½æœ‰åç§°å’Œç­¾åï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨å‡½æ•°åŸå‹å»ºç«‹æ˜ å°„å…³ç³»ã€‚</p>
</blockquote>
<h2 id="Javaä»£ç ä¸JNIæœ¬åœ°å‡½æ•°çš„äº¤äº’"><a href="#Javaä»£ç ä¸JNIæœ¬åœ°å‡½æ•°çš„äº¤äº’" class="headerlink" title="Javaä»£ç ä¸JNIæœ¬åœ°å‡½æ•°çš„äº¤äº’"></a>Javaä»£ç ä¸JNIæœ¬åœ°å‡½æ•°çš„äº¤äº’</h2><p>ä½¿ç”¨JNIä¸€èˆ¬éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ol>
<li>å£°æ˜æœ¬åœ°æ–¹æ³•ã€‚åœ¨Javaç±»ä¸­ä½¿ç”¨<code>native</code>å…³é”®å­—å£°æ˜æœ¬åœ°æ–¹æ³•å¹¶åŠ è½½æœ¬åœ°å‡½æ•°åº“ã€‚</li>
<li>å»ºç«‹æ˜ å°„å…³ç³»ã€‚ä½¿ç”¨<code>javah</code>å‘½ä»¤ï¼Œç”ŸæˆåŒ…å«JNIæœ¬åœ°å‡½æ•°åŸå‹çš„å¤´æ–‡ä»¶ï¼Œå»ºç«‹Javaæ–¹æ³•ä¸C/C++æœ¬åœ°å‡½æ•°é—´çš„æ˜ å°„ã€‚å¦å¤–ï¼Œåœ¨C/C++æœ¬åœ°å‡½æ•°é‡Œä½¿ç”¨<code>RegisterNatives()</code>ä¹Ÿå¯ç›´æ¥åˆ›å»ºæ˜ å°„å…³ç³»ï¼Œä¸”é€Ÿåº¦è¾ƒå¿«ã€‚</li>
<li>å®ç°C/C++æœ¬åœ°å‡½æ•°ã€‚æ ¹æ®ä¸Šé¢æä¾›çš„å¤´æ–‡ä»¶å®ç°æœ¬åœ°å‡½æ•°ã€‚</li>
<li>ç¼–è¯‘æœ¬åœ°å‡½æ•°ï¼Œç”ŸæˆC/C++å…±äº«åº“</li>
<li>Javaä»£ç é€šè¿‡JNIè°ƒç”¨æœ¬åœ°å‡½æ•°ã€‚æœ¬åœ°å‡½æ•°å¯ä»¥ä½¿ç”¨è™šæ‹Ÿæœºä¼ é€’è¿‡æ¥çš„<code>JNIEnv *</code>æŒ‡é’ˆè°ƒç”¨JNIå‡½æ•°ï¼Œè¿›è€Œè°ƒç”¨Javaä»£ç ã€‚</li>
</ol>
<p><strong>ä¸éµå¾ªä»¥ä¸Šæ­¥éª¤çš„åœºæ™¯</strong>ï¼šå¦‚æœä»…ä»…åªæ˜¯ç¼–å†™C/C++åº”ç”¨ï¼Œç„¶åå¤ç”¨Javaæä¾›çš„åº“æ¥å®ç°æŸäº›åŠŸèƒ½ï¼Œä¸æ¶‰åŠç¼–å†™Javaç±»è°ƒç”¨C/C++å‡½æ•°çš„ä»£ç ï¼Œåˆ™ä¸éœ€è¦éµå¾ªä¸Šé¢çš„æ­¥éª¤ï¼Œè€Œæ˜¯ç›´æ¥åœ¨Cå‡½æ•°é‡Œåˆ›å»ºè™šæ‹Ÿæœºå¹¶è·å–å¯¹åº”çš„<code>JNIEnv *</code>æŒ‡é’ˆï¼Œç„¶åé€šè¿‡JNIå‡½æ•°è°ƒç”¨Javaä»£ç å³å¯ã€‚</p>
<p><img src="/images/aosp10-jni-guide.drawio.svg" alt="aosp10-jni-guide.drawio"></p>
<blockquote>
<p>æ€è€ƒï¼šèƒ½å¦åŸºäºJNIå¼€å‘ä¸»è¦ä½¿ç”¨C/C++ç¼–å†™çš„æœ¬åœ°åº”ç”¨ç¨‹åºï¼Ÿä¸å¦¥ï¼ŒJNIå‡½æ•°è°ƒç”¨çš„å¼€é”€åº”è¯¥æ¯”è¾ƒå¤§ï¼Œå½±å“æ€§èƒ½ã€‚</p>
</blockquote>
<h1 id="JNIä½¿ç”¨ç¤ºä¾‹"><a href="#JNIä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="JNIä½¿ç”¨ç¤ºä¾‹"></a>JNIä½¿ç”¨ç¤ºä¾‹</h1><h2 id="Javaä»£ç è°ƒç”¨C-C-æœ¬åœ°å‡½æ•°"><a href="#Javaä»£ç è°ƒç”¨C-C-æœ¬åœ°å‡½æ•°" class="headerlink" title="Javaä»£ç è°ƒç”¨C/C++æœ¬åœ°å‡½æ•°"></a>Javaä»£ç è°ƒç”¨C/C++æœ¬åœ°å‡½æ•°</h2><ol>
<li><p>åœ¨Javaç±»ä¸­å£°æ˜æœ¬åœ°æ–¹æ³•å¹¶åŠ è½½æœ¬åœ°å‡½æ•°åº“</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HelloJNI.java</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloJNI</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">native</span> <span class="keyword">void</span> <span class="title">printString</span><span class="params">(String str)</span></span>; <span class="comment">// å£°æ˜æœ¬åœ°æ–¹æ³•</span></span><br><span class="line">	<span class="keyword">static</span> &#123; System.loadLibrary(<span class="string">&quot;hellojni&quot;</span>); &#125; <span class="comment">// åŠ è½½æœ¬åœ°å‡½æ•°åº“</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">		HelloJNI myJNI = <span class="keyword">new</span> HelloJNI();</span><br><span class="line">		myJNI.printString(<span class="string">&quot;Hello World from native&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>ä½¿ç”¨<code>javah</code>å‘½ä»¤ï¼Œç”ŸæˆåŒ…å«JNIæœ¬åœ°å‡½æ•°åŸå‹çš„å¤´æ–‡ä»¶ï¼Œå»ºç«‹Javaæ–¹æ³•ä¸C/C++æœ¬åœ°å‡½æ•°é—´çš„æ˜ å°„</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ javac HelloJNI.java</span><br><span class="line">$ javah HelloJNI</span><br><span class="line">$ ls</span><br><span class="line">HelloJNI.class  HelloJNI.h  HelloJNI.java</span><br><span class="line">$ cat HelloJNI.h</span><br><span class="line">...</span><br><span class="line">/*</span><br><span class="line"> * Class:     HelloJNI <span class="comment"># å¯¹åº”çš„Javaç±»å</span></span><br><span class="line"> * Method:    printString <span class="comment"># æ–¹æ³•å</span></span><br><span class="line"> * Signature: (Ljava/lang/String;)V  <span class="comment"># æ–¹æ³•ç­¾åï¼Œæ‹¬å·å†…ä¸ºå…¥å‚ï¼Œæ‹¬å·å¤–ä¸ºè¿”å›å€¼</span></span><br><span class="line"> */</span><br><span class="line">JNIEXPORT void JNICALL Java_HelloJNI_printString</span><br><span class="line">  (JNIEnv *, jobject, jstring); <span class="comment"># æœ¬åœ°å‡½æ•°åŸå‹</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><code>HelloJNI.h</code>å¤´æ–‡ä»¶ä¸­åŒ…å«åŸºäºJavaæ–¹æ³•ç”Ÿæˆçš„æœ¬åœ°å‡½æ•°åŸå‹ä»¥åŠæ³¨é‡Šï¼Œæœ¬åœ°å‡½æ•°åŸå‹è¯´æ˜å¦‚ä¸‹ï¼š</p>
<ul>
<li>JNIEXPORTã€JNICALLï¼šå…³é”®å­—ï¼ŒJNIéœ€è¦æ­¤å…³é”®å­—æ‰èƒ½æ­£å¸¸è°ƒç”¨å‡½æ•°ã€‚</li>
<li>Java_HelloJNI_printStringï¼šæœ¬åœ°å‡½æ•°åï¼Œæ ¼å¼<code>Java_ç±»å_æ–¹æ³•å</code>ã€‚</li>
<li>JNIEnv *, jobjectï¼šé»˜è®¤å‚æ•°ï¼ŒJNIEnv *æŒ‡å‘JNIæä¾›çš„åŸºæœ¬å‡½æ•°é›†ï¼Œå¯ç”¨æ¥è°ƒç”¨ç›¸å…³å‡½æ•°ï¼›jobjectè¡¨ç¤ºè°ƒç”¨æœ¬åœ°æ–¹æ³•çš„Javaæœ¬åœ°å¯¹è±¡ï¼Œå¦‚æœè°ƒç”¨é™æ€æ–¹æ³•åˆ™ä¸ºjclassï¼Œè¡¨ç¤ºJavaæœ¬åœ°ç±»ã€‚</li>
</ul>
</li>
<li><p>å®ç°JNIæœ¬åœ°å‡½æ•°ï¼šç¼–å†™<code>hellojni.c</code>æ–‡ä»¶</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;HelloJNI.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title">Java_HelloJNI_printString</span><span class="params">(JNIEnv *env, jobject obj, jstring <span class="built_in">string</span>)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// jni.hæ–‡ä»¶é‡Œå£°æ˜äº†GetStringUTFChars()å‡½æ•°</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *str = (*env)-&gt;GetStringUTFChars(env, <span class="built_in">string</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, str);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>ç”ŸæˆCå…±äº«åº“ã€‚ä»¥Windowså¹³å°ä¸ºä¾‹ï¼Œç”Ÿæˆ<code>hellojni.dll</code>æ–‡ä»¶</p>
<p>åœ¨<code>Visual C++ 2015 x86 x64 Cross Build Tools Command Prompt</code>ç¼–è¯‘ä»£ç </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># C:\Program Files\Java\jdk1.8.0_251 ä¸ºJDK Homeç›®å½•</span></span><br><span class="line">$ cl -I<span class="string">&quot;C:\Program Files\Java\jdk1.8.0_251\include&quot;</span> -I<span class="string">&quot;C:\Program Files\Java\jdk1.8.0_251\include\win32&quot;</span> -LD hellojni.c -Fehellojni.dll</span><br></pre></td></tr></table></figure></li>
<li><p>Javaä»£ç é€šè¿‡JNIè°ƒç”¨æœ¬åœ°å‡½æ•°</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ java HelloJNI</span><br><span class="line">Hello World from native!</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="C-C-æœ¬åœ°å‡½æ•°è°ƒç”¨Javaä»£ç "><a href="#C-C-æœ¬åœ°å‡½æ•°è°ƒç”¨Javaä»£ç " class="headerlink" title="C/C++æœ¬åœ°å‡½æ•°è°ƒç”¨Javaä»£ç "></a>C/C++æœ¬åœ°å‡½æ•°è°ƒç”¨Javaä»£ç </h2><p>C/C++å‡½æ•°è°ƒç”¨Javaä»£ç çš„ç”¨æ³•æœ‰ï¼šè·å–Javaç±»çš„classï¼Œåˆ›å»ºJavaç±»çš„å¯¹è±¡å®ä¾‹ï¼Œè°ƒç”¨ç±»çš„é™æ€æˆå‘˜å˜é‡å’Œé™æ€æ–¹æ³•ï¼Œè°ƒç”¨å¯¹è±¡çš„æˆå‘˜å˜é‡å’Œæ–¹æ³•ã€‚ç›¸å…³JNIæ¥å£éƒ½å£°æ˜åœ¨<code>&lt;JDK_HOME&gt;/include/jni.h</code>ä¸­ã€‚</p>
<p>ç›¸å…³éƒ¨åˆ†æ¥å£(C++)ï¼Œé€šè¿‡<code>JNIEnv *</code>è°ƒç”¨å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æŸ¥è¯¢å¹¶åŠ è½½ç±»</span></span><br><span class="line"><span class="function">jclass <span class="title">FindClass</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span></span><br><span class="line"><span class="function"><span class="comment">// è·å–ç±»çš„é™æ€æ–¹æ³•</span></span></span><br><span class="line"><span class="function">jmethodID <span class="title">GetStaticMethodID</span><span class="params">(jclass clazz, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> <span class="keyword">char</span> *sig)</span></span></span><br><span class="line"><span class="function"><span class="comment">// è°ƒç”¨ç±»çš„é™æ€æ–¹æ³• XXXè¡¨ç¤ºObjectã€Booleanç­‰æ–¹æ³•è¿”å›å€¼ç±»å‹</span></span></span><br><span class="line"><span class="function">jXXX <span class="title">CallStaticXXXMethod</span><span class="params">(jclass clazz, jmethodID methodID, ...)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// æŸ¥æ‰¾æ–¹æ³•. æ„é€ æ–¹æ³•ï¼š name=&quot;&lt;init&gt;&quot;, sigä¸ºç­¾åå¦‚&quot;(I)V&quot;</span></span></span><br><span class="line"><span class="function">jmethodID <span class="title">GetMethodID</span><span class="params">(jclass clazz, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> <span class="keyword">char</span> *sig)</span></span></span><br><span class="line"><span class="function"><span class="comment">// åˆ›å»ºJavaå¯¹è±¡å®ä¾‹</span></span></span><br><span class="line"><span class="function">jobject <span class="title">NewObject</span><span class="params">(jclass clazz, jmethodID methodID, ...)</span></span></span><br><span class="line"><span class="function"><span class="comment">// è°ƒç”¨æ™®é€šå¯¹è±¡æ–¹æ³•</span></span></span><br><span class="line"><span class="function">jxxx <span class="title">CallXxxMethod</span><span class="params">(jobject obj, jmethodID methodID, ...)</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>ä¸Šè¿°æ¥å£ï¼Œåœ¨Cé‡Œéœ€è¦åœ¨å…¥å‚é‡Œæ·»åŠ env(JNIEnv *)ã€‚</p>
</blockquote>
<p><strong>Cå‡½æ•°ä¸»åŠ¨è°ƒç”¨Javaä»£ç æ³¨æ„äº‹é¡¹</strong></p>
<p>è°ƒç”¨JNIæ–¹æ³•çš„å‰ææ˜¯æŒæœ‰<code>JNIEnv *</code>æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆä¸€èˆ¬é€šè¿‡Javaè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¼ ç»™C/C++å‡½æ•°ã€‚ä½†å¦‚æœC/C++å‡½æ•°ä¸»åŠ¨è°ƒç”¨Javaçš„ä»£ç æ—¶æ²¡æœ‰æŒæœ‰è¯¥æŒ‡é’ˆï¼Œæˆ–è€…æ­¤æ—¶Javaè™šæ‹Ÿæœºæ²¡æœ‰å¯åŠ¨ï¼Œåˆ™C/C++å¦‚ä½•è°ƒç”¨Javaä»£ç å‘¢ï¼Ÿç­”æ¡ˆæ˜¯åœ¨Cå‡½æ•°é‡Œä¸»åŠ¨ç”Ÿæˆè™šæ‹Ÿæœºï¼Œè·å–ä¸è¯¥è™šæ‹Ÿæœºå¯¹åº”çš„<code>JNIEnv *</code>æŒ‡é’ˆï¼Œç„¶åå°±å¯ä»¥è°ƒç”¨Javaä»£ç äº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”Ÿæˆè™šæ‹Ÿæœºçš„æ¥å£</span></span><br><span class="line">JNI_CreateJavaVM(JavaVM **pvm, <span class="keyword">void</span> **penv, <span class="keyword">void</span> *args);</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼šé€šè¿‡ä¸»åŠ¨ç”Ÿæˆè™šæ‹Ÿæœºè·å–<code>JNIEnv *</code>æŒ‡é’ˆï¼Œç„¶åè°ƒç”¨Javaä»£ç æ—¶ï¼Œæ— éœ€åˆ›å»ºJavaæ–¹æ³•ä¸æœ¬åœ°C/C++å‡½æ•°é—´çš„æ˜ å°„è¡¨è¿™ä¸€æ­¥éª¤ã€‚</p>
<h1 id="ä½¿ç”¨Android-NDKå¼€å‘"><a href="#ä½¿ç”¨Android-NDKå¼€å‘" class="headerlink" title="ä½¿ç”¨Android NDKå¼€å‘"></a>ä½¿ç”¨Android NDKå¼€å‘</h1><p>åœ¨å¼€å‘Androidé‡Œçš„JNIç›¸å…³çš„åŠŸèƒ½ï¼Œå¯ä½¿ç”¨Android Studioé…å¥—çš„NDKå·¥å…·åŒ…ï¼Œä¸€é”®ç¼–è¯‘ï¼Œæ–¹ä¾¿å¿«é€Ÿå¼€å‘ã€‚</p>
<p>NDKä½¿ç”¨çš„å®˜æ–¹ä»‹ç»ï¼š<a target="_blank" rel="noopener" href="https://developer.android.google.cn/ndk">Android NDK</a></p>
<p>NDKä½¿ç”¨ç¤ºä¾‹è§å®˜æ–¹CodeLab: <a target="_blank" rel="noopener" href="https://developer.android.google.cn/codelabs/android-studio-cmake#0">Create Hello-CMake with Android Studio</a></p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul>
<li>é‡‘æ³°å»·ç­‰è‘—ã€ŠAndroidæ¡†æ¶è§£å¯†ã€‹ï¼Œäººæ°‘é‚®ç”µå‡ºç‰ˆç¤¾ï¼Œ2012ã€‚è¯¥ä¹¦åˆ†æçš„ä»£ç è¾ƒè€ï¼Œä½†æ¡†æ¶æœºåˆ¶åŸºæœ¬ä¸å˜ï¼Œéå¸¸å¥½çš„ä¹¦ç±ã€‚</li>
<li>æºç æŸ¥çœ‹ç½‘ç«™ï¼š<a target="_blank" rel="noopener" href="http://aospxref.com/%E3%80%82%E5%9F%BA%E4%BA%8EOpenGrok%E7%9A%84%E6%BA%90%E7%A0%81%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1%E7%BD%91%E7%AB%99%EF%BC%8C%E9%80%9F%E5%BA%A6%E5%BE%88%E5%BF%AB%EF%BC%8C%E4%B8%BB%E8%A6%81%E7%94%A8%E6%9D%A5%E6%9F%A5%E7%9C%8BC/C++%E4%BB%A3%E7%A0%81%EF%BC%8CJava%E4%BB%A3%E7%A0%81%E5%8F%AF%E4%B8%8B%E8%BD%BD%E5%88%B0%E6%9C%AC%E5%9C%B0%E6%9F%A5%E7%9C%8B%E3%80%82">http://aospxref.com/ã€‚åŸºäºOpenGrokçš„æºç æŸ¥çœ‹æœåŠ¡ç½‘ç«™ï¼Œé€Ÿåº¦å¾ˆå¿«ï¼Œä¸»è¦ç”¨æ¥æŸ¥çœ‹C/C++ä»£ç ï¼ŒJavaä»£ç å¯ä¸‹è½½åˆ°æœ¬åœ°æŸ¥çœ‹ã€‚</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.google.cn/codelabs/android-studio-cmake#0">Create Hello-CMake with Android Studio</a>:NDKå¼€å‘ç¤ºä¾‹</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhangliangnbu.github.io/2021/12/07/android-update-ui-in-sub-thread/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="ç« äº®">
      <meta itemprop="description" content="Developer For Android">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ°¸æ’çš„ç æµ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/07/android-update-ui-in-sub-thread/" class="post-title-link" itemprop="url">æ¢è®¨-å¦‚ä½•åœ¨å­çº¿ç¨‹ç›´æ¥åˆ·æ–°ä¸»çº¿ç¨‹çš„UI</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-12-07 15:18:11" itemprop="dateCreated datePublished" datetime="2021-12-07T15:18:11+08:00">2021-12-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-12-09 09:01:54" itemprop="dateModified" datetime="2021-12-09T09:01:54+08:00">2021-12-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">Androidå¼€å‘</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="é—®é¢˜åœºæ™¯"><a href="#é—®é¢˜åœºæ™¯" class="headerlink" title="é—®é¢˜åœºæ™¯"></a>é—®é¢˜åœºæ™¯</h1><p>ä¹‹å‰è¢«é—®åˆ°ä¸€ä¸ªé—®é¢˜ï¼šå¦‚ä½•åœ¨å­çº¿ç¨‹ä¸­ä¸é€šè¿‡Handlerè€Œç›´æ¥æ›´æ–°ä¸»çº¿ç¨‹çš„UIï¼Œæ¯”å¦‚åœ¨ä¸»çº¿ç¨‹åˆ›å»ºçš„TextViewï¼Œå¦‚ä½•åœ¨å­çº¿ç¨‹ç›´æ¥è°ƒç”¨<code>setText()</code>æ–¹æ³•æ›´æ–°æ–‡æœ¬ï¼Ÿå®ä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> TextView tv1;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        tv1 = findViewById(R.id.tv_hw);</span><br><span class="line">        tv1.setOnClickListener(v -&gt; <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            tv1.setText(<span class="string">&quot;å­çº¿ç¨‹åˆ·æ–°UI&quot;</span>);</span><br><span class="line">        &#125;).start());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç›´æ¥è¿è¡Œä¸Šè¿°ä»£ç ä¼šå¯¼è‡´ç¨‹åºå´©æºƒï¼Œè°ƒç”¨æ ˆå¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">E/AndroidRuntime: FATAL EXCEPTION: Thread-2</span><br><span class="line">    Process: com.xxx.viewsettextdemo, PID: 4387</span><br><span class="line">    android.view.ViewRootImpl<span class="variable">$CalledFromWrongThreadException</span>: Only the original thread that created a view hierarchy can touch its views.</span><br><span class="line">        at android.view.ViewRootImpl.checkThread(ViewRootImpl.java:8191)</span><br><span class="line">        at android.view.ViewRootImpl.requestLayout(ViewRootImpl.java:1420)</span><br><span class="line">        at android.view.View.requestLayout(View.java:24469)</span><br><span class="line">        at android.view.View.requestLayout(View.java:24469)</span><br><span class="line">        at android.view.View.requestLayout(View.java:24469)</span><br><span class="line">        at android.view.View.requestLayout(View.java:24469)</span><br><span class="line">        at android.view.View.requestLayout(View.java:24469)</span><br><span class="line">        at android.view.View.requestLayout(View.java:24469)</span><br><span class="line">        at androidx.constraintlayout.widget.ConstraintLayout.requestLayout(ConstraintLayout.java:3146)</span><br><span class="line">        at android.view.View.requestLayout(View.java:24469)</span><br><span class="line">        at android.widget.TextView.checkForRelayout(TextView.java:9681)</span><br><span class="line">        at android.widget.TextView.setText(TextView.java:6269)</span><br><span class="line">        at android.widget.TextView.setText(TextView.java:6097)</span><br><span class="line">        at android.widget.TextView.setText(TextView.java:6049)</span><br><span class="line">        at com.xxx.viewsettextdemo.MainActivity.lambda$onCreate$0<span class="variable">$MainActivity</span>(MainActivity.java:22)</span><br><span class="line">        at com.xxx.viewsettextdemo.-$$Lambda$MainActivity<span class="variable">$_uRJsNnQ0</span>-zyKYjBJhwoyKb6E_I.run(Unknown Source:2)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:919)</span><br></pre></td></tr></table></figure>

<p>æœ‰ä»€ä¹ˆæ–¹æ³•ï¼Œä¿è¯ç¨‹åºä¸å´©æºƒä¸”èƒ½å¤Ÿæ›´æ–°UIï¼Ÿ</p>
<h1 id="æ¢è®¨"><a href="#æ¢è®¨" class="headerlink" title="æ¢è®¨"></a>æ¢è®¨</h1><p>é—®é¢˜å‡ºç°åœ¨è°ƒç”¨<code>ViewRootImpl.checkThread()</code>æ–¹æ³•æ—¶ï¼ŒæŠ›å‡ºé”™è¯¯ï¼šâ€CalledFromWrongThreadException: Only the original thread that created a view hierarchy can touch its views.â€</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">checkThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mThread != Thread.currentThread()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CalledFromWrongThreadException(</span><br><span class="line">                <span class="string">&quot;Only the original thread that created a view hierarchy can touch its views.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¼‚å¸¸æ¶ˆæ¯æ˜¯è¯´ï¼Œåªæœ‰åˆ›å»ºViewæ‰€å±è§†å›¾æ ‘çš„çº¿ç¨‹æ‰èƒ½æ›´æ–°è¯¥Viewï¼Œåˆ¤æ–­ä¾æ®æ˜¯ViewRootImplçš„mThreadæˆå‘˜ä¸å½“å‰çº¿ç¨‹ä¸ä¸€è‡´ã€‚mThreadåªåœ¨ViewRootImplæ„é€ æ–¹æ³•é‡Œè¿›è¡Œèµ‹å€¼ï¼Œè€ŒViewRootImplæ˜¯åœ¨WindowManager(å®é™…ä¸ºWindowManagerGlobal)çš„addViewæ–¹æ³•é‡Œè¿›è¡Œå®ä¾‹åŒ–çš„ï¼Œä¸”ä¸èƒ½è¢«åº”ç”¨å¼€å‘è€…ç›´æ¥å®ä¾‹åŒ–ã€‚åœ¨ä¸æ›´æ”¹ç³»ç»Ÿä»£ç çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥è¿›è¡Œå¦‚ä¸‹å°è¯•ï¼š</p>
<h3 id="æ–¹æ¡ˆ-1"><a href="#æ–¹æ¡ˆ-1" class="headerlink" title="æ–¹æ¡ˆ 1"></a>æ–¹æ¡ˆ 1</h3><p>åœ¨ä¸»çº¿ç¨‹ä¸­ç§»é™¤ç›®æ ‡Viewï¼Œç„¶ååœ¨å­çº¿ç¨‹é€šè¿‡WindowManager.addView()æ·»åŠ è¯¥viewã€‚addView()ä¼šåˆ›å»ºæ–°çš„ViewRootImplå®ä¾‹ï¼Œå¹¶å°†ç›®æ ‡Viewæ·»åŠ æ–°çš„ViewRootImplå¯¹åº”çš„è§†å›¾æ ‘ä¸­ã€‚è¿™ç§æ–¹æ³•ä»…ä»…è§£å†³äº†åœ¨å­çº¿ç¨‹ä¸­æ›´æ–°ä¸»çº¿ç¨‹ä¸­åˆ›å»ºçš„Viewé—®é¢˜ï¼Œä½†åœ¨UIå±‚é¢åˆ™è¡¨ç°ä¸ºå­çº¿ç¨‹åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„çª—å£ï¼Œæ­¤æ—¶ç›®æ ‡Viewå·²ç»ç¦»å¼€äº†ä¸»çº¿ç¨‹åˆ›å»ºçš„çª—å£è€Œä½äºæ–°çª—å£ä¸­ï¼Œæ›´æ–°çš„ä¹Ÿä»…ä»…æ˜¯æ–°çª—å£ä¸­çš„UIï¼Œå¹¶ä¸èƒ½ç®—æ˜¯å­çº¿ç¨‹æ›´æ–°äº†ä¸»çº¿ç¨‹çš„UIï¼Œæ­¤æ—¶ä¸»çº¿ç¨‹UIä¼šç¼ºå¤±ç›®æ ‡Viewã€‚</p>
<p>å…·ä½“ä»£ç å¦‚ä¸‹ï¼Œåœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæ·»åŠ ä¸€ä¸ªæŒ‰é’®ï¼Œç‚¹å‡»æŒ‰é’®æ—¶è§¦å‘åˆ›å»ºå­çº¿ç¨‹æ“ä½œï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">btn.setOnClickListener(v -&gt; <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">    <span class="comment">// ä¸»çº¿ç¨‹ä¸­çš„Viewåªèƒ½åœ¨ä¸»çº¿ç¨‹ä¸­ç§»é™¤</span></span><br><span class="line">    MainActivity.<span class="keyword">this</span>.runOnUiThread(() -&gt; &#123;</span><br><span class="line">        ViewGroup parent = (ViewGroup) tv1.getParent();</span><br><span class="line">        parent.removeView(tv1);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// addView()æ—¶ä¼šè°ƒç”¨Handlerå‘æ¶ˆæ¯åˆ°è¯¥çº¿ç¨‹ï¼Œéœ€è¦Looper</span></span><br><span class="line">    Looper.prepare();</span><br><span class="line">    WindowManager wm = getWindowManager();</span><br><span class="line">    WindowManager.LayoutParams lp = <span class="keyword">new</span> WindowManager.LayoutParams(</span><br><span class="line">        WindowManager.LayoutParams.MATCH_PARENT,</span><br><span class="line">        WindowManager.LayoutParams.WRAP_CONTENT,</span><br><span class="line">        WindowManager.LayoutParams.TYPE_APPLICATION,</span><br><span class="line">        WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE</span><br><span class="line">        | WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL,</span><br><span class="line">        PixelFormat.TRANSLUCENT);</span><br><span class="line">    wm.addView(tv1, lp);</span><br><span class="line">    tv1.setTextColor(Color.BLACK);</span><br><span class="line">    tv1.setText(<span class="string">&quot;æˆ‘æ˜¯åœ¨å­çº¿ç¨‹ä¸­çš„çš„æ›´æ–°çš„UI&quot;</span>);</span><br><span class="line">    Looper.loop();</span><br><span class="line">&#125;).start());</span><br></pre></td></tr></table></figure>

<p>å…·ä½“æ•ˆæœå¦‚ä¸‹</p>
<p>è¿›å…¥åº”ç”¨ï¼Œä¾æ¬¡ä¸ºTextViewå’ŒButtonï¼š</p>
<p><img src="/images/android-update-ui-2.png"></p>
<p>ç‚¹å‡»â€œå­çº¿ç¨‹æ›´æ–°UIâ€çš„Buttonï¼ŒTextViewå‡ºç°åœ¨æ–°çš„çª—å£ä¸­ä¸”æ–‡æœ¬è¢«æ›´æ–°ï¼š</p>
<p><img src="/images/android-update-ui-1.png"></p>
<p>ä¸Šè¿°æ–¹æ¡ˆä¸ç›´æ¥åœ¨å­çº¿ç¨‹ä¸­åˆ›å»ºViewå®ä¾‹æ˜¯ä¸€æ ·çš„ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯åˆ›å»ºå®ä¾‹çš„åœ°æ–¹ä¸ä¸€æ ·ã€‚è¯¥æ–¹æ¡ˆä»…ä»…è§£å†³äº†å¦‚ä½•åœ¨å­çº¿ç¨‹ä¸­æ›´æ–°ä¸»çº¿ç¨‹åˆ›å»ºçš„Viewå®ä¾‹ä¿¡æ¯è¿™ä¸ªé—®é¢˜è€Œå·²ï¼Œå¹¶æ²¡æœ‰å®Œå…¨è§£å†³æ–‡ç« å¼€å§‹æåˆ°çš„é—®é¢˜ã€‚</p>
<p>ä¸ä¿®æ”¹ç³»ç»Ÿä»£ç ï¼Œè€Œä»…ä»…ä½¿ç”¨ç›®å‰çš„SDKæä¾›çš„APIï¼Œæˆ‘è®¤ä¸ºå¾ˆéš¾è§£å†³è¯¥é—®é¢˜ï¼Œå› ä¸ºæ— æ³•ç»•è¿‡<code>ViewRootImpl.checkThread()</code>æ–¹æ³•ï¼Œä¹Ÿè®¸æœ‰å…¶ä»–çš„Trickï¼Œå¾…ä»¥åè·Ÿè¿›ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhangliangnbu.github.io/2021/12/03/android-java-service-practice-guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="ç« äº®">
      <meta itemprop="description" content="Developer For Android">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ°¸æ’çš„ç æµ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/03/android-java-service-practice-guide/" class="post-title-link" itemprop="url">ç¼–å†™Androidçš„Javaç³»ç»ŸæœåŠ¡</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-12-03 17:55:19" itemprop="dateCreated datePublished" datetime="2021-12-03T17:55:19+08:00">2021-12-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-12-15 15:11:20" itemprop="dateModified" datetime="2021-12-15T15:11:20+08:00">2021-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">Androidç³»ç»Ÿå¼€å‘</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h1><p>å‚è€ƒé—¹é’ŸæœåŠ¡ç¼–å†™ä¸€ä¸ªHelloWorldServiceæœåŠ¡ï¼ŒåŠŸèƒ½ä¸ºæ‰“å°å­—ç¬¦ä¸²â€Hello, World!â€ï¼Œç„¶ååŸºäºç¼–è¯‘åçš„ç³»ç»Ÿï¼Œç¼–å†™APPä½¿ç”¨è¯¥æœåŠ¡ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">é—¹é’ŸæœåŠ¡ç›¸å…³æ¥å£å’Œç±»</span><br><span class="line">- /frameworks/base/core/java/android/app/IAlarmManager.aidl  æ¥å£å®šä¹‰</span><br><span class="line">- out/soong/.intermediates/frameworks/base/framemwork/android_common/</span><br><span class="line">  gen/aidl/frameworks/base/core/java/android/app/IAlarmManager.java  è‡ªåŠ¨ç”Ÿæˆçš„æ¥å£ä»¥åŠStubã€Proxy</span><br><span class="line">- /frameworks/base/services/core/java/com/android/server/AlarmManagerService.java  æœåŠ¡å®ç°</span><br><span class="line">- /frameworks/base/core/java/android/app/AlarmManager.java  å®¢æˆ·ç«¯ä½¿ç”¨çš„æœåŠ¡ä»£ç†</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="ç¼–å†™Framworkä»£ç "><a href="#ç¼–å†™Framworkä»£ç " class="headerlink" title="ç¼–å†™Framworkä»£ç "></a>ç¼–å†™Framworkä»£ç </h1><h3 id="ç¼–å†™å’Œé…ç½®-IHelloWorld-aidl"><a href="#ç¼–å†™å’Œé…ç½®-IHelloWorld-aidl" class="headerlink" title="ç¼–å†™å’Œé…ç½® IHelloWorld.aidl"></a>ç¼–å†™å’Œé…ç½® IHelloWorld.aidl</h3><p><strong>ç¼–å†™æ¥å£</strong>ã€‚ç›®å½•ï¼š<code>/frameworks/base/core/java/android/app</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> android.app</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * System private API for talking with the alarm manager service.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@hide</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IHelloWorld</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">printHello</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¾…ç¼–è¯‘æ—¶ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„javaæ¥å£å’ŒStubã€Proxyç±»ï¼Œä¸ç”¨æ‰‹åŠ¨å¤„ç†ï¼Œç”Ÿæˆçš„ä»£ç ä½äºï¼šout/soong/.intermediates/frameworks/base/framemwork/android_common/gen/aidl/frameworks/base/core/java/android/app</p>
<p><strong>é…ç½®æ¥å£</strong>ã€‚åœ¨ <code>/framwork/base/Android.bp</code>ä¸­é…ç½®æ¥å£ï¼Œåœ¨<code>srcs</code>æ•°ç»„é‡Œå¢åŠ <code>HelloWorld.aidl</code>çš„è·¯å¾„åœ°å€å³å¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">java_defaults &#123;</span><br><span class="line">    name: <span class="string">&quot;framework-defaults&quot;</span>,</span><br><span class="line">    installable: <span class="keyword">true</span>,</span><br><span class="line"></span><br><span class="line">    srcs: [</span><br><span class="line">        ...</span><br><span class="line">        <span class="string">&quot;core/java/android/app/IAlarmManager.aidl&quot;</span>,</span><br><span class="line">        <span class="string">&quot;core/java/android/app/HelloWorld.aidl&quot;</span>,</span><br><span class="line">        ...</span><br><span class="line">		],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç¼–å†™å’Œæ³¨å†ŒHelloWorldService"><a href="#ç¼–å†™å’Œæ³¨å†ŒHelloWorldService" class="headerlink" title="ç¼–å†™å’Œæ³¨å†ŒHelloWorldService"></a>ç¼–å†™å’Œæ³¨å†ŒHelloWorldService</h3><p><strong>é…ç½®å¸¸é‡</strong>ã€‚åœ¨ç¼–å†™æœåŠ¡ä¹‹å‰éœ€è¦åœ¨Context.javaé‡Œé…ç½®å¸¸é‡ï¼Œå‚ç…§ALARM_SERVICEï¼Œè¿›è¡Œå¦‚ä¸‹é…ç½®ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰å¸¸é‡</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HELLO_WORLD_SERVICE = <span class="string">&quot;hello_world&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†å¸¸é‡æ·»åŠ åˆ°æ³¨è§£å€¼åˆ—è¡¨ä¸­</span></span><br><span class="line"><span class="meta">@StringDef(suffix = &#123; &quot;_SERVICE&quot; &#125;, value = &#123;</span></span><br><span class="line"><span class="meta">	...</span></span><br><span class="line"><span class="meta">    HELLO_WORLD_SERVICE,</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.SOURCE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ServiceName &#123;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç¼–å†™æœåŠ¡</strong>ã€‚å‚è€ƒ<a target="_blank" rel="noopener" href="http://aospxref.com/android-10.0.0_r47/xref/frameworks/base/services/core/java/com/android/server/AlarmManagerService.java#mService">AlarmManagerService</a> ï¼Œç›®å½•: <code>/frameworks/base/services/core/java/com/android/server</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.android.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.IHelloWorld;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.os.IBinder;</span><br><span class="line"><span class="keyword">import</span> android.os.RemoteException;</span><br><span class="line"><span class="keyword">import</span> android.util.Slog;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldService</span> <span class="keyword">extends</span> <span class="title">SystemService</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Initializes the system service.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * Subclasses must define a single argument constructor that accepts the context</span></span><br><span class="line"><span class="comment">     * and passes it to super.</span></span><br><span class="line"><span class="comment">     * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context The system server context.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HelloWorldService</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ä¹‹å‰å·²ç»åœ¨Contextä¸­å®šä¹‰è¿‡å¸¸é‡</span></span><br><span class="line">        publishBinderService(Context.HELLO_WORLD, mService);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IBinder mService = <span class="keyword">new</span> IHelloWorld.Stub() &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">&quot;HelloWorldService&quot;</span>;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printHello</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">&quot;Hello, World!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ³¨å†ŒHelloWorldServiceæœåŠ¡</strong>ã€‚åœ¨SystemServer.javaé‡Œå‘æœåŠ¡ç®¡ç†è€…æ³¨å†ŒæœåŠ¡ã€‚</p>
<p>ç›®å½•ï¼š<code> /frameworks/base/services/java/com/android/server/SystemServer.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startOtherServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    traceBeginAndSlog(<span class="string">&quot;StartAlarmManagerService&quot;</span>);</span><br><span class="line">    mSystemServiceManager.startService(<span class="keyword">new</span> AlarmManagerService(context));</span><br><span class="line">    traceEnd();</span><br><span class="line"></span><br><span class="line">    traceBeginAndSlog(<span class="string">&quot;StartHelloWorldService&quot;</span>);</span><br><span class="line">    <span class="comment">// æ­¤å¤„å®ä¾‹åŒ–å¹¶æ³¨å†ŒHelloWorldService</span></span><br><span class="line">    mSystemServiceManager.startService(<span class="keyword">new</span> HelloWorldService(context));</span><br><span class="line">    traceEnd();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç¼–å†™å’Œæ³¨å†ŒHelloWorldManager"><a href="#ç¼–å†™å’Œæ³¨å†ŒHelloWorldManager" class="headerlink" title="ç¼–å†™å’Œæ³¨å†ŒHelloWorldManager"></a>ç¼–å†™å’Œæ³¨å†ŒHelloWorldManager</h3><p><strong>ç¼–å†™HelloWorldManager</strong>ã€‚å‚è€ƒAlarmManagerç¼–å†™å®¢æˆ·ç«¯çš„HelloWorldManagerï¼ŒåŸºäºæ­¤åº”ç”¨å¼€å‘è€…å¯ä»¥ä½¿ç”¨HelloWorldServiceã€‚</p>
<p>ç›®å½•ï¼š<code>/frameworks/base/core/java/android/app</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> android.app;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.annotation.SystemService;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SystemService(Context.HELLO_WORLD)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">&quot;HelloWorldManager&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IHelloWorld mService;</span><br><span class="line">    HelloWorldManager(IHelloWorld mService) &#123;</span><br><span class="line">        <span class="keyword">this</span>.mService = mService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mService.printHello();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ³¨å†ŒServiceFetcher</strong>ã€‚è¦åˆ©ç”¨<code>ContextImpl.getSystemService(String name)</code> è·å–æœåŠ¡çš„Managerï¼Œéœ€è¦é¦–å…ˆåœ¨<code>SystemServiceRegistry</code>é‡Œæ³¨å†Œç›¸åº”çš„<code>ServiceFetcher</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SystemServiceRegistry</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        registerService(Context.HELLO_WORLD, HelloWorldManager.class,</span><br><span class="line">                <span class="keyword">new</span> CachedServiceFetcher&lt;HelloWorldManager&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> HelloWorldManager <span class="title">createService</span><span class="params">(ContextImpl ctx)</span> <span class="keyword">throws</span> ServiceNotFoundException </span>&#123;</span><br><span class="line">                IBinder b = ServiceManager.getServiceOrThrow(Context.HELLO_WORLD);</span><br><span class="line">                IHelloWorld service = IHelloWorld.Stub.asInterface(b);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> HelloWorldManager(service);</span><br><span class="line">            &#125;&#125;);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="é…ç½®SELinuxæƒé™"><a href="#é…ç½®SELinuxæƒé™" class="headerlink" title="é…ç½®SELinuxæƒé™"></a>é…ç½®SELinuxæƒé™</h3><p>åœ¨system/sepolicy ç›®å½•ä¸‹çš„service.te å’Œ service_contexts ä¸­é…ç½® HelloWorldServiceçš„æƒé™ã€‚<strong>TODOï¼Œå¾…è¯¦ç»†äº†è§£</strong></p>
<h1 id="ç¼–è¯‘å’Œçƒ§å½•"><a href="#ç¼–è¯‘å’Œçƒ§å½•" class="headerlink" title="ç¼–è¯‘å’Œçƒ§å½•"></a>ç¼–è¯‘å’Œçƒ§å½•</h1><p>ç¼–è¯‘Androidç³»ç»Ÿï¼Œå¹¶çƒ§å½•åˆ°å®æœºè®¾å¤‡æˆ–è™šæ‹Ÿè®¾å¤‡ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ m update-api</span><br></pre></td></tr></table></figure>

<h1 id="ç¼–å†™APPå¹¶éªŒè¯"><a href="#ç¼–å†™APPå¹¶éªŒè¯" class="headerlink" title="ç¼–å†™APPå¹¶éªŒè¯"></a>ç¼–å†™APPå¹¶éªŒè¯</h1><p>å°†ç³»ç»Ÿç¼–è¯‘å‡ºçš„class.jarå¯¼å…¥åˆ°å·¥ç¨‹ä¸­ï¼Œç¼–å†™APPï¼Œè·å–æœåŠ¡å¹¶è°ƒç”¨æœåŠ¡çš„æ–¹æ³•ã€‚</p>
<p>åœ¨ä¸»Activityçš„onCreate()é‡ŒåŠ å…¥å¦‚ä¸‹ä¸¤ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    HelloWorldManager hwm = (HelloWorldManager)getSystemService(Context.HELLO_WORLD);</span><br><span class="line">    hwm.printHW();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡ŒAPPå¹¶æŸ¥çœ‹Log</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul>
<li>é‡‘æ³°å»·ç­‰è‘—ã€ŠAndroidæ¡†æ¶è§£å¯†ã€‹ï¼Œäººæ°‘é‚®ç”µå‡ºç‰ˆç¤¾ï¼Œ2012ã€‚è¯¥ä¹¦åˆ†æçš„ä»£ç è¾ƒè€ï¼Œä½†æ¡†æ¶æœºåˆ¶åŸºæœ¬ä¸å˜ï¼Œéå¸¸å¥½çš„ä¹¦ç±ã€‚</li>
<li>æºç æŸ¥çœ‹ç½‘ç«™ï¼š<a target="_blank" rel="noopener" href="http://aospxref.com/%E3%80%82%E5%9F%BA%E4%BA%8EOpenGrok%E7%9A%84%E6%BA%90%E7%A0%81%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1%E7%BD%91%E7%AB%99%EF%BC%8C%E9%80%9F%E5%BA%A6%E5%BE%88%E5%BF%AB%EF%BC%8C%E4%B8%BB%E8%A6%81%E7%94%A8%E6%9D%A5%E6%9F%A5%E7%9C%8BC/C++%E4%BB%A3%E7%A0%81%EF%BC%8CJava%E4%BB%A3%E7%A0%81%E5%8F%AF%E4%B8%8B%E8%BD%BD%E5%88%B0%E6%9C%AC%E5%9C%B0%E6%9F%A5%E7%9C%8B%E3%80%82">http://aospxref.com/ã€‚åŸºäºOpenGrokçš„æºç æŸ¥çœ‹æœåŠ¡ç½‘ç«™ï¼Œé€Ÿåº¦å¾ˆå¿«ï¼Œä¸»è¦ç”¨æ¥æŸ¥çœ‹C/C++ä»£ç ï¼ŒJavaä»£ç å¯ä¸‹è½½åˆ°æœ¬åœ°æŸ¥çœ‹ã€‚</a></li>
<li><a target="_blank" rel="noopener" href="https://source.android.google.cn/security/selinux?hl=zh-cn">AOSPå®˜æ–¹-SELinux</a>ï¼šè¯¦ç»†ä»‹ç»äº†SELinux</li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/a546036242/article/details/118221349">android 10 æ·»åŠ ç³»ç»ŸæœåŠ¡æ­¥éª¤</a>ï¼šä¸»è¦å‚è€ƒé‡Œé¢æ·»åŠ SELinuxæƒé™é‚£å—ã€‚</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhangliangnbu.github.io/2021/12/02/android-service-framwork-guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="ç« äº®">
      <meta itemprop="description" content="Developer For Android">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ°¸æ’çš„ç æµ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/02/android-service-framwork-guide/" class="post-title-link" itemprop="url">AndroidæœåŠ¡æ¡†æ¶æ¦‚è§ˆ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-12-02 17:59:47" itemprop="dateCreated datePublished" datetime="2021-12-02T17:59:47+08:00">2021-12-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-12-15 15:11:30" itemprop="dateModified" datetime="2021-12-15T15:11:30+08:00">2021-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">Androidç³»ç»Ÿå¼€å‘</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h1><p>AndroidæœåŠ¡æ¡†æ¶åŒ…æ‹¬JavaæœåŠ¡æ¡†æ¶ï¼ˆJavaå±‚ï¼‰å’Œæœ¬åœ°æœåŠ¡æ¡†æ¶ï¼ˆC++å±‚ï¼‰ï¼Œä¸¤å±‚é€šè¿‡JNIäº¤äº’ã€‚</p>
<p>ä»£ç åˆ†æç‰ˆæœ¬ï¼šAndroid 10</p>
<h1 id="æ¡†æ¶æ¦‚è§ˆ"><a href="#æ¡†æ¶æ¦‚è§ˆ" class="headerlink" title="æ¡†æ¶æ¦‚è§ˆ"></a>æ¡†æ¶æ¦‚è§ˆ</h1><h3 id="AndroidæœåŠ¡æ¡†æ¶ç»“æ„å›¾"><a href="#AndroidæœåŠ¡æ¡†æ¶ç»“æ„å›¾" class="headerlink" title="AndroidæœåŠ¡æ¡†æ¶ç»“æ„å›¾"></a><strong>AndroidæœåŠ¡æ¡†æ¶ç»“æ„å›¾</strong></h3><p><img src="/images/android-service-framwork-structure.svg"></p>
<p>è¯´æ˜ï¼šAndroidæœåŠ¡æ¡†æ¶å¯åˆ†ä¸ºå››å±‚</p>
<ol>
<li>æœåŠ¡å±‚ï¼šåŒ…å«ç‰¹å®šåŠŸèƒ½å‡½æ•°çš„æœåŠ¡å±‚ã€‚IFooServiceè§„å®šæœåŠ¡æä¾›çš„å‡½æ•°ï¼Œç»§æ‰¿IInterfaceï¼›FooManagerå¼•ç”¨IFooServiceï¼›FooServiceç»§æ‰¿Binderå’ŒIFooServiceã€‚</li>
<li>RPCå±‚ï¼šå®¢æˆ·ç«¯ç”ŸæˆRPCä»£ç å’Œæ•°æ®ï¼ŒæœåŠ¡ç«¯æ ¹æ®RPCä»£ç æŸ¥æ‰¾å¯¹åº”å‡½æ•°å¹¶ä¼ é€’RPCæ•°æ®ã€‚IFooService.Stub.ProxyæŒæœ‰BinderProxyå¼•ç”¨ï¼ŒBinderProxyç”±ç”¨æˆ·æ£€ç´¢æœåŠ¡æ—¶è·å¾—ã€‚IFooService.Stubä¸ºæŠ½è±¡ç±»ï¼Œç”±FooServiceæˆ–å…¶æˆå‘˜å®ç°ã€‚</li>
<li>IPCå±‚ï¼šå°†RPCä»£ç å’Œæ•°æ®å°è£…ä¸ºBinder IPCæ•°æ®ï¼Œå¹¶ä¼ é€’ç»™Binder Driverã€‚</li>
<li>Binder Driverå±‚ï¼šæ ¹æ®Binder IPCæ•°æ®æŸ¥æ‰¾æŒ‡å®šæœåŠ¡å¹¶è¿”å›ã€‚</li>
</ol>
<h3 id="Androidç³»ç»ŸæœåŠ¡æ¡†æ¶å„ç±»ç›¸äº’ä½œç”¨"><a href="#Androidç³»ç»ŸæœåŠ¡æ¡†æ¶å„ç±»ç›¸äº’ä½œç”¨" class="headerlink" title="Androidç³»ç»ŸæœåŠ¡æ¡†æ¶å„ç±»ç›¸äº’ä½œç”¨"></a><strong>Androidç³»ç»ŸæœåŠ¡æ¡†æ¶å„ç±»ç›¸äº’ä½œç”¨</strong></h3><p><img src="/images/android-service-framwork-class-work.svg"></p>
<ol>
<li>æ³¨å†ŒæœåŠ¡ã€‚FooServiceå‘èµ·æœåŠ¡æ³¨å†Œè¯·æ±‚ï¼ŒJavaç³»ç»ŸæœåŠ¡ä¸€èˆ¬åœ¨SystemServer.runæ–¹æ³•é‡Œå®ä¾‹åŒ–å¹¶æ³¨å†Œã€‚åœ¨Binderé©±åŠ¨é‡Œå°†æœåŠ¡æ³¨å†Œä¸ºBinderèŠ‚ç‚¹ï¼ŒContextManageræŒæœ‰è¯¥èŠ‚ç‚¹å¥æŸ„ã€‚</li>
<li>æ£€ç´¢æœåŠ¡ã€‚ç”¨æˆ·ä½¿ç”¨Context.getSystemServiceè·å–FooServiceï¼Œå®é™…ä¸Šæ˜¯é€šè¿‡IPCä»ContextManager è·å–FooServiceï¼Œè¿”å›çš„æ˜¯FooServiceçš„å¥æŸ„ï¼Œä½†å®¢æˆ·ç«¯ä¸èƒ½ç›´æ¥ä½¿ç”¨FooServiceï¼Œæœ€ç»ˆè¿”å›çš„æ˜¯é€šè¿‡FooServiceç”Ÿæˆçš„ä»£ç†ç±»(BinderProxy)çš„åŒ…è£…ç±»FooManagerã€‚æ³¨æ„è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šç”Ÿæˆå®¢æˆ·ç«¯çš„BinderProxyå®ä¾‹ä»¥åŠæœ¬åœ°BpBinderå®ä¾‹ï¼ŒFooManageré—´æ¥æŒæœ‰BinderProxyå¼•ç”¨ï¼ŒBinderProxyé—´æ¥æŒæœ‰æœ¬åœ°BpBinderæŒ‡é’ˆï¼Œè¿™äº›å¯¹è±¡åœ¨å®¢æˆ·ç«¯ä½¿ç”¨æœåŠ¡æ—¶ä¼šæ¶‰åŠåˆ°ã€‚</li>
<li>ä½¿ç”¨æœåŠ¡ã€‚FooManagerè°ƒç”¨foo()å‡½æ•°ï¼Œå®é™…ä¸Šè°ƒç”¨ä»£ç†ç±»BinderProxy.transact()å‡½æ•°ï¼Œåè€…é€šè¿‡JNIä¸æœ¬åœ°BpBinderäº¤äº’ï¼Œå¹¶å°†æ•°æ®ä¼ ç»™Binderé©±åŠ¨è¿›è¡ŒIPCé€šä¿¡ï¼Œé€šè¿‡IPCThreadStateä¼šè°ƒç”¨FooServiceå¯¹åº”çš„æœ¬åœ°BBinderå®ä¾‹ï¼Œå®é™…ä¸ºå…¶å®ç°ç±»JavaBBinderï¼Œåè€…ä¼šè°ƒç”¨Javaå±‚çš„FooService(ç»§æ‰¿IFooService.Stubï¼Œåè€…ç»§æ‰¿Binder)çš„execTransact()æ–¹æ³•ï¼Œæœ€ç»ˆæ ¹æ®RPCä»£ç æŸ¥æ‰¾åˆ°æŒ‡å®šå‡½æ•°å¹¶æ‰§è¡Œã€‚</li>
</ol>
<p><strong>æ³¨æ„ï¼šä»¥ä¸Šä¸¾ä¾‹é€‚ç”¨äºJavaæœåŠ¡ï¼Œæœ¬åœ°æœåŠ¡ç±»ä¼¼ï¼Œéœ€è¦å°†æœ€ä¸Šå±‚çš„Javaä»£ç æ”¹ä¸ºC++ä»£ç ï¼Œç»†èŠ‚å¾…ç¡®å®š TODO</strong></p>
<h3 id="ä¸»è¦ç±»å’Œæ–‡ä»¶"><a href="#ä¸»è¦ç±»å’Œæ–‡ä»¶" class="headerlink" title="ä¸»è¦ç±»å’Œæ–‡ä»¶"></a>ä¸»è¦ç±»å’Œæ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">java</span><br><span class="line">/frameworks/base/core/java/android/app/AlarmManager.java</span><br><span class="line">/frameworks/base/core/java/android/app/IAlarmManager.aidl</span><br><span class="line">- åŒ…å«IAlarmManager.Stubå’ŒIAlarmManager.Stub.Proxyç±»</span><br><span class="line">/frameworks/base/core/java/android/os/ServiceManagerNative.java</span><br><span class="line">- åŒ…å«ServiceManagerProxyç±»</span><br><span class="line">/frameworks/base/core/java/android/os/BinderProxy.java</span><br><span class="line">/frameworks/base/core/java/android/os/Binder.java</span><br><span class="line"></span><br><span class="line">c/c++</span><br><span class="line">/frameworks/base/core/jni/android_util_Binder.cpp</span><br><span class="line">- åŒ…å«JavaBBinderç±»</span><br><span class="line">/frameworks/native/libs/binder/BpBinder.cpp</span><br><span class="line">/frameworks/native/libs/binder/Binder.cpp  </span><br><span class="line">- è¯¥æ–‡ä»¶åŒ…å«BBinderç±»</span><br><span class="line">/frameworks/native/libs/binder/IPCThreadState.cpp</span><br><span class="line">/frameworks/native/cmds/servicemanager/service_manager.c</span><br></pre></td></tr></table></figure>

<h1 id="ç¤ºä¾‹åˆ†æ-AlarmManagerService"><a href="#ç¤ºä¾‹åˆ†æ-AlarmManagerService" class="headerlink" title="ç¤ºä¾‹åˆ†æ-AlarmManagerService"></a>ç¤ºä¾‹åˆ†æ-AlarmManagerService</h1><p>ä»¥åº”ç”¨å±‚ä½¿ç”¨Javaç³»ç»ŸæœåŠ¡AlarmManagerServiceä¸ºä¾‹ï¼ŒåŸºäºä»£ç åˆ†ææœåŠ¡çš„æ³¨å†Œã€æ£€ç´¢å’Œä½¿ç”¨ä¸‰ä¸ªæµç¨‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. SystemSeverå¯åŠ¨æ—¶ï¼Œæ³¨å†ŒæœåŠ¡ã€‚</span></span><br><span class="line">mSystemServiceManager.startService(<span class="keyword">new</span> AlarmManagerService(context));</span><br><span class="line"></span><br><span class="line"><span class="comment">// SampleActivity.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 2. æ£€ç´¢æœåŠ¡ã€‚è·å–AlarmManageråŒ…è£…ç±»ï¼ŒæŒæœ‰æœåŠ¡ä»£ç†çš„å¼•ç”¨</span></span><br><span class="line">        AlarmManager am = (AlarmManager) getSystemService(Context.ALARM_SERVICE);</span><br><span class="line">        <span class="comment">// 3. ä½¿ç”¨æœåŠ¡ã€‚é€šè¿‡åŒ…è£…ç±»è°ƒç”¨æœåŠ¡çš„æ–¹æ³•</span></span><br><span class="line">        am.setTime(<span class="number">1000L</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æ³¨å†ŒæœåŠ¡"><a href="#æ³¨å†ŒæœåŠ¡" class="headerlink" title="æ³¨å†ŒæœåŠ¡"></a>æ³¨å†ŒæœåŠ¡</h3><p>Javaç³»ç»ŸæœåŠ¡åœ¨SystemServerè¿›ç¨‹å¯åŠ¨æ—¶å¼€å§‹å®ä¾‹åŒ–å¹¶æ³¨å†Œã€‚é¦–å…ˆè°ƒç”¨SystemServer.main()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å†…éƒ¨ä¼šå®ä¾‹åŒ–SystemServerå¹¶è°ƒç”¨å…¶run()æ–¹æ³•ï¼Œrun()æ–¹æ³•ä¸­æ¥ç€è°ƒç”¨startOtherServices()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸­ä¼šæ‰§è¡ŒAlarmManagerServiceçš„æœåŠ¡å®ä¾‹åŒ–å’Œæ³¨å†Œæ“ä½œã€‚</p>
<p>SystemServer.run()æ–¹æ³•æœ€åä¼šè°ƒç”¨Looper.loop()æ–¹æ³•é˜»æ­¢çº¿ç¨‹é€€å‡ºï¼ŒSystemServerå®ä¾‹ä¼šå¸¸ä½å†…å­˜ä¸”æŒæœ‰SystemServiceManagerå®ä¾‹å¼•ç”¨ï¼ŒSystemServiceManageråˆæŒæœ‰ç³»ç»ŸæœåŠ¡é›†åˆï¼Œå› æ­¤å„ä¸ªç³»ç»ŸæœåŠ¡å®ä¾‹ä¼šå¸¸ä½ç³»ç»Ÿå†…å­˜ï¼Œä»¥ä¾›å®¢æˆ·ç«¯è°ƒç”¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‰ç½®æµç¨‹ï¼šSystemServer.main() -&gt; SystemServer.run() -&gt; startOtherServices()</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startOtherServices</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    <span class="comment">// SystemServiceManager.startServiceå†…éƒ¨è°ƒç”¨æµç¨‹:</span></span><br><span class="line">    <span class="comment">// -&gt; SystemService.onStart(), å®é™…è°ƒç”¨çš„æ˜¯å­ç±»AlarmManagerService.onStart()</span></span><br><span class="line">    <span class="comment">// -&gt; SystemService.publishBinderService()</span></span><br><span class="line">    <span class="comment">// -&gt; ServiceManager.addService() </span></span><br><span class="line">    <span class="comment">//    å…ˆé€šè¿‡getIServiceManageræ„é€ ServiceManagerProxyï¼Œå†è°ƒç”¨å…¶addService()æ–¹æ³•</span></span><br><span class="line">    <span class="comment">// -&gt; ServiceManagerProxy.addService(), æ–¹æ³•å†…çš„mRemoteä¸ºBinderProxy, è¯¦æƒ…è§(1)</span></span><br><span class="line">    <span class="comment">// è¿›å…¥IPCæµç¨‹:</span></span><br><span class="line">    <span class="comment">// -&gt; BinderProxy.transact() -&gt; native transactNative()</span></span><br><span class="line">    <span class="comment">// -&gt; android_os_BinderProxy_transact(), android_util_Binder.cpp</span></span><br><span class="line">    <span class="comment">// -&gt; BpBinder.transact(), BpBinder.cpp</span></span><br><span class="line">    <span class="comment">// -&gt; IPCThreadState.transact(mHandle, code, data, ...), IPCThreadState.cpp</span></span><br><span class="line">    <span class="comment">// -&gt; ...Binder Driver IPC... æœ€ç»ˆè¿›å…¥ContextManageræœåŠ¡è¿›ç¨‹ä¸­...</span></span><br><span class="line">    <span class="comment">// -&gt; IPCThreadState::executeCommand(), IPCThreadState.cpp</span></span><br><span class="line">    <span class="comment">// -&gt; BBinder.transact() -&gt; onTransact() -&gt; ...??, Binder.cpp (2)</span></span><br><span class="line">    <span class="comment">// æ³¨å†Œæ“ä½œçš„æœåŠ¡ç«¯å®ç°:</span></span><br><span class="line">    <span class="comment">// -&gt; binder_loop(), service_manager.c, loop()æ–¹æ³•åœ¨main()æ–¹æ³•é‡Œè¢«è°ƒç”¨å¹¶ç­‰å¾…æ¶ˆæ¯</span></span><br><span class="line">    <span class="comment">// -&gt; binder_parse(), service_manager.c, è¿›å…¥BR_TRANSACTIONåˆ†æ”¯</span></span><br><span class="line">    <span class="comment">//    funcåœ¨service_manager.c:main()æ–¹æ³•é‡Œé¢„è®¾ä¸ºsvcmgr_handler</span></span><br><span class="line">    <span class="comment">// -&gt; svcmgr_handler(bs, &amp;txn, &amp;msg, &amp;reply), service_manager.c</span></span><br><span class="line">    <span class="comment">//    è¿›å…¥åˆ†æ”¯ï¼šcase SVC_MGR_ADD_SERVICE</span></span><br><span class="line">    <span class="comment">// -&gt; do_add_service(), service_manager.c, ä¿å­˜æœåŠ¡åç§°ã€èŠ‚ç‚¹handleç­‰æ•°æ®åˆ°svclist</span></span><br><span class="line">    mSystemServiceManager.startService(<span class="keyword">new</span> AlarmManagerService(context));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(1) mRemoteåˆå§‹åŒ–ä¸ºBinderProxyæµç¨‹</p>
<p>mRemoteè¢«å£°æ˜ä¸ºIBinderï¼Œåœ¨ServiceManagerProxyæ„é€ æ–¹æ³•å†…è¿›è¡Œåˆå§‹åŒ–ï¼Œè€ŒServiceManagerProxyæ˜¯é€šè¿‡ServiceManager.getIServiceManager()å†…è°ƒç”¨é™æ€æ–¹æ³•ServiceManagerNative.asInterface(IBinder b)è¿›è¡Œæ„é€ çš„ã€‚</p>
<p>ServiceManagerNative.asInterface(IBinder b)æ–¹æ³•æ¥æ”¶IBinderç±»å‹çš„å‚æ•°ï¼Œå¹¶æœ€ç»ˆèµ‹å€¼ç»™ServiceManagerProxyé‡Œçš„mRemoteå˜é‡ã€‚IBinderç±»å‹çš„å‚æ•°ç”±BinderInternal.getContextObject()é€šè¿‡JNIæ–¹å¼ä»æœ¬åœ°è·å–ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> IServiceManager <span class="title">getIServiceManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// BinderInternal.getContextObject() è¿”å›çš„IBinderå³ä¸ºmRemoteçš„å€¼</span></span><br><span class="line">    sServiceManager = ServiceManagerNative</span><br><span class="line">        .asInterface(Binder.allowBlocking(BinderInternal.getContextObject()));</span><br><span class="line">    <span class="keyword">return</span> sServiceManager;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡JNIæ–¹å¼å®ä¾‹åŒ–BinderProxyæµç¨‹:</span></span><br><span class="line"><span class="comment">// -&gt; android_util_Binder.cpp: android_os_BinderInternal_getContextObject()</span></span><br><span class="line"><span class="comment">// -&gt; android_util_Binder.cpp: javaObjectForIBinder()</span></span><br><span class="line"><span class="comment">// -&gt; android_util_Binder.cpp: jobject object = env-&gt;CallStaticObjectMethod(</span></span><br><span class="line"><span class="comment">//        gBinderProxyOffsets.mClass,gBinderProxyOffsets.mGetInstance, ...);</span></span><br><span class="line"><span class="comment">//    å³æœ€ç»ˆä¼šå¾…ç”¨Javaå±‚é™æ€æ–¹æ³•BinderProxy.getInstance()</span></span><br><span class="line"><span class="comment">// -&gt; BinderProxy.getInstance()</span></span><br><span class="line"><span class="comment">// -&gt; new BinderProxy(nativeData) æœ€ç»ˆé€šè¿‡ä»æœ¬åœ°æœåŠ¡è·å–çš„æ•°æ®æ„é€ BinderProxy</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">native</span> IBinder <span class="title">getContextObject</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>

<p><strong>(2) å¦‚ä½•ä»BBinderè¿›å…¥service_manager.cçš„binder_loop()æ–¹æ³•ä¸­? TODO</strong></p>
<h3 id="æ£€ç´¢æœåŠ¡"><a href="#æ£€ç´¢æœåŠ¡" class="headerlink" title="æ£€ç´¢æœåŠ¡"></a>æ£€ç´¢æœåŠ¡</h3><p>è°ƒç”¨Context.getSystemService()æ–¹æ³•ï¼Œå…·ä½“æ˜¯è°ƒç”¨ContextImpl.getSystemService()æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ContextImpl.java é€šè¿‡nameè·å–ServiceFetcher</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getSystemService</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å†…éƒ¨è°ƒç”¨æµç¨‹: </span></span><br><span class="line">    <span class="comment">// -&gt; ServiceFetcher.getService(),  æœ€åˆä¼šè°ƒç”¨ createService()</span></span><br><span class="line">    <span class="comment">// -&gt; CachedServiceFetcher.createService(),</span></span><br><span class="line">    <span class="comment">//    CachedServiceFetcheræ˜¯ServiceFetcherå®ç°æŠ½è±¡ç±», å®ƒæ˜¯åœ¨</span></span><br><span class="line">    <span class="comment">//    SystemServiceRegistryä¸­é€šè¿‡é™æ€ä»£ç å—è°ƒç”¨é™æ€æ–¹æ³•registerService()æ—¶å®ä¾‹åŒ–çš„</span></span><br><span class="line">    <span class="keyword">return</span> SystemServiceRegistry.getSystemService(<span class="keyword">this</span>, name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SystemServiceRegistry.java</span></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="comment">// æ³¨å†ŒæœåŠ¡Fetcher, å®ä¾‹åŒ–CachedServiceFetcher</span></span><br><span class="line">    registerService(Context.ALARM_SERVICE, AlarmManager.class,</span><br><span class="line">            <span class="keyword">new</span> CachedServiceFetcher&lt;AlarmManager&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> AlarmManager <span class="title">createService</span><span class="params">(ContextImpl ctx)</span> </span>&#123;</span><br><span class="line">            IBinder b = ServiceManager.getServiceOrThrow(Context.ALARM_SERVICE);</span><br><span class="line">            IAlarmManager service = IAlarmManager.Stub.asInterface(b);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AlarmManager(service, ctx);</span><br><span class="line">        &#125;&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CachedServiceFetcheråŒ¿åå­ç±»</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> AlarmManager <span class="title">createService</span><span class="params">(ContextImpl ctx)</span> <span class="keyword">throws</span> ServiceNotFoundException </span>&#123;</span><br><span class="line">    <span class="comment">// è¯´æ˜ï¼šæ­¤å¤„è·å–çš„IBinderä¸ºBinderProxy</span></span><br><span class="line">    <span class="comment">// ServiceManager.getServiceOrThrowå†…éƒ¨è°ƒç”¨æµç¨‹ï¼š</span></span><br><span class="line">    <span class="comment">// -&gt; IBinder binder = ServiceManager.getService()</span></span><br><span class="line">    <span class="comment">// -&gt; IBinder binder = ServiceManager.rawGetService()</span></span><br><span class="line">    <span class="comment">// -&gt; IBinder binder = getIServiceManager().getService(name)</span></span><br><span class="line">    <span class="comment">// -&gt; ServiceManagerProxy.getService(),  æ–¹æ³•å†…mRemoteä¸ºBinderProxy</span></span><br><span class="line">    <span class="comment">// è¿›å…¥IPCæµç¨‹:</span></span><br><span class="line">    <span class="comment">// -&gt; BinderProxy.transact() -&gt; native transactNative()</span></span><br><span class="line">    <span class="comment">// -&gt; BpBinder.transact()...ipc...BBinder.transact()..., </span></span><br><span class="line">    <span class="comment">// æ£€ç´¢æ“ä½œçš„æœåŠ¡ç«¯å®ç°:</span></span><br><span class="line">    <span class="comment">// -&gt; service_manager.c:do_find_service()å¹¶è¿”å›handleå€¼, ç»“æœå­˜äºreply</span></span><br><span class="line">    <span class="comment">// å¾…BinderProxy.transact()è°ƒç”¨å®Œæ¯•åï¼Œä¼šæ¥ç€è°ƒç”¨</span></span><br><span class="line">    <span class="comment">// -&gt; IBinder binder = reply.readStrongBinder(), æ­¤å¤„ä¼šåˆ›å»ºBinderProxyå¯¹è±¡</span></span><br><span class="line">    <span class="comment">//    åŠå…¶nativeå¯¹è±¡BpBinderï¼Œä¹‹åä½¿ç”¨æœåŠ¡æ—¶ä¼šç”¨åˆ°</span></span><br><span class="line">    IBinder b = ServiceManager.getServiceOrThrow(Context.ALARM_SERVICE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­¤å¤„çš„serviceä¸ºIAlarmManager.Stub.Proxy</span></span><br><span class="line">    <span class="comment">// -&gt; new android.app.IAlarmManager.Stub.Proxy(obj);</span></span><br><span class="line">    <span class="comment">// å³åŸºäºServiceæ„é€ BinderProxy, åŸºäºBinderProxyæ„é€ Stub.Proxy, </span></span><br><span class="line">    <span class="comment">// åŸºäºStub.Proxyæ„é€ Manager</span></span><br><span class="line">    IAlarmManager service = IAlarmManager.Stub.asInterface(b);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> AlarmManager(service, ctx);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="ä½¿ç”¨æœåŠ¡"><a href="#ä½¿ç”¨æœåŠ¡" class="headerlink" title="ä½¿ç”¨æœåŠ¡"></a>ä½¿ç”¨æœåŠ¡</h3><p>è°ƒç”¨AlarmManager.setTime()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTime</span><span class="params">(<span class="keyword">long</span> millis)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ç”±æ£€ç´¢æœåŠ¡æµç¨‹çŸ¥mServiceä¸ºStub.Proxyå¯¹è±¡</span></span><br><span class="line">    <span class="comment">// mService.setTime()å†…éƒ¨è°ƒç”¨æµç¨‹å¦‚ä¸‹ï¼š</span></span><br><span class="line">    <span class="comment">// -&gt; IAlarmManager.Stub.Proxy.setTime()</span></span><br><span class="line">    <span class="comment">//    ç”±æ£€ç´¢æœåŠ¡æµç¨‹çŸ¥Stub.Proxyé‡Œçš„mRemoteä¸ºBinderProxyå¯¹è±¡</span></span><br><span class="line">    <span class="comment">// è¿›å…¥IPCæµç¨‹:</span></span><br><span class="line">    <span class="comment">// -&gt; BinderProxy.transact(Stub.TRANSACTION_setTime, _data, _reply, 0)</span></span><br><span class="line">    <span class="comment">// -&gt; native transactNative()</span></span><br><span class="line">    <span class="comment">// -&gt; android_os_BinderProxy_transact(), android_util_Binder.cpp</span></span><br><span class="line">    <span class="comment">// -&gt; BpBinder.transact(), BpBinder.cpp</span></span><br><span class="line">    <span class="comment">// -&gt; IPCThreadState.transact(mHandle, code, data, ...), IPCThreadState.cpp</span></span><br><span class="line">    <span class="comment">// -&gt; ...Binder Driver IPC... </span></span><br><span class="line">    <span class="comment">// -&gt; IPCThreadState::executeCommand(), IPCThreadState.cpp</span></span><br><span class="line">    <span class="comment">// -&gt; BBinder.transact(), Binder.cpp</span></span><br><span class="line">    <span class="comment">// -&gt; JavaBBinder(å­ç±»).onTransact(), android_util_Binder.cpp (1)</span></span><br><span class="line">    <span class="comment">// -&gt; Binder.execTransact()</span></span><br><span class="line">    <span class="comment">// æœåŠ¡æ–¹æ³•çš„å®ç°ï¼š</span></span><br><span class="line">    <span class="comment">// -&gt; IAlarmManager.Stub(å­ç±»).onTransact(), Stubä¸ºBinderçš„å®ç°ç±»</span></span><br><span class="line">    <span class="comment">// -&gt; AlarmManagerService.mService(å­ç±»).setTime(), mServiceä¸ºStubçš„å®ç°ç±»</span></span><br><span class="line">    mService.setTime(millis);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(1) JavaBBinderæœ¬åœ°ä»£ç è°ƒç”¨Javaä»£ç  Binder.execTransact()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android_util_Binder.cpp</span></span><br><span class="line"><span class="function">status_t <span class="title">onTransact</span><span class="params">()</span></span>&#123;</span><br><span class="line">    jboolean res = env-&gt;CallBooleanMethod(mObject, </span><br><span class="line">            gBinderOffsets.mExecTransact,  <span class="comment">// è°ƒç”¨ Binder.execTransact()</span></span><br><span class="line">            code, reinterpret_cast&lt;jlong&gt;(&amp;data), </span><br><span class="line">            reinterpret_cast&lt;jlong&gt;(reply), flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul>
<li>é‡‘æ³°å»·ç­‰è‘—ã€ŠAndroidæ¡†æ¶è§£å¯†ã€‹ï¼Œäººæ°‘é‚®ç”µå‡ºç‰ˆç¤¾ï¼Œ2012ã€‚è¯¥ä¹¦åˆ†æçš„ä»£ç è¾ƒè€ï¼Œä½†æ¡†æ¶æœºåˆ¶åŸºæœ¬ä¸å˜ï¼Œéå¸¸å¥½çš„ä¹¦ç±ã€‚</li>
<li>æºç æŸ¥çœ‹ç½‘ç«™ï¼š<a target="_blank" rel="noopener" href="http://aospxref.com/%E3%80%82%E5%9F%BA%E4%BA%8EOpenGrok%E7%9A%84%E6%BA%90%E7%A0%81%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1%E7%BD%91%E7%AB%99%EF%BC%8C%E9%80%9F%E5%BA%A6%E5%BE%88%E5%BF%AB%EF%BC%8C%E4%B8%BB%E8%A6%81%E7%94%A8%E6%9D%A5%E6%9F%A5%E7%9C%8BC/C++%E4%BB%A3%E7%A0%81%EF%BC%8CJava%E4%BB%A3%E7%A0%81%E5%8F%AF%E4%B8%8B%E8%BD%BD%E5%88%B0%E6%9C%AC%E5%9C%B0%E6%9F%A5%E7%9C%8B%E3%80%82">http://aospxref.com/ã€‚åŸºäºOpenGrokçš„æºç æŸ¥çœ‹æœåŠ¡ç½‘ç«™ï¼Œé€Ÿåº¦å¾ˆå¿«ï¼Œä¸»è¦ç”¨æ¥æŸ¥çœ‹C/C++ä»£ç ï¼ŒJavaä»£ç å¯ä¸‹è½½åˆ°æœ¬åœ°æŸ¥çœ‹ã€‚</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhangliangnbu.github.io/2021/07/01/Android%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E6%83%85%E5%BD%A2%E5%8F%8A%E8%A7%A3%E5%86%B3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="ç« äº®">
      <meta itemprop="description" content="Developer For Android">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ°¸æ’çš„ç æµ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/01/Android%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E6%83%85%E5%BD%A2%E5%8F%8A%E8%A7%A3%E5%86%B3/" class="post-title-link" itemprop="url">Androidå†…å­˜æ³„æ¼æƒ…å½¢åŠè§£å†³</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-07-01 11:34:22 / ä¿®æ”¹æ—¶é—´ï¼š11:35:15" itemprop="dateCreated datePublished" datetime="2021-07-01T11:34:22+08:00">2021-07-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">Androidå¼€å‘</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a><strong>å‰è¨€</strong></h2><p>å†…å­˜æ³„æ¼ï¼šå¯¹äºJavaæ¥è¯´ï¼Œå°±æ˜¯newå‡ºæ¥çš„å¯¹è±¡æ— æ³•è¢«GCå›æ”¶ã€‚å†…å­˜æ³„æ¼å‘ç”Ÿæ—¶çš„ä¸»è¦è¡¨ç°ä¸ºå†…å­˜æŠ–åŠ¨ï¼Œå¯ç”¨å†…å­˜æ…¢æ…¢å˜å°‘ã€‚</p>
<p><img src="C:\Users\zhang\Projects\blog\source_posts\Androidå†…å­˜æ³„æ¼æƒ…å½¢åŠè§£å†³.assets\v2-4483280b8b2bab984b40251648f92222_720w.png" alt="https://pic3.zhimg.com/80/v2-4483280b8b2bab984b40251648f92222_720w.png"></p>
<p>åœ¨Androidä¸­ï¼Œé€ æˆå†…å­˜æ³„æ¼çš„æƒ…å½¢æœ‰ï¼š</p>
<ol>
<li>ä½¿ç”¨å…¨å±€é™æ€å˜é‡æŒæœ‰<code>Activity</code>çš„å¼ºå¼•ç”¨ï¼Œè€Œæ²¡æœ‰åŠæ—¶æ¸…ç©ºã€‚</li>
<li>æ´»åœ¨<code>Activity</code>ç”Ÿå‘½å‘¨æœŸä¹‹å¤–çš„å¯¹è±¡æˆ–çº¿ç¨‹ï¼ŒæŒæœ‰<code>Activity</code>çš„å¼ºå¼•ç”¨ï¼Œè€Œæ²¡æœ‰åŠæ—¶æ¸…ç©ºã€‚</li>
<li>å¿˜è®°é‡Šæ”¾èµ„æºï¼Œæ¯”å¦‚å¿˜è®°å…³é—­<code>Cursor</code>ï¼Œæˆ–å¿˜è®°åæ³¨å†Œä¼ æ„Ÿå™¨ç­‰ã€‚</li>
</ol>
<h2 id="å…·ä½“åœºæ™¯å’Œè§£å†³æ–¹æ¡ˆ"><a href="#å…·ä½“åœºæ™¯å’Œè§£å†³æ–¹æ¡ˆ" class="headerlink" title="å…·ä½“åœºæ™¯å’Œè§£å†³æ–¹æ¡ˆ"></a><strong>å…·ä½“åœºæ™¯å’Œè§£å†³æ–¹æ¡ˆ</strong></h2><ul>
<li>é™æ€Activityã€‚åœ¨ç±»ä¸­å®šä¹‰äº†é™æ€Activityå˜é‡ï¼ŒæŠŠå½“å‰Activityå®ä¾‹èµ‹å€¼ç»™è¿™ä¸ªé™æ€å˜é‡ã€‚è§£å†³æ–¹æ¡ˆï¼Œé”€æ¯æ—¶ç½®ç©ºã€‚</li>
<li>é™æ€Viewã€‚å¦‚æœä¸€ä¸ªViewåˆå§‹åŒ–è€—è´¹å¤§é‡èµ„æºï¼Œè€Œä¸”åœ¨ä¸€ä¸ªActivityç”Ÿå‘½å‘¨æœŸå†…ä¿æŒä¸å˜ï¼Œé‚£å¯ä»¥æŠŠå®ƒå˜æˆstaticï¼ŒåŠ è½½åˆ°è§†å›¾æ ‘ä¸Š(View Hierachy)ï¼Œåƒè¿™æ ·ï¼Œå½“Activityè¢«é”€æ¯æ—¶ï¼Œåº”å½“é‡Šæ”¾èµ„æºã€‚</li>
<li>å†…éƒ¨ç±»ã€‚Activityä¸­æœ‰ä¸ªå†…éƒ¨ç±»ï¼Œå¦‚æœä¸€ä¸ªé™æ€å˜é‡æŒæœ‰è¯¥å†…éƒ¨ç±»å®ä¾‹å°±å®¹æ˜“é€ æˆå†…å­˜æ³„æ¼ã€‚è§£å†³æ–¹æ¡ˆï¼Œé”€æ¯æ—¶ç½®ç©ºã€‚</li>
<li>åŒ¿åå†…éƒ¨ç±»ã€‚åŒ¿åå†…éƒ¨ç±»å’Œå†…éƒ¨ç±»ä¸€æ ·ï¼Œéƒ½ä¼šæŒæœ‰å¤–éƒ¨ç±»çš„å¼ºå¼•ç”¨ï¼Œå…¶å†…å­˜æ³„æ¼åŸç†åŒå†…éƒ¨ç±»çš„é”™è¯¯ä½¿ç”¨ä¸€æ ·ã€‚è§£å†³æ–¹æ¡ˆï¼Œé”€æ¯æ—¶ç½®ç©ºã€‚</li>
<li>Handlerã€‚ä¸¤ç§æ–¹å¼é€ æˆå†…å­˜æ³„æ¼ï¼Œä¸€ç§æ˜¯ä½œä¸ºå†…éƒ¨ç±»æˆ–åŒ¿åå†…éƒ¨ç±»è€Œè¢«é™æ€å˜é‡æŒæœ‰ï¼Œä¸€ç§æ˜¯æ¶ˆæ¯æ²¡æœ‰åŠæ—¶æ¶ˆè´¹å¯¼è‡´Activityå®ä¾‹ä¸èƒ½è¢«é”€æ¯ï¼Œäºæ˜¯å‘ç”Ÿå†…å­˜æ³„æ¼ã€‚è§£å†³æ–¹æ¡ˆï¼Œä¸€ï¼Œå®šä¹‰Handlerä¸ºé™æ€å†…éƒ¨ç±»æˆ–å¤–éƒ¨å¯¹è±¡ï¼ŒäºŒï¼Œå¯¹Activityçš„å¼ºå¼•ç”¨æ”¹ä¸ºå¼±å¼•ç”¨ã€‚</li>
<li>Threadã€‚ä½œä¸ºåŒ¿åå†…éƒ¨ç±»æˆ–å†…éƒ¨ç±»æŒæœ‰Activityçš„å¼•ç”¨ï¼Œçº¿ç¨‹æ²¡æœ‰ç»“æŸæ—¶Activityéƒ½ä¸èƒ½é”€æ¯ã€‚è§£å†³æ–¹æ¡ˆï¼Œé”€æ¯æ—¶åœæ­¢å¹¶é”€æ¯çº¿ç¨‹ï¼Œæˆ–æ”¹ä¸ºæŒæœ‰Activityçš„å¼±å¼•ç”¨ã€‚</li>
<li>TimerTaskã€‚åªè¦è¦æ˜¯åŒ¿åç±»çš„å®ä¾‹ï¼Œä¸ç®¡æ˜¯ä¸æ˜¯åœ¨å·¥ä½œçº¿ç¨‹ï¼Œéƒ½ä¼šæŒæœ‰Activityçš„å¼•ç”¨ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚</li>
<li>ä¼ æ„Ÿå™¨æœåŠ¡ç±»ã€‚æ³¨å†Œç³»ç»ŸæœåŠ¡ï¼Œé”€æ¯æ—¶éœ€è¦åæ³¨å†Œï¼Œå¦åˆ™å¯¼è‡´å†…å­˜æ³„æ¼ã€‚</li>
</ul>
<h2 id="ä½¿ç”¨Leakcanaryæ£€æµ‹"><a href="#ä½¿ç”¨Leakcanaryæ£€æµ‹" class="headerlink" title="ä½¿ç”¨Leakcanaryæ£€æµ‹"></a><strong>ä½¿ç”¨Leakcanaryæ£€æµ‹</strong></h2><p><strong>Leakcanary</strong>åŸºæœ¬åŸç†ï¼š</p>
<ul>
<li>åœ¨ä¸€ä¸ªActivityæ‰§è¡Œå®ŒonDestroy()ä¹‹åï¼Œå°†å®ƒæ”¾å…¥WeakReferenceä¸­ï¼Œ</li>
<li>ç„¶åå°†è¿™ä¸ªWeakReferenceç±»å‹çš„Activityå¯¹è±¡ä¸ReferenceQueueå…³è”ã€‚</li>
<li>ä»ReferenceQueueä¸­æŸ¥çœ‹æ˜¯å¦æœ‰æ²¡æœ‰è¯¥å¯¹è±¡ï¼Œå¦‚æœè¿˜å­˜åœ¨ï¼Œæ‰§è¡Œgcï¼Œå†æ¬¡æŸ¥çœ‹ï¼Œè¿˜æ˜¯æœ‰çš„è¯åˆ™åˆ¤æ–­å‘ç”Ÿå†…å­˜æ³„éœ²äº†ã€‚</li>
<li>æœ€åç”¨HAHAè¿™ä¸ªå¼€æºåº“å»åˆ†ædumpä¹‹åçš„heapå†…å­˜ã€‚</li>
</ul>
<h2 id="é€šå¸¸çš„è§£å†³æ–¹æ¡ˆ"><a href="#é€šå¸¸çš„è§£å†³æ–¹æ¡ˆ" class="headerlink" title="é€šå¸¸çš„è§£å†³æ–¹æ¡ˆ"></a>é€šå¸¸çš„è§£å†³æ–¹æ¡ˆ</h2><p>ä¸ç®¡å†…å­˜æ³„æ¼çš„ä»£ç è¡¨ç°å½¢å¼å¦‚ä½•ï¼Œå…¶æ ¸å¿ƒé—®é¢˜åœ¨äºï¼šåœ¨Activityç”Ÿå‘½å‘¨æœŸä¹‹å¤–ä»æŒæœ‰å…¶å¼•ç”¨ã€‚</p>
<p>è§£å†³æ–¹æ³•ï¼š</p>
<ul>
<li>staticã€‚Activityé”€æ¯ä¹‹å‰ç½®ç©ºå³å¯ã€‚</li>
<li>å†…éƒ¨ç±»æˆ–åŒ¿åå†…éƒ¨ç±»ã€Handlerã€‚å°†å­ç±»å£°æ˜ä¸ºé™æ€å†…éƒ¨ç±»æˆ–å¤–éƒ¨ç±»ï¼Œå¯¹Activityçš„å¼ºå¼•ç”¨æ”¹ä¸ºå¼±å¼•ç”¨ã€‚</li>
<li>Threadã€TimerTaskã€‚å¦‚æœåšæŒä½¿ç”¨åŒ¿åç±»ï¼Œåªè¦åœ¨ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶ä¸­æ–­çº¿ç¨‹å°±å¯ä»¥ã€‚</li>
<li>Sensor Managerã€‚åœ¨Activityç»“æŸæ—¶æ³¨é”€ç›‘å¬å™¨ã€‚</li>
</ul>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a><strong>å‚è€ƒ</strong></h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/ac00e370f83d">https://www.jianshu.com/p/ac00e370f83d</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.nimbledroid.com/2016/09/06/stop-memory-leaks.html">https://blog.nimbledroid.com/2016/09/06/stop-memory-leaks.html</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhangliangnbu.github.io/2021/06/30/Android%E4%B8%AD%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AE%9E%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="ç« äº®">
      <meta itemprop="description" content="Developer For Android">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ°¸æ’çš„ç æµ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/30/Android%E4%B8%AD%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AE%9E%E7%8E%B0/" class="post-title-link" itemprop="url">Androidä¸­å¤šçº¿ç¨‹å®ç°</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-06-30 15:42:53 / ä¿®æ”¹æ—¶é—´ï¼š15:48:36" itemprop="dateCreated datePublished" datetime="2021-06-30T15:42:53+08:00">2021-06-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">Androidå¼€å‘</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>Androidä¸­æ¶‰åŠçº¿ç¨‹æ“ä½œçš„ç±»æˆ–æœºåˆ¶ä¸»è¦æœ‰ï¼š</p>
<ul>
<li>Threadã€‚çº¿ç¨‹æ“ä½œçš„æœ€åŸºæœ¬çš„ç±»ã€‚</li>
<li>ThreadPoolExecutorã€‚åŸºäºçº¿ç¨‹æ± ï¼Œå¤„ç†å¹¶å‘å¤šçº¿ç¨‹æ“ä½œã€‚</li>
<li>Handleræœºåˆ¶ï¼šHandlerã€Looperã€MessageQueueç­‰ã€‚Androidä¸­å¤šçº¿ç¨‹å¤„ç†çš„åŸºæœ¬æœºåˆ¶ã€‚</li>
<li>HandlerThreadã€‚Threadçš„å­ç±»ï¼Œç»´æŠ¤äº†ä¸€ä¸ªLooperï¼ŒHandleræœºåˆ¶çš„è¾…åŠ©ç±»ã€‚</li>
<li>AsyncTaskã€‚åŸºäºHandleræœºåˆ¶ã€‚</li>
<li>IntentServiceã€‚åŸºäºHandleræœºåˆ¶ã€‚</li>
</ul>
<h1 id="Handleræœºåˆ¶"><a href="#Handleræœºåˆ¶" class="headerlink" title="Handleræœºåˆ¶"></a>Handleræœºåˆ¶</h1><p>Handler å‘æ¶ˆæ¯åˆ°MessageQueueä¸­ï¼ŒLooper å¾ªç¯ä»MessageQueueä¸­è·å–æ¶ˆæ¯å¹¶æ¶ˆè´¹ï¼ˆæ‰§è¡ŒHandlerçš„å›è°ƒæ–¹æ³•ï¼‰ã€‚</p>
<p>ä»¥çº¿ç¨‹Bå‘çº¿ç¨‹Aå‘æ¶ˆæ¯ä¸ºä¾‹ï¼Œä»æ—¶é—´é¡ºåºä¸Šè¯´æ˜å¦‚ä¸‹ï¼š</p>
<ul>
<li>åœ¨çº¿ç¨‹Aä¸­ï¼Œåˆ›å»ºLooperï¼Œé€šè¿‡sThreadLocalä¸å½“å‰ç»‘å®šï¼Œå¯åŠ¨Looperçš„æ¶ˆæ¯å¾ªç¯ï¼Œçº¿ç¨‹å¤„äºæ´»è·ƒçŠ¶æ€ï¼›åˆ›å»ºHandlerï¼Œåœ¨Looperè¿›è¡Œæ¶ˆæ¯å¾ªç¯ä¹‹å‰åˆ›å»ºï¼ŒHandlerä¼šä¸å½“å‰çº¿ç¨‹çš„Looperå»ºç«‹è”ç³»ã€‚</li>
<li>åœ¨çº¿ç¨‹Bä¸­ï¼Œä½¿ç”¨ä¸Šé¢çš„Handlerå‘é€æ¶ˆæ¯ã€‚</li>
<li>åœ¨çº¿ç¨‹Aä¸­ï¼ŒLooperå¾ªç¯æ¶ˆæ¯è·å–æ¶ˆæ¯ï¼Œç”±äºæ¶ˆæ¯æŒæœ‰Handlerå¼•ç”¨ï¼Œæœ€ç»ˆä¼šæ‰§è¡ŒHandlerçš„å›è°ƒæ–¹æ³•ã€‚</li>
</ul>
<p>ä»£ç ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>  Handler handler;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºçº¿ç¨‹A ã€Looperã€Handler</span></span><br><span class="line">    Thread threadA = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">        Looper.prepare();</span><br><span class="line">        <span class="comment">// åˆ›å»º Handlerã€‚</span></span><br><span class="line">        handler = <span class="keyword">new</span> Handler() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(<span class="meta">@NonNull</span> Message msg)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">super</span>.handleMessage(msg);</span><br><span class="line">                Log.d(<span class="string">&quot;handleMessage&quot;</span>, <span class="string">&quot;msg what == &quot;</span> + msg.what);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        Looper.loop();</span><br><span class="line">    &#125;);</span><br><span class="line">    threadA.start();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºçº¿ç¨‹Bï¼Œå¹¶åˆ©ç”¨Handler å‘é€æ¶ˆæ¯</span></span><br><span class="line">    Thread threadB = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">        <span class="comment">// é˜²æ­¢ThreadAæ²¡æœ‰æ‰§è¡Œå®Œè€Œå¯¼è‡´handlerä¸ºç©º</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        handler.sendEmptyMessage(<span class="number">111</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    threadB.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼šåˆ›å»ºHandleræœ‰å¤šç§æ–¹å¼ï¼Œä»¥ç»‘å®šçº¿ç¨‹Açš„Looperä¸ºä¾‹ï¼š</p>
<ul>
<li>åœ¨<code>Looper.prepare()</code>å’Œ<code>Looper.loop()</code> ä¹‹é—´åˆ›å»ºï¼Œ<code>handler = new Handler()</code>ã€‚Androidä¸­ä¸»çº¿ç¨‹çš„ç¬¬ä¸€ä¸ªHandlerå°±æ˜¯å¦‚æ­¤åˆ›å»ºã€‚</li>
<li>åœ¨çº¿ç¨‹Açš„æŸä¸ªHandlerçš„å›è°ƒæ¶ˆæ¯ä¸­åˆ›å»ºï¼Œ<code>handler = new Handler()</code>ã€‚ä¸€èˆ¬å¼€å‘æ—¶åœ¨Activityé‡Œåˆ›å»ºçš„Handlerå°±å±äºè¿™ç§æƒ…å†µã€‚</li>
<li>åœ¨å…¶ä»–çº¿ç¨‹ä¸­ç›´æ¥åˆ©ç”¨ä¸çº¿ç¨‹Aç»‘å®šçš„Looperè¿›è¡Œåˆ›å»ºï¼Œ<code>handler = new Handler(looper)</code>ã€‚IntentServiceé‡Œä½¿ç”¨HandlerThreadï¼Œå±äºè¿™ç§æƒ…å†µã€‚</li>
</ul>
<h1 id="HandlerThread"><a href="#HandlerThread" class="headerlink" title="HandlerThread"></a>HandlerThread</h1><p><code>Thread</code>çš„å­ç±»ï¼Œç»´æŠ¤äº†ä¸€ä¸ª<code>Looper</code>ï¼Œåœ¨<code>run()</code>ä¸­åˆ›å»º<code>Looper</code>å®ä¾‹ã€ä¸çº¿ç¨‹ç»‘å®šï¼Œå¼€å¯æ¶ˆæ¯å¾ªç¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mTid = Process.myTid();</span><br><span class="line">		<span class="comment">// </span></span><br><span class="line">    Looper.prepare();</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        mLooper = Looper.myLooper();</span><br><span class="line">        notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line">    Process.setThreadPriority(mPriority);</span><br><span class="line">    onLooperPrepared();</span><br><span class="line">    Looper.loop();</span><br><span class="line">    mTid = -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸€èˆ¬ä½¿ç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºçº¿ç¨‹A ã€Looper</span></span><br><span class="line">HandlerThread threadA = <span class="keyword">new</span> HandlerThread(<span class="string">&quot;handler thread a&quot;</span>);</span><br><span class="line">threadA.start();</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºHandler.</span></span><br><span class="line"><span class="comment">// threadA.getLooper() ä¸­ä½¿ç”¨äº†wait()ï¼Œä¿è¯looperä¸ä¸ºç©º</span></span><br><span class="line">handler = <span class="keyword">new</span> Handler(threadA.getLooper()) &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(<span class="meta">@NonNull</span> Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.handleMessage(msg);</span><br><span class="line">        Log.d(<span class="string">&quot;handleMessage&quot;</span>, <span class="string">&quot;msg what == &quot;</span> + msg.what);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºçº¿ç¨‹Bï¼Œå¹¶åˆ©ç”¨Handler å‘é€æ¶ˆæ¯</span></span><br><span class="line">Thread threadB = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">    handler.sendEmptyMessage(<span class="number">111</span>);</span><br><span class="line">&#125;);</span><br><span class="line">threadB.start();</span><br></pre></td></tr></table></figure>

<h1 id="AsyncTask"><a href="#AsyncTask" class="headerlink" title="AsyncTask"></a>AsyncTask</h1><p>åŸºäºHandleræœºåˆ¶ã€‚åœ¨å·¥ä½œçº¿ç¨‹æ‰§è¡Œä»»åŠ¡<code>doInBackground</code>ï¼Œé€šè¿‡Handlerå‘é€æ¶ˆæ¯åˆ°uiçº¿ç¨‹ï¼Œæ›´æ–°è¿›åº¦<code>onProgressUpdate</code>å’Œç»“æœ<code>onPostExecute</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAsyncTask</span> <span class="keyword">extends</span> <span class="title">AsyncTask</span>&lt;<span class="title">String</span>, <span class="title">Integer</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPreExecute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// on ui thread</span></span><br><span class="line">        <span class="keyword">super</span>.onPreExecute();</span><br><span class="line">        Log.d(<span class="string">&quot;MyAsyncTask&quot;</span>, <span class="string">&quot;onPreExecute&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">doInBackground</span><span class="params">(String... strings)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// on work thread</span></span><br><span class="line">        publishProgress(<span class="number">0</span>);</span><br><span class="line">        Log.d(<span class="string">&quot;MyAsyncTask&quot;</span>, <span class="string">&quot;doInBackground ==&quot;</span> + Arrays.toString(strings));</span><br><span class="line">        publishProgress(<span class="number">100</span>);</span><br><span class="line">        <span class="keyword">return</span> Arrays.toString(strings);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// on ui thread</span></span><br><span class="line">        <span class="keyword">super</span>.onPostExecute(s);</span><br><span class="line">        Log.d(<span class="string">&quot;MyAsyncTask&quot;</span>, <span class="string">&quot;onPostExecute ==&quot;</span> + s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onProgressUpdate</span><span class="params">(Integer... values)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// on ui thread</span></span><br><span class="line">        <span class="keyword">super</span>.onProgressUpdate(values);</span><br><span class="line">        Log.d(<span class="string">&quot;MyAsyncTask&quot;</span>, <span class="string">&quot;onProgressUpdate ==&quot;</span> + Arrays.toString(values));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAsyncTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    MyAsyncTask asyncTask = <span class="keyword">new</span> MyAsyncTask();</span><br><span class="line">    asyncTask.execute(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="IntentService"><a href="#IntentService" class="headerlink" title="IntentService"></a>IntentService</h1><p>åŸºäºHandlerï¼Œç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate();</span><br><span class="line">    HandlerThread thread = <span class="keyword">new</span> HandlerThread(<span class="string">&quot;IntentService[&quot;</span> + mName + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    thread.start();</span><br><span class="line"></span><br><span class="line">    mServiceLooper = thread.getLooper();</span><br><span class="line">    mServiceHandler = <span class="keyword">new</span> ServiceHandler(mServiceLooper);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">(<span class="meta">@Nullable</span> Intent intent, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">    Message msg = mServiceHandler.obtainMessage();</span><br><span class="line">    msg.arg1 = startId;</span><br><span class="line">    msg.obj = intent;</span><br><span class="line">    mServiceHandler.sendMessage(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhangliangnbu.github.io/2021/06/29/Java%E9%9B%86%E5%90%88%E4%B8%AD%E5%85%83%E7%B4%A0%E5%88%A0%E9%99%A4%E6%96%B9%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="ç« äº®">
      <meta itemprop="description" content="Developer For Android">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ°¸æ’çš„ç æµ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/29/Java%E9%9B%86%E5%90%88%E4%B8%AD%E5%85%83%E7%B4%A0%E5%88%A0%E9%99%A4%E6%96%B9%E5%BC%8F/" class="post-title-link" itemprop="url">Javaé›†åˆä¸­å…ƒç´ åˆ é™¤æ–¹å¼</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-06-29 12:03:45 / ä¿®æ”¹æ—¶é—´ï¼š16:30:42" itemprop="dateCreated datePublished" datetime="2021-06-29T12:03:45+08:00">2021-06-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>åˆ é™¤é›†åˆä¸­çš„å…ƒç´ ï¼Œæœ‰ä¸¤ç§åˆ é™¤çš„å½¢å¼ï¼Œä¸€ç§æ˜¯åˆ é™¤ç‰¹å®šå…ƒç´ ï¼Œä¸€ç§æ˜¯åˆ é™¤ç‰¹å®šç´¢å¼•çš„å…ƒç´ ã€‚</p>
<p>åˆ é™¤çš„æ–¹å¼æœ‰ï¼šä½¿ç”¨Java API ï¼ˆjava 8ï¼‰ã€ä»åå¾€å‰çš„å¾ªç¯ã€ä½¿ç”¨è¿­ä»£å™¨ã€ä½¿ç”¨æ–°çš„é›†åˆã€‚</p>
<h1 id="Java-API"><a href="#Java-API" class="headerlink" title="Java API"></a>Java API</h1><ul>
<li><code>List#remove(int index)</code>ã€‚æœ€åŸºæœ¬APIï¼Œåˆ é™¤ç‰¹å®šç´¢å¼•å¤„å…ƒç´ ï¼ŒO(1)ã€‚</li>
<li><code>List#remove(Object o)</code>ã€‚ä»å‰å¾€åéå†ï¼Œç§»é™¤ç¬¬ä¸€ä¸ªä¸ <code>o</code> ç›¸ç­‰çš„å…ƒç´ ï¼ŒO(n)ã€‚</li>
<li><code>Collection#removeIf(Predicate&lt;? super E&gt; filter)</code>ã€‚ç§»é™¤æ‰€æœ‰ç‰¹å®šå…ƒç´ ï¼Œå†…éƒ¨ä½¿ç”¨è¿­ä»£å™¨ï¼›Java 8ï¼›O(n)ã€‚</li>
<li><code>ArrayList#removeIf(Predicate&lt;? super E&gt; filter)</code>ã€‚ç§»é™¤æ‰€æœ‰ç‰¹å®šå…ƒç´ ï¼Œå†…éƒ¨ä½¿ç”¨<code>BitSet</code>æ ‡è®°å¾…åˆ é™¤å…ƒç´ ï¼›Java 8ï¼›O(n)ã€‚</li>
<li><code>List#subList(startIndex, endIndex).clear()</code>ã€‚åˆ é™¤ç‰¹å®šç´¢å¼•åŒºé—´çš„å…ƒç´ ï¼ŒO(n)ã€‚</li>
</ul>
<blockquote>
<p><code>BitSet</code>åˆ©ç”¨<code>long</code>æ•°ç»„æ¥ç»´æŠ¤è‡ªèº«ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªé•¿æ•´å‹ä»£è¡¨64ä¸ªä½å…ƒç´ ï¼Œæ¯ä¸ªå…ƒç´ çš„å€¼ä¸º<code>True</code>æˆ–<code>False</code>ã€‚å¸¸ç”¨äºæ ‡è®°å…¶ä»–é›†åˆã€‚</p>
</blockquote>
<h1 id="ä»åå¾€å‰å¾ªç¯"><a href="#ä»åå¾€å‰å¾ªç¯" class="headerlink" title="ä»åå¾€å‰å¾ªç¯"></a>ä»åå¾€å‰å¾ªç¯</h1><p>é€‚ç”¨ä¸¤ç§å½¢å¼ï¼šåˆ é™¤ç‰¹å®šå…ƒç´ ï¼Œä»¥åŠåˆ é™¤ç‰¹å®šç´¢å¼•çš„å…ƒç´ ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ é™¤æ‰€æœ‰ç‰¹å®šå…ƒç´ </span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> index = list.size() - <span class="number">1</span>; index &gt;= <span class="number">0</span>; index --) &#123;</span><br><span class="line">    Object element = list.get(index);</span><br><span class="line">    <span class="keyword">if</span> (special.equals(element)) &#123;</span><br><span class="line">        list.remove(index);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ é™¤å¤šä¸ªç‰¹å®šç´¢å¼•çš„å…ƒç´  æ¯”å¦‚ï¼Œåˆ é™¤ç´¢å¼•åœ¨[start, end]å†…çš„å…ƒç´ </span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> index = end; index &gt;= start; index --) &#123;</span><br><span class="line">    list.remove(index);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="ä½¿ç”¨è¿­ä»£å™¨"><a href="#ä½¿ç”¨è¿­ä»£å™¨" class="headerlink" title="ä½¿ç”¨è¿­ä»£å™¨"></a>ä½¿ç”¨è¿­ä»£å™¨</h1><p>é€‚ç”¨åˆ é™¤ç‰¹å®šå…ƒç´ ï¼›éƒ¨åˆ†ï¼ˆå…ƒç´ å¯æ ‡è®°ï¼‰é€‚ç”¨åˆ é™¤ç‰¹å®šç´¢å¼•å…ƒç´ ï¼Œå…ˆæ ‡è®°å†è¿­ä»£åˆ é™¤ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ é™¤æ‰€æœ‰ç‰¹å®šå…ƒç´ </span></span><br><span class="line">Iterator&lt;Integer&gt; iterator = list.listIterator();</span><br><span class="line"><span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">    Integer element = iterator.next();</span><br><span class="line">    <span class="keyword">if</span> (special.equals(element)) &#123;</span><br><span class="line">        iterator.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ é™¤ç‰¹å®šç´¢å¼•å…ƒç´ ï¼Œå…ƒç´ å¯æ ‡è®°ï¼Œæ¯”å¦‚å…ƒç´ é‡Œçš„IDä¸èƒ½ä¸ºè´Ÿæ•°ï¼Œæ ‡è®°ä¸ºè´Ÿæ•°å³ä¸ºå¾…åˆ é™¤å…ƒç´ </span></span><br><span class="line"><span class="comment">// æ¯”å¦‚åˆ é™¤ç´¢å¼•åœ¨[start, end]ä¸­çš„æ•´æ•°ï¼Œå¦‚æœé›†åˆä¸ä¸ºè´Ÿæ•°ï¼Œåˆ™å¯ä»¥æ ‡è®°å¾…åˆ é™¤å…ƒç´ ä¸ºè´Ÿæ•°ã€‚</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> index = start; index &lt;= end; index ++) &#123;</span><br><span class="line">    list.set(index, Integer.MIN_VALUE);</span><br><span class="line">&#125;</span><br><span class="line">Iterator&lt;Integer&gt; iterator = list.listIterator();</span><br><span class="line"><span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">    Integer element = iterator.next();</span><br><span class="line">    <span class="keyword">if</span> (element == Integer.MIN_VALUE) &#123;</span><br><span class="line">        iterator.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="ä½¿ç”¨æ–°çš„é›†åˆ"><a href="#ä½¿ç”¨æ–°çš„é›†åˆ" class="headerlink" title="ä½¿ç”¨æ–°çš„é›†åˆ"></a>ä½¿ç”¨æ–°çš„é›†åˆ</h1><p>åˆ›å»ºæ–°çš„é›†åˆï¼Œå¾ªç¯å°†æ—§é›†åˆä¸­æœ‰æ•ˆå…ƒç´ æ·»åŠ åˆ°æ–°é›†åˆä¸­ã€‚åœ¨å®è·µä¸­ä¹Ÿè¾ƒå¸¸ç”¨ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å®è·µä¸­ï¼Œå„ç§æ–¹æ³•çš„å¤æ‚åº¦éƒ½ç›¸åŒï¼Œä½¿ç”¨æ–°çš„é›†åˆéœ€è¦é¢å¤–çš„ç©ºé—´ï¼Œå¦‚æœé›†åˆæ¯”è¾ƒå¤§åˆ™æ•ˆç‡è¾ƒä½ã€‚</p>
<p>ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨APIï¼Œä¸èƒ½æ»¡è¶³çš„æƒ…å†µä¸‹å†è€ƒè™‘å‘å‰å¾ªç¯ã€è¿­ä»£æˆ–åˆ›å»ºæ–°çš„é›†åˆã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhangliangnbu.github.io/2019/11/15/android-tbs-problem/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="ç« äº®">
      <meta itemprop="description" content="Developer For Android">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ°¸æ’çš„ç æµ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/15/android-tbs-problem/" class="post-title-link" itemprop="url">Androidé›†æˆTBSå¡«å‘è®°å½•</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-11-15 09:01:50" itemprop="dateCreated datePublished" datetime="2019-11-15T09:01:50+08:00">2019-11-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-06-29 14:12:44" itemprop="dateModified" datetime="2021-06-29T14:12:44+08:00">2021-06-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">Androidå¼€å‘</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æœ€è¿‘å¾—ç©ºï¼Œè®°å½•ä¸‹è¿™å‡ æœˆAndroidå¼€å‘ä¸­é‡åˆ°çš„å‘ã€‚</p>
<p>è¿™ç¯‡æ–‡ç« ä¸»è¦è®°å½•é›†æˆè…¾è®¯æµè§ˆæœåŠ¡ï¼ˆTBS Tencent Browse Serverï¼‰æ—¶é‡åˆ°çš„é—®é¢˜ä»¥åŠè§£å†³æ–¹æ¡ˆã€‚</p>
<hr>
<h1 id="é—®é¢˜ï¼šH5åŠ è½½å¼‚å¸¸"><a href="#é—®é¢˜ï¼šH5åŠ è½½å¼‚å¸¸" class="headerlink" title="é—®é¢˜ï¼šH5åŠ è½½å¼‚å¸¸"></a>é—®é¢˜ï¼šH5åŠ è½½å¼‚å¸¸</h1><p><strong>å…·ä½“æƒ…å†µ</strong></p>
<p>æˆ‘åœ¨å…¬å¸å†…ç½‘ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨å‡ ä¸ªæµ‹è¯•æœºï¼Œæœ‰çš„å¯ä»¥æ­£å¸¸åŠ è½½ï¼Œæœ‰çš„åˆ™åŠ è½½å¤±è´¥ã€‚æˆ‘çš„æ¥å…¥æ­¥éª¤çš†æ˜¯æŒ‰ç…§å®˜æ–¹æ¥å…¥æ–‡æ¡£ä»¥åŠDemoåšçš„ï¼Œæ£€æŸ¥äº†å‡ éï¼Œè®¤ä¸ºæ¥å…¥æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚</p>
<p><strong>è§£å†³</strong></p>
<p>ç»“è®ºï¼šä¸€æ˜¯æ¢å¤–ç½‘ï¼›äºŒæ˜¯åœ¨å…¥å£Activityé‡Œè¯·æ±‚å¤–éƒ¨è¯»å†™æƒé™å¹¶åˆå§‹åŒ–<code>QbSdk.initX5Environment(context, callback)</code>ã€‚</p>
<p>åˆ†æï¼šè¦æ˜ç™½TBSåœ¨åˆå§‹åŒ–çš„æ—¶å€™åšçš„äº‹æƒ…ã€‚Tbs sdkæœ‰ä¸€ä¸ªåˆå§‹åŒ–çš„æ–¹æ³•<code>QbSdk.initX5Environment(context, callback)</code>ï¼ŒæŒ‰ç…§å®˜æ–¹Demoï¼Œæ˜¯æ”¾ç½®äº<code>Application.onCreate()</code>ä¸­ã€‚è¿™ä¸ªæ–¹æ³•é¦–å…ˆä¼šæ£€æµ‹åˆ°sdcardé‡Œæ˜¯å¦æœ‰x5å†…æ ¸æ‰€åœ¨çš„æ–‡ä»¶å¤¹ï¼Œæœ‰çš„è¯å°±ä¼šåŠ è½½å†…æ ¸ï¼Œå¦‚æœæ–‡ä»¶å¤¹ä¸ºç©ºåˆ™åŠ è½½å¤±è´¥ï¼Œæ€»ä¹‹ä¸ä¼šå»ä¸‹è½½ å†…æ ¸ï¼›å¦‚æœæ£€æµ‹åˆ°æ²¡æœ‰ç›¸å…³æ–‡ä»¶å¤¹ï¼Œåˆ™ä¼šä¸‹è½½å†…æ ¸ã€‚ä¸€èˆ¬å®‰è£…äº†è…¾æ—­ç³»çš„APPï¼Œåœ¨sdcardé‡Œéƒ½ä¼šæœ‰ç›¸å¯¹åº”çš„å†…æ ¸åŠæ–‡ä»¶å¤¹ã€‚</p>
<p>x5å†…æ ¸çš„ä¸‹è½½èµ°å¤–ç½‘ï¼Œå› æ­¤ç”¨å…¬å¸å†…ç½‘æµ‹è¯•æ—¶æ˜¯ä¸å¯èƒ½ä¸‹è½½æˆåŠŸçš„ã€‚ä¹‹å‰æœ‰çš„æœºå™¨èƒ½åœ¨æµ‹è¯•ç¯å¢ƒä¸‹é€šè¿‡ï¼Œæ˜¯å› ä¸ºå…¶sdcardä¸­å·²ç»å­˜åœ¨å†…æ ¸äº†ï¼Œæˆ–è€…æ˜¯ä¹‹å‰ä¸‹è½½çš„ï¼Œæˆ–è€…æ˜¯ç”±äºå®‰è£…äº†å…¶ä»–è…¾è®¯ç³»APPã€‚</p>
<p>åœ¨å¤–ç½‘ä¸‹æµ‹è¯•ï¼Œéƒ¨åˆ†æµ‹è¯•æœºä¾æ—§å¶å°”ä¸èƒ½åŠ è½½x5å†…æ ¸ã€‚è¿™æ˜¯å› ä¸ºåˆå§‹åŒ–æ˜¯åœ¨<code>Application.onCreate()</code>ä¸­çš„ï¼Œæ­¤æ—¶å¹¶æ²¡æœ‰è¯»å†™æƒé™ï¼Œæ‰€ä»¥æ¯æ¬¡éƒ½è¦ä¸‹è½½ï¼Œä½†å®Œå…¨ä¸‹è½½æˆåŠŸéœ€è¦ä¸€å®šçš„æ—¶é—´ï¼Œå› æ­¤å¦‚æœå¿«é€Ÿæ‰“å¼€H5é¡µé¢ï¼Œæ­¤æ—¶x5å†…æ ¸æ²¡æœ‰å®Œå…¨ä¸‹è½½å®Œæˆï¼Œå°±ä¼šå‡ºç°åŠ è½½å¤±è´¥ã€‚</p>
<hr>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul>
<li><a target="_blank" rel="noopener" href="https://x5.tencent.com/">TBSå®˜ç½‘</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ç« äº®"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">ç« äº®</p>
  <div class="site-description" itemprop="description">Developer For Android</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">55</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">52</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zhangliangnbu" title="GitHub â†’ https://github.com/zhangliangnbu" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhangliangnbu@qq.com" title="E-Mail â†’ mailto:zhangliangnbu@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ç« äº®</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">210k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">3:11</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> å¼ºåŠ›é©±åŠ¨
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
