<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zhangliangnbu.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Developer For Android">
<meta property="og:type" content="website">
<meta property="og:title" content="永恒的码流">
<meta property="og:url" content="https://zhangliangnbu.github.io/page/5/index.html">
<meta property="og:site_name" content="永恒的码流">
<meta property="og:description" content="Developer For Android">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="章亮">
<meta property="article:tag" content="Andriod">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://zhangliangnbu.github.io/page/5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>永恒的码流</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">永恒的码流</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">万物皆流，无物常驻</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhangliangnbu.github.io/2018/10/22/android-build-05-gradle-practise/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="章亮">
      <meta itemprop="description" content="Developer For Android">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="永恒的码流">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/10/22/android-build-05-gradle-practise/" class="post-title-link" itemprop="url">Android构建05-Gradle最佳实践</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-10-22 09:09:26" itemprop="dateCreated datePublished" datetime="2018-10-22T09:09:26+08:00">2018-10-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-29 14:24:03" itemprop="dateModified" datetime="2021-06-29T14:24:03+08:00">2021-06-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">Android开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="文件分布简述"><a href="#文件分布简述" class="headerlink" title="文件分布简述"></a>文件分布简述</h1><p>详情请见官方文档<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/directory_layout.html">Directory Layout</a>。</p>
<p>之前官方文档并没有这方面的说明，现在却单独用一个章节来做说明，可能考虑到许多开发者都遇到过这方面的疑惑吧：项目的依赖包在哪里？我去掉了项目里<code>gradle.properties</code>和IDE（如Android Studio）里的代理设置之后，会什么代理还会生效？等等。</p>
<p>Gradle相关文件包括Wrapper文件、Gradle各版本包、依赖包等。它们并不都存放在项目目录里，如依赖包，你在项目根目录下是找不到的。</p>
<p>Gradle相关文件分布在两个地方：</p>
<ol>
<li>项目根目录。这个目录下的gradle相关文件只对当前项目生效。包括Wrapper配置和可执行命令文件、项目的<code>gradle.properties</code>、<code>build.gradle</code>等构建和配置文件。</li>
<li>用户目录。<code>$USER_HOME/.gradle</code>，macOS中执行<code>$ cd ~/.gradle</code>即可进入，该目录下的配置对所有的项目生效。包括配置文件<code>gradle.properties</code>、Gradle各版本<code>wrapper/dists/</code>、项目依赖包<code>~/.gradle/caches/modules-2/files-2.1/</code>等。</li>
</ol>
<hr>
<br>



<h1 id="问题排查"><a href="#问题排查" class="headerlink" title="问题排查"></a>问题排查</h1><p><strong>获取帮助</strong></p>
<ol>
<li><a target="_blank" rel="noopener" href="https://discuss.gradle.org/c/help-discuss">Gradle Forums</a>。更新缓慢，回复率很低。</li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/tagged/gradle">StackOverflow #gradle</a> 。在StackOverFlow上一般能找到所需要的解答。</li>
<li><a target="_blank" rel="noopener" href="https://help.gradle.org/">help.gradle.org</a>。没用过，估计和Gradle论坛一样吧。</li>
</ol>
<p><strong>安装问题</strong></p>
<p>详情请见官网<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/troubleshooting.html#sec:troubleshooting_installation">Troubleshooting Gradle installation</a>，按照官网的教程安装，一般没有什么问题。</p>
<p><strong>定位一般构建问题</strong></p>
<ol>
<li>执行<code>$ ./gradlew [task name] -s</code>。打印栈信息，一般可以定位问题出现在哪里，否则执行下一步操作。</li>
<li>执行<code>$ ./gradlew assembleDebug -d &gt; gradle.log </code>。打印所有的构建信息到<code>gradle.log </code>文件，通过搜索<code>WARNING</code>或<code>ERROR</code>定位错误。</li>
</ol>
<p><strong>依赖解析问题</strong></p>
<p>参考官网<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/troubleshooting_dependency_resolution.html">Troubleshooting Dependency Resolution</a>，补充如下：</p>
<ol>
<li>版本冲突。升级低版本或在某个依赖里排除掉(<code>exclude</code>)低版本。</li>
<li>依赖下载失败。一般会报错<code>Could not resolve xxx....xxxx timed out</code>，有以下两种解决方法：<ul>
<li>设置HTTP代理或国内镜像仓库。HTTP代理可在<code>$USER_HOME/.gradle/gradle.properties</code>或项目根目录<code>gradle.properties</code>里设置。镜像仓库可使用<a target="_blank" rel="noopener" href="http://maven.aliyun.com/mvn/view">阿里云的仓库</a>，包括google、Maven Central和jcenter等的镜像仓库。</li>
<li>下载依赖并从缓存执行构建。从官网下载依赖并放在缓存(<code>$USER_HOME/.gradle/caches/jars-3或modules-2</code>)里，然后使用命令行构建时添加<code>--offline</code>可选项。</li>
</ul>
</li>
</ol>
<hr>
<br>



<h1 id="代理设置"><a href="#代理设置" class="headerlink" title="代理设置"></a>代理设置</h1><p>Gradle的代理一般用于解决Gradle版本和依赖下载失败的问题，代理参数可以设置在两个地方：</p>
<ul>
<li>项目根目录下的<code>gradle.properties</code>。仅对当前项目生效。</li>
<li>用户目录下的<code>$USER_HOME/.gradle/gradle.properties</code>。对所有的Gradle项目生效。</li>
</ul>
<p>我的代理策略是使用<a target="_blank" rel="noopener" href="https://www.privoxy.org/">Privoxy</a>做HTTP代理，再让Privoxy监听Shadowsocks端口，真正实现代理的是本地Shadowsocks与远程代理服务中Shadowsocks的通信。</p>
<blockquote>
<p>因为Shadowsocks走的是Socks协议，而有些资源一定需要HTTP代理才生效，故需要使用Privoxy做一下转换。</p>
</blockquote>
<p>我一般的做法是在<code>$USER_HOME/.gradle/gradle.properties</code>下设置代理，代理参数及说明如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https代理</span></span><br><span class="line"><span class="comment"># 代理主机地址。本地，因为是先要走本地Privoxy。</span></span><br><span class="line"><span class="meta">systemProp.https.proxyHost</span>=<span class="string">127.0.0.1</span></span><br><span class="line"><span class="comment"># 代理端口号。Privoxy的端口号</span></span><br><span class="line"><span class="meta">systemProp.https.proxyPort</span>=<span class="string">8118</span></span><br><span class="line"><span class="comment"># 不走代理的地址。公司内部Maven库、内网、本地、阿里云OSS文件服务、个推、eclipse资源等，不用走代理，否则连接缓慢或者失败</span></span><br><span class="line"><span class="meta">systemProp.https.nonProxyHosts</span>=<span class="string">maven.xxxx.com|192.168.*|localhost|oss.sonatype.org|mvn.gt.igexin.com|repo.eclipse.org</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># http代理。与https代理参数一直。</span></span><br><span class="line"><span class="meta">systemProp.http.proxyHost</span>=<span class="string">127.0.0.1</span></span><br><span class="line"><span class="meta">systemProp.http.proxyPort</span>=<span class="string">8118</span></span><br><span class="line"><span class="meta">systemProp.http.nonProxyHosts</span>=<span class="string">maven.xxxx.com|192.168.*|localhost|oss.sonatype.org|mvn.gt.igexin.com|repo.eclipse.org</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>IDE以Andorid Studio 为例，其代理设置（在<code>Preferences-&gt;System Settings-&gt;HTTP Proxy</code>中）仅仅对IDE更新、下载SDK等生效，不会影响到Gradle构建时下载依赖。</p>
<p>需要注意的是，Andorid Studio中设置了代理后，一般会弹出对话框，问是否要把Studio的代理设置到用户目录下的<code>$USER_HOME/.gradle/gradle.properties</code>中，如果你点击了确定，则Studio会把自己的代理配置更新到用户目录的<code>gradle.properties</code>文件中，这样代理就对Gradle生效了。一般不建议点确定，因为Studio和Gradle的代理的资源不一样，配置也会不一致，有时候一个可能需要代理，而另一个却不需要代理。</p>
<p>IDE和Gradle的代理应该分别配置。</p>
</blockquote>
<hr>
<br>



<h1 id="待续"><a href="#待续" class="headerlink" title="待续"></a>待续</h1><p>撰写可维护的构建脚本</p>
<p><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/authoring_maintainable_build_scripts.html">Authoring Maintainable Build Scripts</a></p>
<p>搭建Gradle项目</p>
<p><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/organizing_gradle_projects.html">Organizing Gradle Projects</a></p>
<p>提高构建性能</p>
<p><a target="_blank" rel="noopener" href="https://guides.gradle.org/performance/">Improving the Performance of Gradle Builds</a></p>
<p>使用缓存</p>
<p><a target="_blank" rel="noopener" href="https://guides.gradle.org/using-build-cache/">https://guides.gradle.org/using-build-cache/</a></p>
<hr>
<br>

<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/troubleshooting.html">Troubleshooting</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/troubleshooting_dependency_resolution.html">Troubleshooting Dependency Resolution</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhangliangnbu.github.io/2018/10/21/2018-10-21-%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0-%E7%90%86%E8%A7%A3FileProvider/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="章亮">
      <meta itemprop="description" content="Developer For Android">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="永恒的码流">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/10/21/2018-10-21-%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0-%E7%90%86%E8%A7%A3FileProvider/" class="post-title-link" itemprop="url">理解FileProvider</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2018-10-21 11:53:40 / 修改时间：17:52:48" itemprop="dateCreated datePublished" datetime="2018-10-21T11:53:40+08:00">2018-10-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">Android开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>用于更安全地在APP之间实现文件共享的一种机制，适用于Android 7.0及以上。</p>
<p>当应用A（如相册）允许其他应用（以应用B为例）调用自己并获取自己的文件时，应用A需要使用<code>FileProvider</code>来转化自己的文件路径为<code>content://Uri</code>，并提供给需要文件的应用B。其中</p>
<ol>
<li>Android 7.0以上如果不使用<code>FileProvider</code>，应用A将返回<code>file:///</code> <code>Uri</code>，而报错。</li>
<li>返回的<code>content://Uri</code>有生命周期，即应用B接收文件的<code>Activity</code>的生命周期，如果这个<code>Activity</code>被销毁了，则返回的<code>content://Uri</code>也将失效而不能获取文件。</li>
</ol>
<hr>
<br>



<h1 id="场景-从相册获取图片"><a href="#场景-从相册获取图片" class="headerlink" title="场景-从相册获取图片"></a>场景-从相册获取图片</h1><p>这是经常遇到的场景。当我们的APP（开发者APP）需要从相册获取图片时，一般使用如下代码</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getPicture</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> intent = Intent()</span><br><span class="line">    intent.type = <span class="string">&quot;image/*&quot;</span></span><br><span class="line">    intent.action = Intent.ACTION_GET_CONTENT</span><br><span class="line">    intent.putExtra(Intent.EXTRA_ALLOW_MULTIPLE, <span class="literal">true</span>)</span><br><span class="line">    startActivityForResult(Intent.createChooser(intent, <span class="string">&quot;Select Picture&quot;</span>), REQUEST_CODE_ADD_PICTURE)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并在<code>onActivityResult</code>处理获取到Uri，但需要记住的是，这个Uri是相册应用使用<code>FileProvider</code>处理后的<code>content://Uri</code>，其获取图片的权限是暂时的。</p>
<p>这个场景中，是开发者APP从相册获取图片，无需在开发者APP中配置<code>FileProvider</code>。</p>
<hr>
<br>



<h1 id="场景-拍照"><a href="#场景-拍照" class="headerlink" title="场景-拍照"></a>场景-拍照</h1><p>开发者APP调用相机拍照并获取照片，官方文档<a target="_blank" rel="noopener" href="https://developer.android.com/training/camera/photobasics#kotlin">TakePhoto</a>对这一块有详细的说明。</p>
<p>开发者APP调用相机拍照后需要保存在一个文件中，这个文件地址由开发者APP规定。也就是说，相机在拍照后需要读写开发者APP规定的文件，那么这个时候，开发者APP就需要提供文件共享功能，这就需要用到<code>FileProvider</code>了。</p>
<p>在这个场景中，开发者APP中需要配置<code>FileProvider</code>。</p>
<hr>
<br>



<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/support/v4/content/FileProvider">FileProvider</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/training/camera/photobasics#kotlin">TakePhoto</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhangliangnbu.github.io/2018/10/20/2018-10-20-%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0-Uri%E8%BF%87%E6%9C%9F%E5%AF%BC%E8%87%B4%E5%9B%BE%E7%89%87%E4%B8%8D%E6%98%BE%E7%A4%BA%E7%9A%84%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="章亮">
      <meta itemprop="description" content="Developer For Android">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="永恒的码流">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/10/20/2018-10-20-%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0-Uri%E8%BF%87%E6%9C%9F%E5%AF%BC%E8%87%B4%E5%9B%BE%E7%89%87%E4%B8%8D%E6%98%BE%E7%A4%BA%E7%9A%84%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">Uri过期导致图片不显示的问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-10-20 09:50:22" itemprop="dateCreated datePublished" datetime="2018-10-20T09:50:22+08:00">2018-10-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2018-10-21 17:52:48" itemprop="dateModified" datetime="2018-10-21T17:52:48+08:00">2018-10-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">Android开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><p>最近做APP开发时，需要从相册选取图片后在APP的<code>PictureActivity</code>中显示，且每次都需要把获取到的图片URI缓存起来，用以下次进入页面时显示之前选择的图片。但这样偶尔会出现问题：用缓存的Uri并不能获取图片，并报错如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.lang.SecurityException: Permission Denial: opening provider com.android.providers.media.MediaDocumentsProvider from ProcessRecord&#123;9ebe048 23462:cn.com.xxxx.xxxxx/u0a209&#125; (pid=23462, uid=10209) requires android.permission.MANAGE_DOCUMENTS or android.permission.MANAGE_DOCUMENTS</span><br></pre></td></tr></table></figure>

<p><code>PictureActivity</code>相关代码如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">// </span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">addPicture</span><span class="params">()</span></span> &#123;</span><br><span class="line">       <span class="keyword">val</span> intent = Intent()</span><br><span class="line">       intent.type = <span class="string">&quot;image/*&quot;</span></span><br><span class="line">       intent.action = Intent.ACTION_GET_CONTENT</span><br><span class="line">       intent.putExtra(Intent.EXTRA_ALLOW_MULTIPLE)</span><br><span class="line">       startActivityForResult(Intent.createChooser(intent, <span class="string">&quot;Select Picture&quot;</span>), REQUEST_CODE_ADD_PICTURE)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActivityResult</span><span class="params">(requestCode: <span class="type">Int</span>, resultCode: <span class="type">Int</span>, <span class="keyword">data</span>: <span class="type">Intent</span>?)</span></span> &#123;</span><br><span class="line">       <span class="keyword">super</span>.onActivityResult(requestCode, resultCode, <span class="keyword">data</span>)</span><br><span class="line">       <span class="keyword">if</span>(REQUEST_CODE_ADD_PICTURE == requestCode) &#123;</span><br><span class="line">           <span class="comment">// cacheUri是APP全局静态变量，用于缓存到Memory里</span></span><br><span class="line">           cacheUri = <span class="keyword">data</span>?.<span class="keyword">data</span>?:<span class="keyword">return</span></span><br><span class="line">           <span class="comment">// 使用Glide显示图片</span></span><br><span class="line">           Glide.with(<span class="keyword">this</span>).load(<span class="keyword">data</span>?.<span class="keyword">data</span>).into(iv_picture)</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<br>



<h1 id="分析和解决"><a href="#分析和解决" class="headerlink" title="分析和解决"></a>分析和解决</h1><p><strong>Uri有生命周期</strong></p>
<p>查了一下官网以及相关文章，说是用Uri获取图片的权限是暂时赋予的，有生命周期，即选择图片的当前Activity的生命周期。当Activity销毁后，之前的Uri就不能用来获取图片了，否则就会上面的报错。</p>
<p>上面的例子中，我的应用从相册应用选择图片后，相册会返回图片的Uri，这些Uri获取相册图片的权限是暂时的，即只能在接收这些Uri的<code>PictureActivity</code>中使用，当<code>PictureActivity</code>销毁后，Uri权限即失效，不能用来获取图片。</p>
<p><strong>Glide有缓存</strong></p>
<p>Glide默认会有缓存，因此才会导致问题不容易复现，只是偶尔出现。去掉磁盘缓存和内存缓存后，每次回退后再次进入<code>PictureActivity</code>，就一定会复现这个问题。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Glide.with(<span class="keyword">this</span>)</span><br><span class="line">     .applyDefaultRequestOptions(RequestOptions()</span><br><span class="line">           .diskCacheStrategy(DiskCacheStrategy.NONE)</span><br><span class="line">           .skipMemoryCache(<span class="literal">true</span>))</span><br><span class="line">     .load(item).into(iv_picture)</span><br></pre></td></tr></table></figure>



<p><strong>解决</strong></p>
<p>知道问题的原因所在，就可以对症下药了。既然Uri的生命周期是短暂的，那么就不要缓存Uri了，缓存图片的绝对路径就可以了。</p>
<p>获取图片Uri后，将其转换为绝对路径形式，代码如下（参考了网上他人的代码，网上相关的代码有很多）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getFilePathByUri</span><span class="params">(Context context, Uri uri)</span> </span>&#123;</span><br><span class="line">    String path = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 以 file:// 开头的</span></span><br><span class="line">    <span class="keyword">if</span> (ContentResolver.SCHEME_FILE.equals(uri.getScheme())) &#123;</span><br><span class="line">        path = uri.getPath();</span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 以 content:// 开头的，比如 content://media/extenral/images/media/17766</span></span><br><span class="line">    <span class="keyword">if</span> (ContentResolver.SCHEME_CONTENT.equals(uri.getScheme()) &amp;&amp; Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.KITKAT) &#123;</span><br><span class="line">        Cursor cursor = context.getContentResolver().query(uri, <span class="keyword">new</span> String[]&#123;MediaStore.Images.Media.DATA&#125;, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (cursor != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cursor.moveToFirst()) &#123;</span><br><span class="line">                <span class="keyword">int</span> columnIndex = cursor.getColumnIndexOrThrow(MediaStore.Images.Media.DATA);</span><br><span class="line">                <span class="keyword">if</span> (columnIndex &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">                    path = cursor.getString(columnIndex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            cursor.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.4及之后的 是以 content:// 开头的，比如 content://com.android.providers.media.documents/document/image%3A235700</span></span><br><span class="line">    <span class="keyword">if</span> (ContentResolver.SCHEME_CONTENT.equals(uri.getScheme()) &amp;&amp; Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DocumentsContract.isDocumentUri(context, uri)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isExternalStorageDocument(uri)) &#123;</span><br><span class="line">                <span class="comment">// ExternalStorageProvider</span></span><br><span class="line">                <span class="keyword">final</span> String docId = DocumentsContract.getDocumentId(uri);</span><br><span class="line">                <span class="keyword">final</span> String[] split = docId.split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">                <span class="keyword">final</span> String type = split[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;primary&quot;</span>.equalsIgnoreCase(type)) &#123;</span><br><span class="line">                    path = Environment.getExternalStorageDirectory() + <span class="string">&quot;/&quot;</span> + split[<span class="number">1</span>];</span><br><span class="line">                    <span class="keyword">return</span> path;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isDownloadsDocument(uri)) &#123;</span><br><span class="line">                <span class="comment">// DownloadsProvider</span></span><br><span class="line">                <span class="keyword">final</span> String id = DocumentsContract.getDocumentId(uri);</span><br><span class="line">                <span class="keyword">final</span> Uri contentUri = ContentUris.withAppendedId(Uri.parse(<span class="string">&quot;content://downloads/public_downloads&quot;</span>),</span><br><span class="line">                        Long.valueOf(id));</span><br><span class="line">                path = getDataColumn(context, contentUri, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">return</span> path;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isMediaDocument(uri)) &#123;</span><br><span class="line">                <span class="comment">// MediaProvider</span></span><br><span class="line">                <span class="keyword">final</span> String docId = DocumentsContract.getDocumentId(uri);</span><br><span class="line">                <span class="keyword">final</span> String[] split = docId.split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">                <span class="keyword">final</span> String type = split[<span class="number">0</span>];</span><br><span class="line">                Uri contentUri = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;image&quot;</span>.equals(type)) &#123;</span><br><span class="line">                    contentUri = MediaStore.Images.Media.EXTERNAL_CONTENT_URI;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;video&quot;</span>.equals(type)) &#123;</span><br><span class="line">                    contentUri = MediaStore.Video.Media.EXTERNAL_CONTENT_URI;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;audio&quot;</span>.equals(type)) &#123;</span><br><span class="line">                    contentUri = MediaStore.Audio.Media.EXTERNAL_CONTENT_URI;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">final</span> String selection = <span class="string">&quot;_id=?&quot;</span>;</span><br><span class="line">                <span class="keyword">final</span> String[] selectionArgs = <span class="keyword">new</span> String[]&#123;split[<span class="number">1</span>]&#125;;</span><br><span class="line">                path = getDataColumn(context, contentUri, selection, selectionArgs);</span><br><span class="line">                <span class="keyword">return</span> path;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String[] projection = &#123; MediaStore.Images.Media.DATA &#125;;</span><br><span class="line">            Cursor cursor = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                cursor = context.getContentResolver().query(uri, projection, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">int</span> column_index = cursor.getColumnIndexOrThrow(MediaStore.Images.Media.DATA);</span><br><span class="line">                <span class="keyword">if</span> (cursor.moveToFirst()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> cursor.getString(column_index);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (cursor != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    cursor.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<br>



<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a target="_blank" rel="noopener" href="https://commonsware.com/blog/2016/08/10/uri-access-lifetime-shorter-than-you-might-think.html">Uri Access Lifetime: Shorter Than You Might Think</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/support/v4/content/FileProvider">FileProvider</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/training/camera/photobasics#kotlin">TakePhoto</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhangliangnbu.github.io/2018/10/18/2018-10-18-Gradle%E7%9A%84Wrapper%E3%80%81%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%92%8C%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="章亮">
      <meta itemprop="description" content="Developer For Android">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="永恒的码流">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/10/18/2018-10-18-Gradle%E7%9A%84Wrapper%E3%80%81%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%92%8C%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">Gradle的Wrapper、命令行和环境配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2018-10-18 16:12:25 / 修改时间：17:52:48" itemprop="dateCreated datePublished" datetime="2018-10-18T16:12:25+08:00">2018-10-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">Android开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这三个知识点不难，但经常用到，如果不看官方文档，有时候并不知道怎么使用，出现问题也不知道原因，所以有必要做一个总结。由于每个知识点都不多，又有关联，所以放在同一节。</p>
<h1 id="Gradle-Wrapper"><a href="#Gradle-Wrapper" class="headerlink" title="Gradle Wrapper"></a>Gradle Wrapper</h1><p>Gradle Wrapper（以下简写为“Wrapper”）用于管理当前项目的Gradle版本，Gradle官方强烈推荐使用Wrapper构建项目。多人协作时，必须规定项目的Gradle版本，并以此版本的Gradle作为项目的构建工具，由于每个人在本地安装的Gradle版本可能并不一致（也没有必要一致），因此有必要在项目中统一管理Gradle版本。</p>
<p>Wrapper的文件结构如下（项目根目录中）：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">├──</span> <span class="string">build.gradle</span></span><br><span class="line"><span class="meta">├──</span> <span class="string">settings.gradle</span></span><br><span class="line"><span class="meta">├──</span> <span class="string">gradle</span></span><br><span class="line"><span class="meta">│</span>   <span class="string">└── wrapper</span></span><br><span class="line"><span class="meta">│</span>       <span class="string">├── gradle-wrapper.jar</span></span><br><span class="line"><span class="meta">│</span>       <span class="string">└── gradle-wrapper.properties</span></span><br><span class="line"><span class="meta">├──</span> <span class="string">gradlew</span></span><br><span class="line"><span class="meta">└──</span> <span class="string">gradlew.bat</span></span><br></pre></td></tr></table></figure>

<p>包括一个gradle文件和两个可执行的脚本文件gradlew（macOS等平台用）和gradlew.bat（Windows平台用）。</p>
<ul>
<li><code>gradle-wrapper.jar</code>。用于下载所需版本的Gradle。</li>
<li><code>gradle-wrapper.properties</code>。配置Gradle的版本号、本地存储地址等。各属性说明请见<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/gradle_wrapper.html#sec:adding_wrapper">官方文档</a>。</li>
<li><code>gradlew</code>, <code>gradlew.bat</code>。Wrapper的执行脚本，用于替代<code>gradle</code>命令来构建项目。</li>
</ul>
<blockquote>
<p>注意：<code>gradle-wrapper.properties</code>中有一个<code>distributionUrl</code>属性，用于定义Gradle版本地下载URL，如<code>distributionUrl=https\://services.gradle.org/distributions/gradle-4.0-all.zip</code>，版本号后面有个“-all”，有时你也可能看到“-bin”，是什么意思呢？”-all”表示会下载此版本Gralde的所有的资源，包括二进制运行时文件、示例代码和相关文档。“-bin”表示只下载二进制运行时文件。</p>
</blockquote>
<p>Wrapper 构建项目时，其工作流程如下：</p>
<ol>
<li>检查规定的Gradle版本，如果没有则去服务器下载。</li>
<li>下载的Gradle版本存储在Gradle的用户目录中。如macOS中默认存储所有的Gradle版本到<code>/Users/yourname/.gradle/wrapper/dists/</code>中。</li>
<li>使用解压后的Gradle版本来构建项目。</li>
</ol>
<p><img src="https://docs.gradle.org/current/userguide/img/wrapper-workflow.png" alt="wrapper workflow"></p>
<p><strong>添加Wrapper</strong></p>
<p>使用命令行添加Wrapper有两种方式：</p>
<ol>
<li>使用<code>gradle init</code>创建新项目，则会初始化一个带有Wrapper的Gradle项目。</li>
<li>使用<code>gradle wrapper</code>在旧的项目中添加Wrapper。</li>
</ol>
<blockquote>
<p><code>wrapper</code>是Gradle的内建任务</p>
</blockquote>
<p>一般的IDE创建项目时都会自动生产Wrapper文件，如Android Studio。</p>
<p><strong>使用Wrapper执行任务</strong></p>
<p>用Wrapper脚本替换掉<code>gradle</code>来执行任务即可。以macOS平台为例，在项目根目录下执行<code>./gradlew [task name] </code>即可，如列出当前项目的所有任务，项目根目录下执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./gradlew tasks</span><br></pre></td></tr></table></figure>



<p><strong>更新Wrapper</strong></p>
<p>有两种方式更新Wrapper</p>
<ol>
<li>命令行方法。<code>.gradlew wrapper --gradle-version [要更新的版本号]</code>。</li>
<li>修改<code>gradle/wrapper/gradle-wrapper.properties</code>中的<code>distributionUrl</code>属性。</li>
</ol>
<br>

<h1 id="Gradle命令行"><a href="#Gradle命令行" class="headerlink" title="Gradle命令行"></a>Gradle命令行</h1><p>与Gradle交互有两种方式，一是<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/command_line_interface.html">命令行界面</a>，二是IDE的图形界面，如Android Studio。IDE方式各有不同且未必包括所有的命令行指令，但命令行方式却是不变的，因此需要学会基本的命令行指令，以不变应万变。</p>
<blockquote>
<p>注意：在项目中使用命令行方式时，推荐使用<code>./gradlew</code> or <code>gradlew.bat</code> 来代替 <code>gradle</code>。示例中为了方便，统一使用<code>gradle</code></p>
</blockquote>
<p>命令行指令可以自定义，参见<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/custom_tasks.html#sec:declaring_and_using_command_line_options">declaring_and_using_command_line_options</a></p>
<p><strong>指令形式</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gradle [taskName...] [--option-name...]</span><br></pre></td></tr></table></figure>

<p>说明</p>
<ul>
<li><p>任务名（taskName）有多个时，使用空格分开，如<code>gradle task1 task2</code></p>
</li>
<li><p>在多项目工程中，执行某个项目的任务时，可以用“:”将项目名添加到任务名之前，如</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gradle projectName:taskName</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> gradle :projectName:taskName</span></span><br></pre></td></tr></table></figure></li>
<li><p>可选项（option-name）如果接收参数，建议使用<code>=</code>拼接，如</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gradle task1 --console=plain</span></span><br></pre></td></tr></table></figure></li>
<li><p>可选项规定一个行为时，可使用<code>--no-</code>作为其全称（long-form）前缀，来指定它的对立行为。如</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--build-cache</span><br><span class="line">--no-build-cache</span><br></pre></td></tr></table></figure></li>
<li><p>可选项的全称名称常有简写形式 ，如</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--help</span><br><span class="line">-h</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/command_line_interface.html#common_tasks">常见内建（built-in）任务指令</a></strong></p>
<ul>
<li><code>gradle build</code>。生成所有的输出，并执行所有的检查。</li>
<li><code>gradle run</code>。生成应用程序并执行某些脚本或二进制文件</li>
<li><code>gradle check</code>。执行所有检测类任务如tests、linting等</li>
<li><code>gradle clean</code>。删除build文件目录。</li>
<li><code>gradle projects</code>。查看项目结构。</li>
<li><code>gradle tasks</code>。查看任务列表。查看某个任务详细信息，可用<code>gradle help --task someTask</code></li>
<li><code>gradle dependencies</code>。查看依赖列表。</li>
</ul>
<p>部分常见命令行选项说明如下：</p>
<p><strong>调试类</strong></p>
<ul>
<li><code>-?</code>, <code>-h</code>, <code>--help</code>。查看帮助信息。</li>
<li><code>-v</code>,<code> --version</code>。查看版本信息。</li>
<li><code>-s</code>,<code> --stacktrace</code>。执行任务时，打印栈信息。如<code>gradle build --s</code></li>
</ul>
<p>其他选项说明见官方文档<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/command_line_interface.html#sec:command_line_debugging">Debugging options</a></p>
<p><strong>日志类</strong></p>
<ul>
<li><code>-q</code>, <code>--quiet</code>。只打印errors类信息。</li>
<li><code>-i</code>, <code>--info</code>。打印详细的信息。</li>
</ul>
<p>其他选项说明见官方文档<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/command_line_interface.html#setting_log_level">Logging options</a>，更多关于日志类描述请见<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/logging.html#logging">Logging</a>。</p>
<p><strong>性能类</strong></p>
<p>用于优化构建的性能</p>
<ul>
<li><code>--configure-on-demand</code>,<code> --no-configure-on-demand</code>。是否开启按需配置模式。</li>
<li><code>--build-cache</code>, <code>--no-build-cache</code>。是否使用缓存。</li>
</ul>
<p>其他选项说明见官方文档<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/command_line_interface.html#sec:command_line_performance">Performance Options</a>，更多关于性能优化方面的描述请见 <a target="_blank" rel="noopener" href="https://guides.gradle.org/performance/">improving performance of Gradle builds here</a>.</p>
<p><strong>环境配置类</strong></p>
<p>用于配置构建时的环境</p>
<ul>
<li><code>-c</code>, <code>--settings-file</code>。如果不用默认的<code>settings.gradle</code>时，可指定Setting文件。</li>
<li><code>-b</code>, <code>--build-file</code>。指定构建文件。</li>
<li><code>-Dorg.gradle.jvmargs</code>。设置JVM参数。</li>
</ul>
<p>其他选项说明见官方文档<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/command_line_interface.html#environment_options">Environment options</a>，更多关于环境配置方面的描述请见<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/build_environment.html#build_environment">build environment</a></p>
<br>

<h1 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h1><p><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/build_environment.html">配置构建环境</a>，主要配置Gradle构建参数和对应的JVM参数，如代理策略等。其目的是为了多人协作时，保持在一致的环境下进行项目开发。</p>
<p>配置环境有几种途径，优先级从高往低，列出如下：</p>
<ol>
<li>命令行。</li>
<li><code>GRADLE_USER_HOME</code>目录中的<code>gradle.properties</code>文件。</li>
<li>项目根目录中的<code>gradle.properties</code>文件。</li>
<li>环境变量。运行Gradle环境的变量，如JAVA_HOME等。</li>
</ol>
<p>配置环境其实是设置各种属性参数，以上四种方式对于某些属性都可以配置。其中命令行和<code>gradle.properties</code>文件方式支持所有属性的配置。属性有不同的级别，按照优先级从高到底列出如下：</p>
<ol>
<li>系统属性（System properties）。</li>
<li>Gradle属性。</li>
</ol>
<p><strong>系统属性</strong></p>
<p>用于设置Gradle的JVM环境。</p>
<ol>
<li>命令行方式。通过给属性添加<code>-D</code>前缀来设置。如<code>gradle -Dgradle.user.home=foo</code></li>
<li><code>gradle.properties</code>文件方式。根目录中，为属性添加<code>systemProp.</code>前缀，如<code>systemProp.gradle.wrapperUser=myuser</code></li>
</ol>
<p>几个系统属性如下：</p>
<ul>
<li><code>gradle.wrapperUser=(myuser)</code>。设置Wrapper下载Gradle版本的代理服务器的用户名。</li>
<li><code>gradle.wrapperPassword=(mypassword)</code>。设置Wrapper下载Gradle版本的代理服务器的密码。</li>
<li><code>gradle.user.home=(path to directory)</code>。设置Gradle用户目录地址。</li>
</ul>
<p><strong>Gradle属性</strong></p>
<p>Gradle属性都有对应的命令行方式，<code>gradle.properties</code>文件属性和对应的命令行如下：</p>
<table>
<thead>
<tr>
<th><code>gradle.properties</code>文件属性</th>
<th align="left">命令行指令</th>
</tr>
</thead>
<tbody><tr>
<td><code>org.gradle.caching=(true,false)</code></td>
<td align="left"><code>--build-cache</code>,  <code>--no-build-cache</code></td>
</tr>
<tr>
<td><code>org.gradle.caching.debug=(true,false)</code></td>
<td align="left">?</td>
</tr>
<tr>
<td><code>org.gradle.configureondemand=(true,false)</code></td>
<td align="left"><code>--configure-on-demand</code>, <code>--no-configure-on-demand</code></td>
</tr>
<tr>
<td><code>org.gradle.console=(auto,plain,rich,verbose)</code></td>
<td align="left"><code>--console=(auto,plain,rich,verbose)</code></td>
</tr>
<tr>
<td><code>org.gradle.daemon=(true,false)</code></td>
<td align="left"><code>--daemon</code>, <code>--no-daemon</code></td>
</tr>
<tr>
<td><code>org.gradle.daemon.idletimeout=(# of idle millis)</code></td>
<td align="left"><code>-Dorg.gradle.daemon.idletimeout=(number of milliseconds)</code></td>
</tr>
<tr>
<td><code>org.gradle.debug=(true,false)</code></td>
<td align="left"><code>-Dorg.gradle.debug=（true,false)</code></td>
</tr>
<tr>
<td><code>org.gradle.java.home=(path to JDK home)</code></td>
<td align="left"><code>-Dorg.gradle.java.home</code></td>
</tr>
<tr>
<td><code>org.gradle.jvmargs=(JVM arguments)</code></td>
<td align="left"><code>-Dorg.gradle.jvmargs</code></td>
</tr>
<tr>
<td><code>org.gradle.logging.level=(quiet,warn,lifecycle,info,debug)</code></td>
<td align="left"><code>-Dorg.gradle.logging.level=(quiet,warn,lifecycle,info,debug) </code>或者 <code>-q</code>、<code>-w</code>、<code>-i</code>、<code>-d</code></td>
</tr>
<tr>
<td><code>org.gradle.parallel=(true,false)</code></td>
<td align="left"><code>--parallel</code>, <code>--no-parallel</code></td>
</tr>
<tr>
<td><code>org.gradle.warning.mode=(all,none,summary)</code></td>
<td align="left"><code>-Dorg.gradle.warning.mode=(all,none,summary)</code> 或者<code>--warning-mode=(all,none,summary)</code></td>
</tr>
<tr>
<td><code>org.gradle.workers.max=(max # of worker processes)</code></td>
<td align="left"><code>--max-workers</code></td>
</tr>
</tbody></table>
<p>详细说明请见<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/build_environment.html#sec:gradle_configuration_properties">Gradle properties</a></p>
<p>另外官网中有项目属性和通过项目属性配置任务的说明，这里不做描述，请见官网<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/build_environment.html#sec:project_properties">Project properties</a></p>
<p><strong>示例-设置JVM参数</strong></p>
<p>对于每个Java虚拟机进程，Gradle默认配置堆空间最大为1024MB（<code>-Xmx1024m</code>）。-Xmx1024m根据项目大小，可以修改这一参数。如果使用了Gradle Daemon（<code>org.gradle.daemon=true</code>，默认开启），则配置参数如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">org.gradle.jvmargs</span>=<span class="string">-Xmx2g -XX:MaxPermSize=256m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8</span></span><br></pre></td></tr></table></figure>

<p>Java虚拟机参数设置参考Java HotSpot VM Options：<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html">Java 8及以上</a>，<a target="_blank" rel="noopener" href="http://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html">Java 7参考</a>。上面的参数说明如下：</p>
<ul>
<li><p><code>-Xmx[size]</code>。设置虚拟机最大内存空间。必须是1024的倍数，且不能小于2MB，单位为k/K、m/M、g/G，默认值随系统配置而变。与<code>XX:MaxHeapSize</code>等价。示例80MB：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">-Xmx83886080</span></span><br><span class="line"><span class="attr">-Xmx81920k</span></span><br><span class="line"><span class="attr">-Xmx80m</span></span><br></pre></td></tr></table></figure></li>
<li><p><code>-XX:MaxPermSize=[size]</code>。设置持久代最大空间，持久代用于存储常量等，如果报<code>java.lang.OutOfMemoryError: PermGen space</code>的异常，则需要增加这一空间。</p>
<blockquote>
<p>Java虚拟机内存划分请见Oracle官方文档<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/generations.html">Generations</a></p>
</blockquote>
</li>
<li><p><code>-XX:-HeapDumpOnOutOfMemoryError</code>。当抛出<code>java.lang.OutOfMemoryError</code>异常时，将堆内容存储到文件中，用于调试。</p>
</li>
<li><p><code>-Dfile.encoding=UTF-8</code>。虚拟机编码格式。</p>
<blockquote>
<p>在参考文档中并没有找到``-Dfile.encoding`设置</p>
</blockquote>
</li>
</ul>
<p><strong>示例-设置代理</strong></p>
<p>国内下载依赖和Google资源时有时候速度很慢，可以通过设置HTTP和HTTPS代理服务解决。在<code>gradle.properties</code>中设置如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># http代理</span></span><br><span class="line"><span class="meta">systemProp.http.proxyHost</span>=<span class="string">www.somehost.org</span></span><br><span class="line"><span class="meta">systemProp.http.proxyPort</span>=<span class="string">8080</span></span><br><span class="line"><span class="meta">systemProp.http.proxyUser</span>=<span class="string">userid</span></span><br><span class="line"><span class="meta">systemProp.http.proxyPassword</span>=<span class="string">password</span></span><br><span class="line"><span class="meta">systemProp.http.nonProxyHosts</span>=<span class="string">*.nonproxyrepos.com|localhost</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># https代理</span></span><br><span class="line"><span class="meta">systemProp.https.proxyHost</span>=<span class="string">www.somehost.org</span></span><br><span class="line"><span class="meta">systemProp.https.proxyPort</span>=<span class="string">8080</span></span><br><span class="line"><span class="meta">systemProp.https.proxyUser</span>=<span class="string">userid</span></span><br><span class="line"><span class="meta">systemProp.https.proxyPassword</span>=<span class="string">password</span></span><br><span class="line"><span class="meta">systemProp.https.nonProxyHosts</span>=<span class="string">*.nonproxyrepos.com|localhost</span></span><br></pre></td></tr></table></figure>

<p>如果没有user和password，可以不用写。</p>
<p>其他的代理参数可以参考Java文档<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/7/docs/technotes/guides/net/properties.html">Networking Properties</a></p>
<br>

<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/gradle_wrapper.html">Gradle官网-Gradle Wrapper</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/command_line_interface.html">Gradle官网-Command-Line Interface</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/build_environment.html">Gradle官网-Build Environment</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhangliangnbu.github.io/2018/09/29/2018-09-29-%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0-Gradle%E4%B8%8B%E8%BD%BD%E5%85%AC%E5%8F%B8%E5%86%85%E9%83%A8%E4%BE%9D%E8%B5%96%E5%A4%B1%E8%B4%A5%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="章亮">
      <meta itemprop="description" content="Developer For Android">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="永恒的码流">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/09/29/2018-09-29-%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0-Gradle%E4%B8%8B%E8%BD%BD%E5%85%AC%E5%8F%B8%E5%86%85%E9%83%A8%E4%BE%9D%E8%B5%96%E5%A4%B1%E8%B4%A5%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/" class="post-title-link" itemprop="url">Gradle下载公司内部依赖失败问题排查</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-09-29 09:26:42" itemprop="dateCreated datePublished" datetime="2018-09-29T09:26:42+08:00">2018-09-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2018-10-17 14:52:48" itemprop="dateModified" datetime="2018-10-17T14:52:48+08:00">2018-10-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">Android开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><p>最近的一个项目使用了公司自己的Maven库中的依赖，这个Maven库只能用公司内网访问。开始我设置了代理，<code>sync</code>后，有部分依赖不能下载，有时候<code>sync</code>依然会成功，但<code>build</code>一定会失败，执行<code>./gradlew build --stacktrack</code>,获得错误信息如下： </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Could not resolve xxxxx.xxx.xxx.xxx. </span><br></pre></td></tr></table></figure>

<p>只是公司自己的Maven库依赖不能解析，其他三方库依赖没有报错。 </p>
<h1 id="问题排查"><a href="#问题排查" class="headerlink" title="问题排查"></a>问题排查</h1><p>排查思路如下： </p>
<p><strong>一，确定公司内部Maven库能够从自己的电脑上访问</strong> </p>
<ol>
<li><p>是否能够<code>ping</code>通？ </p>
<p><code>$ ping xxx.xxx.xxx(公司内部Maven库服务地址) </code>。 </p>
</li>
<li><p>能够<code>ping</code>通后，再用浏览器尝试访问公司内部Maven库，看能够找到需要的依赖。 </p>
</li>
</ol>
<p>确定公司内部Maven库能够被访问后，再看下一步 </p>
<p><strong>二，确定自己的Gradle没有设置外部代理</strong> </p>
<p>如果设置了外部代理，则是从外部网络访问公司内部Maven，肯定是访问不了的。依次检查如下： </p>
<ol>
<li><p>项目根目录下的<code>gradle.properties</code>是否设置了代理。 </p>
</li>
<li><p>Android Studio是否设置了代理。”Preference -&gt; Appearence&amp;Behavior -&gt; System Settings -&gt; HTTP Proxy” </p>
</li>
<li><p>用户主目录<code>~/.gradle/gradle.properties</code>中是否设置了全局代理。 </p>
</li>
</ol>
<p>如果设置了代理，则关闭所有的代理或者设置内部Maven库地址不走代理，而其他的走代理。 </p>
<p><strong>内部Maven库地址不走代理设置</strong> </p>
<p><code>gradle.properties</code>设置如下： </p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">systemProp.http.nonProxyHosts</span>=<span class="string">xxxx.xxxx.xxxx </span></span><br></pre></td></tr></table></figure>



<p>Android Studio设置如下： </p>
<p>在”Preference -&gt; Appearence&amp;Behavior -&gt; System Settings -&gt; HTTP Proxy”中的”No proxy for”中填入公司内部Host主机地址。 </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhangliangnbu.github.io/2018/09/10/2018-09-10-%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0-Complie%E5%85%B3%E9%94%AE%E5%AD%97%E8%BF%87%E6%97%B6WARNING%E8%A7%A3%E5%86%B3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="章亮">
      <meta itemprop="description" content="Developer For Android">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="永恒的码流">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/09/10/2018-09-10-%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0-Complie%E5%85%B3%E9%94%AE%E5%AD%97%E8%BF%87%E6%97%B6WARNING%E8%A7%A3%E5%86%B3/" class="post-title-link" itemprop="url">Complie关键字过时警告问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-09-10 16:29:15" itemprop="dateCreated datePublished" datetime="2018-09-10T16:29:15+08:00">2018-09-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2018-10-17 14:52:48" itemprop="dateModified" datetime="2018-10-17T14:52:48+08:00">2018-10-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">Android开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><p>之前构建Android项目时，经常出现以下WARNING：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">WARNING: Configuration <span class="string">&#x27;compile&#x27;</span> is obsolete and has been replaced with <span class="string">&#x27;implementation&#x27;</span> and <span class="string">&#x27;api&#x27;</span>.</span><br><span class="line">It will be removed at the end of 2018. For more information see: http://d.android.com/r/tools/update-dependency-configurations.html</span><br></pre></td></tr></table></figure>

<p>但我检查了APP项目以及所有的Module，都没有发现<code>compile</code>关键字，用全局搜索（command + shift + f）也没有查到，所以应该是某个远程依赖或插件中使用了<code>compile</code>关键字，但如何定位是哪一个呢？</p>
<p>通过IDE<code>Sync</code>后的提示如下：</p>




<br>

<h1 id="问题分析和解决"><a href="#问题分析和解决" class="headerlink" title="问题分析和解决"></a>问题分析和解决</h1><p>IDE给的提示太简略，只能通过Gradle命令和<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/command_line_interface.html#sec:command_line_debugging">Logging options</a>来打印详细的构建信息来定位问题。Logging级别从简略到详细依次为<code>-q</code>、<code>-w</code> 、<code>-i</code>、<code>-d</code>。IDE默认应该是使用<code>-q</code>的，可以逐级打印信息，也可以直接使用<code>-d</code>级别日志打印信息。</p>
<p>在项目根目录下，执行命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./gradlew assembleDebug -d &gt; gradle.log</span><br></pre></td></tr></table></figure>

<p>其中<code>-d</code>是为了打印构建的Debug级别的信息，非常详细。由于信息非常多，命令行界面不能一屏完全显示，故放入名为<code>gradle.log</code>的文件中。</p>
<p>最后生成的文件有13M多，5万多行。通过搜索关键字”WARNING”，定位信息如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">16:03:26.459 [DEBUG] [org.gradle.internal.progress.DefaultBuildOperationExecutor] Build operation <span class="string">&#x27;Apply plugin com.sensorsdata.analytics.android to project &#x27;</span>:app<span class="string">&#x27;&#x27;</span> started</span><br><span class="line">16:03:26.459 [WARN] [org.gradle.api.Project] WARNING: Configuration <span class="string">&#x27;compile&#x27;</span> is obsolete and has been replaced with <span class="string">&#x27;implementation&#x27;</span> and <span class="string">&#x27;api&#x27;</span>.</span><br><span class="line">It will be removed at the end of 2018. For more information see: http://d.android.com/r/tools/update-dependency-configurations.html</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>警告信息出现在”Build operation Apply plugin com.sensorsdata.analytics.android to project…”语句下，那很可能就是Gradle在应用这个插件的时候报的错。</p>
<p>插件是神策统计的，我的版本是<code>1.0.2</code>，查看官网给的<a target="_blank" rel="noopener" href="https://dl.bintray.com/zouyuhan/maven">Mavne库</a>，查看最新版本，<code>android-gradle-plugin2/</code>目录下，最高版本是<code>2.0.2</code>。</p>
<p>更新插件版本，重新构建，警告消失了，问题解决了。</p>
<blockquote>
<p>文章首发<a href="https://zhangliangnbu.github.io/">我的个人博客</a>和<a target="_blank" rel="noopener" href="https://www.jianshu.com/">简书</a></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhangliangnbu.github.io/2018/08/27/android-build-04-gradle-lifecycle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="章亮">
      <meta itemprop="description" content="Developer For Android">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="永恒的码流">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/27/android-build-04-gradle-lifecycle/" class="post-title-link" itemprop="url">Android构建04-Gradle构建流程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-08-27 20:24:50" itemprop="dateCreated datePublished" datetime="2018-08-27T20:24:50+08:00">2018-08-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2018-10-17 14:52:48" itemprop="dateModified" datetime="2018-10-17T14:52:48+08:00">2018-10-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">Android开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="构建的生命周期"><a href="#构建的生命周期" class="headerlink" title="构建的生命周期"></a>构建的生命周期</h1><p>Gradle项目的构建分为三个阶段：初始化、配置、执行。<br>参考官方手册 <a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/build_lifecycle.html">Build Lifecycle</a>。</p>
<h2 id="初始化（Initialization）"><a href="#初始化（Initialization）" class="headerlink" title="初始化（Initialization）"></a>初始化（Initialization）</h2><p>在这个阶段中，Gradle决定哪些项目加入到构建中（因为Gradle支持多项目构建），并为这些项目分别创建一个<code>Project</code>实例。</p>
<p>Gradle支持单项目和多项目构建，如果是单项目构建，则初始化当前项目即可，如果是多项目构建，则需要决定哪些项目需要加入到构建中并初始化。那么：</p>
<ol>
<li>Gradle是如何判断当前构建是单项目还是多项目构建呢？</li>
<li>如果是多项目构建，Gradle又是如何决定将哪些项目加入到构建中呢？</li>
</ol>
<p><strong>多项目还是单项目构建？</strong><br>这里的关键是一个名为<code>setting.gradle</code>的文件，Gradle在初始化阶段会首先去查找<code>setting.gradle</code>文件，查找的规则如下：</p>
<ol>
<li>查找当前构建目录下的<code>setting.gradle</code>文件。</li>
<li>如果没有找到，则去与当前目录有相同嵌套级别的<code>master</code>目录查找。</li>
<li>如果没有找到，则去父目录查找。</li>
<li>如果没有找到，则进行单项目构建。</li>
<li>如果找到了，Gradle去检查当前项目在<code>settings.gradle</code>中是否有定义。如果没有，则进行单项目构建，否则进行多项目构建。</li>
</ol>
<p>多项目工程在根目录必须存在<code>setting.gradle</code>文件，单项目工程则可以不需要这个文件。</p>
<p><strong>多项目构建的项目集如何决定？</strong><br>多项目构建时，项目集由<code>setting.gradle</code>创建。项目集可以用一个树形结构表示，每个节点表示一个项目，并且有对应的项目路径。在大多数情况下，项目路径与文件系统中项目的位置一致，当然这也是可以配置的。<br>在<code>setting.gradle</code>中，有很多方法可以定义项目树，常见的是层次化和扁平化的布局。</p>
<p>层次化布局</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// setting.gradle</span></span><br><span class="line">include <span class="string">&#x27;project1&#x27;</span>, <span class="string">&#x27;project2:child&#x27;</span>, <span class="string">&#x27;project3:child1&#x27;</span></span><br></pre></td></tr></table></figure>
<p><code>include</code>方法接收多个项目路径作为参数。<br>每个项目路径对应文件系统中的一个目录，通常，项目路径和文件目录一一对应，比如<code>project2:child</code>对应项目根目录下的<code>project2/child</code>目录。<br>如果项目树的叶子节点和它的父节点都需要包含在构建中，则只需指定叶子节点即可。比如，<code>project2:child</code>，将创建两个项目实例<code>project2</code>和<code>project2:child</code>。</p>
<p>扁平化布局</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// setting.gradle</span></span><br><span class="line">includeFlat <span class="string">&#x27;project3&#x27;</span>, <span class="string">&#x27;project4&#x27;</span></span><br></pre></td></tr></table></figure>
<p><code>includeFlat</code>方法将目录名作为参数。这些目录是根项目目录的兄弟目录，并作为多项目树中根项目的子项目。</p>
<p><strong>Settings语法</strong><br>这里主要说一下<code>include</code>方法的语法，其余的语法请见对应的<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/dsl/org.gradle.api.initialization.Settings.html">DSL Reference</a>。<code>setting.gradle</code>在构建时会创建代理对象<code>Settings</code>，其<code>include</code>方法对应着 <code>Settings.include(java.lang.String[])</code>，查看其<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/dsl/org.gradle.api.initialization.Settings.html#org.gradle.api.initialization.Settings:include(java.lang.String[])">DSL Reference</a>:</p>
<ol>
<li><code>include</code>方法接收项目路径数组作为参数，并将对应的项目添加到构建中。</li>
<li>参数中支持的项目路径分隔符为“:”，而不是“/”。</li>
<li>路径的最后一个节点是项目的名称。</li>
<li>项目路径是根项目目录下的相对路径，可以使用<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/javadoc/org/gradle/api/initialization/ProjectDescriptor.html#setProjectDir-java.io.File-"><code>ProjectDescriptor.setProjectDir(java.io.File)</code></a>)更改。</li>
</ol>
<p>示例</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入两个项目, &#x27;foo&#x27; and &#x27;foo:bar&#x27;</span></span><br><span class="line"><span class="comment">// 对应的文件目录是 $rootDir/a 和 $rootDir/a/b</span></span><br><span class="line"><span class="comment">// directories are inferred by replacing &#x27;:&#x27; with &#x27;/&#x27;</span></span><br><span class="line">include <span class="string">&#x27;foo:bar&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// include one project whose project dir does not match the logical project path</span></span><br><span class="line"><span class="comment">// 引入‘baz’项目，对应的文件目录是foo/baz</span></span><br><span class="line">include <span class="string">&#x27;baz&#x27;</span></span><br><span class="line">project(<span class="string">&#x27;:baz&#x27;</span>).projectDir = file(<span class="string">&#x27;foo/baz&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="配置（Configuration）"><a href="#配置（Configuration）" class="headerlink" title="配置（Configuration）"></a>配置（Configuration）</h2><p>在这个阶段，Gradle会配置加入到构建中的<code>Project</code>实例，执行所有项目对应的构建脚本。</p>
<blockquote>
<p>作为名词的‘配置（Configuration）’是指，Gradle执行项目的构建脚本这一过程。<br>作为动词的’配置（ Configure）’是指，Gradle执行项目的构建脚本这一动作。</p>
</blockquote>
<p><strong>默认配置模式</strong></p>
<p>默认情况下，Gradle会配置<code>settings.gradle</code>里的所有项目，不论这些项目与最终执行的任务是否有关系。这样做是因为Gradle允许一个项目在配置和执行阶段访问任何其他项目，如Gradle里可以进行<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/multi_project_builds.html#sec:cross_project_configuration">跨项目配置(Cross project configuration)</a>，一个项目的配置可能会依赖其他项目，所以在执行任务之前，需要配置所有的项目。</p>
<p>项目配置按照广度（ breadth-wise）顺序来执行，如父项目先于子项目被配置。</p>
<p><strong>按需配置模式</strong></p>
<p>由于多项目配置中，可能存在大量无需配置的项目，如果需要配置所有项目后才执行任务则会浪费大量的时间。从Gradle1.4开始，有一个孵化中的特性，叫做<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/multi_project_builds.html#sec:cross_project_configuration">按需配置（configuration on demand）</a>模式。按需配置项目时，Gradle只配置与最终任务相关联的项目，以缩短构建时间。这个模式以后可能会成为默认模式，甚至成为唯一的模式。截至我写这篇文章（Gradle发布4.10）时，按需配置模式还只是一个实验中的特性，不能保证所有的构建都能正确运行，尤其是存在耦合的多项目构建。</p>
<blockquote>
<p>项目的耦合和解耦请见文档的<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/multi_project_builds.html#sec:decoupled_projects">Decoupled Projects</a>。一个简单的耦合项目就是在子项目中使用<code>allprojects</code> and <code>subprojects</code>等方法，在根项目中使用这两个方法则不会影响按需配置模式。</p>
</blockquote>
<p>按需配置模式下，项目配置遵循规则如下：</p>
<ul>
<li>根项目总会被配置。</li>
<li>构建的当前项目也会被配置。</li>
<li>项目的依赖会被配置。如果项目A将项目B作为依赖，则构建A时，A和B都会被配置。</li>
<li>任务依赖对应的项目会被配置。如’someTask.dependsOn(“:someOtherProject:someOtherTask”)‘，someOtherProject会被配置。</li>
<li>通过命令行构建任务时会配置相应的项目。如构建 ‘projectA:projectB:someTask’时会配置projectB。</li>
</ul>
<p>进行构建时，可以在命令行加入<code>--configure-on-demand</code>来指定用按需配置模式来进行构建，如<code>gradle hello --configure-on-demand</code>将以按需配置模式执行‘’hello“任务。</p>
<h2 id="执行（Execution）"><a href="#执行（Execution）" class="headerlink" title="执行（Execution）"></a>执行（Execution）</h2><p>在这个阶段，首先，Gradle确定要执行的任务集，任务集是由输入到命令行的任务名称参数和当前目录决定的。然后，Gradle会去执行任务集中的每个任务。<br>任务（<code>Task</code>）是由一系列的活动（<code>Action</code>）组成的，当任务执行的时候，活动会依次执行。可以通过<code>doFirst</code>和<code>doLast</code>方法将活动添加到任务中。</p>
<p>问题：</p>
<ol>
<li>多项目构建中，Gradle如何确定任务是哪个项目的？尤其是任务名称相同的情况下。</li>
<li>如果确定多个任务执行的顺序？</li>
</ol>
<p><strong>任务的位置</strong><br>以<code>$ gradle hello</code>为例，在执行阶段，Gradle会从构建的当前项目目录开始，依据项目树往下查找名称为<code>hello</code>的任务并执行。因此Gradle不会执行当前项目的父项目和兄弟节点项目的任务。</p>
<p><strong>任务的顺序</strong><br>如果没有额外配置，Gradle将以字母数字顺序执行任务。比如 “:consumer:action” 将先于 “:producer:action”执行。</p>
<blockquote>
<p>If nothing else is defined, Gradle executes the task in alphanumeric order</p>
</blockquote>
<hr>
<br>



<h1 id="示例-单项目构建"><a href="#示例-单项目构建" class="headerlink" title="示例-单项目构建"></a>示例-单项目构建</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建项目目录</span></span><br><span class="line">$ mkdir single-project-build-lifecycle-demo</span><br><span class="line">$ <span class="built_in">cd</span> single-project-build-lifecycle-demo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建settings.gradle文件</span></span><br><span class="line">$ vi settings.gradle</span><br></pre></td></tr></table></figure>
<p><code>settings.gradle</code>文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rootProject.name = &#x27;single-project-build-lifecycle-demo&#x27;</span><br><span class="line">println &#x27;settings.gradle -&gt; this is executed during the initialization phase.&#x27;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建build.gradle文件</span></span><br><span class="line">$ vi build.gradle</span><br></pre></td></tr></table></figure>
<p><code> build.gradle</code>文件</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">println <span class="string">&#x27;build.gradle -&gt; global println -&gt; This is executed during the configuration phase.&#x27;</span></span><br><span class="line"></span><br><span class="line">task configured &#123;</span><br><span class="line">    println <span class="string">&#x27;build.gradle -&gt; task configured -&gt; This is also executed during the configuration phase.&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task test &#123;</span><br><span class="line">    doLast &#123;</span><br><span class="line">        println <span class="string">&#x27;build.gradle -&gt; task test -&gt; doLast -&gt; This is executed during the execution phase.&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task testBoth &#123;</span><br><span class="line">    doFirst &#123;</span><br><span class="line">      println <span class="string">&#x27;build.gradle -&gt; task testBoth -&gt; doFirst -&gt; This is executed first during the execution phase.&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    doLast &#123;</span><br><span class="line">      println <span class="string">&#x27;build.gradle -&gt; task testBoth -&gt; doLast -&gt; This is executed last during the execution phase.&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    println <span class="string">&#x27;build.gradle -&gt; task testBoth -&gt; This is executed during the configuration phase as well.&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>开始构建，并执行testBoth任务 <code>$ gradle testBoth</code>，输出如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">settings.gradle -&gt; this is executed during the initialization phase.</span><br><span class="line"></span><br><span class="line">&gt; Configure project :</span><br><span class="line">build.gradle -&gt; global println -&gt; This is executed during the configuration phase.</span><br><span class="line">build.gradle -&gt; task configured -&gt; This is also executed during the configuration phase.</span><br><span class="line">build.gradle -&gt; task testBoth -&gt; This is executed during the configuration phase as well.</span><br><span class="line"></span><br><span class="line">&gt; Task :testBoth</span><br><span class="line">build.gradle -&gt; task testBoth -&gt; doFirst -&gt; This is executed first during the execution phase.</span><br><span class="line">build.gradle -&gt; task testBoth -&gt; doLast -&gt; This is executed last during the execution phase.</span><br><span class="line"></span><br><span class="line">BUILD SUCCESSFUL <span class="keyword">in</span> 0s</span><br><span class="line">1 actionable task: 1 executed</span><br></pre></td></tr></table></figure>
<p>构建过程如下：</p>
<ol>
<li><p>初始化阶段。<br> 执行<code>settings.gradle</code>脚本，所以首先输出’settings.gradle -&gt; this is executed during the initialization phase.’。</p>
</li>
<li><p>配置阶段。<br> 由于<code>settings.gradle</code>没有定义项目，根项目即当前项目有<code>build.gradle</code>，因此只是执行这个文件。顺序执行：打印语句、三个task方法。<br> 这里的三个task方法对应<code>Project</code>实例中<code>Task task(String name, Closure configureClosure)</code>，查看其<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/dsl/org.gradle.api.Project.html#org.gradle.api.Project:task(java.lang.String,%20groovy.lang.Closure)">Reference文档</a>，说是这个方法会产生一个任务对象并添加到当前<code>Project</code>实例中，并且在返回这个任务的时候会执行闭包以配置这个任务。也就说在配置我们这个项目时，三个<code>task</code>方法的闭包都会被执行。<br> 以testBoth任务对应的<code>task</code>方法为例，它的闭包里包含<code>doFirst</code>、<code>doLast</code>和<code>println</code>三个方法。其中<code>doFirst</code>和<code>doLast</code>是<code>Task</code>的方法，查看<code>doFirst</code>的<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/dsl/org.gradle.api.Task.html#org.gradle.api.Task:doFirst(groovy.lang.Closure)">Reference文档</a>，说是添加闭包到任务的action列表中，当任务执行的时候，会执行这个闭包。在配置阶段，并不会去执行任务，也就是说不会去执行<code>doFirst</code>和<code>doLast</code>闭包里的内容。<br> 因此，在配置阶段，Gradle会依次执行三个任务方法里的闭包，而不会执行闭包里添加action的闭包即<code>doFirst</code>和<code>doLast</code>的闭包，因此会依次输出<br> ‘build.gradle -&gt; task configured -&gt; …’ 和‘build.gradle -&gt; task testBoth -…’</p>
</li>
<li><p>执行阶段。<br> 由于在命令行只构建testBoth任务，因此这个阶段只执行testBoth任务中的<code>Action</code>列表，依次执行<code>doFirst</code>和<code>doLast</code>的闭包。</p>
</li>
</ol>
<hr>
<br>



<h1 id="示例-常见的多项目构建"><a href="#示例-常见的多项目构建" class="headerlink" title="示例-常见的多项目构建"></a>示例-常见的多项目构建</h1><p>参考官方手册<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/multi_project_builds.html#sec:project_jar_dependencies">Authoring Multi-Project Builds</a><br>模拟一个常见的Java项目，目录结构如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">multi-project-build-lifecycle-demo/</span><br><span class="line">  settings.gradle</span><br><span class="line">  build.gradle</span><br><span class="line">  api/</span><br><span class="line">    src/main/java/</span><br><span class="line">      org/gradle/sample/</span><br><span class="line">        api/</span><br><span class="line">          Person.java</span><br><span class="line">        apiImpl/</span><br><span class="line">          PersonImpl.java</span><br><span class="line">  services/personService/</span><br><span class="line">    src/</span><br><span class="line">      main/java/</span><br><span class="line">        org/gradle/sample/services/</span><br><span class="line">          PersonService.java</span><br><span class="line">      test/java/</span><br><span class="line">        org/gradle/sample/services/</span><br><span class="line">          PersonServiceTest.java</span><br><span class="line">  shared/</span><br><span class="line">    src/main/java/</span><br><span class="line">      org/gradle/sample/shared/</span><br><span class="line">        Helper.java</span><br></pre></td></tr></table></figure>
<p>根目录<code>settings.gradle</code></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include <span class="string">&#x27;api&#x27;</span>, <span class="string">&#x27;shared&#x27;</span>, <span class="string">&#x27;services:personService&#x27;</span></span><br></pre></td></tr></table></figure>
<p>根目录<code>build.gradle</code></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">subprojects &#123;</span><br><span class="line">    apply <span class="attr">plugin:</span> <span class="string">&#x27;java&#x27;</span></span><br><span class="line">    group = <span class="string">&#x27;org.gradle.sample&#x27;</span></span><br><span class="line">    version = <span class="string">&#x27;1.0&#x27;</span></span><br><span class="line">    repositories &#123;</span><br><span class="line">        mavenCentral()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        testCompile <span class="string">&quot;junit:junit:4.12&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">project(<span class="string">&#x27;:shared&#x27;</span>) &#123;</span><br><span class="line">    task hello &#123;</span><br><span class="line">        doLast &#123;</span><br><span class="line">            println <span class="string">&quot;shared task hello -&gt; doLast&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        println <span class="string">&quot;shared task hello&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">project(<span class="string">&#x27;:api&#x27;</span>) &#123;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        compile project(<span class="string">&#x27;:shared&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    task hello &#123;</span><br><span class="line">        doLast &#123;</span><br><span class="line">            println <span class="string">&quot;api task hello -&gt; doLast&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        println <span class="string">&quot;api task hello&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">project(<span class="string">&#x27;:services:personService&#x27;</span>) &#123;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        compile project(<span class="string">&#x27;:shared&#x27;</span>), project(<span class="string">&#x27;:api&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    task hello &#123;</span><br><span class="line">        doLast &#123;</span><br><span class="line">            println <span class="string">&quot;personService task hello -&gt; doLast&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        println <span class="string">&quot;personService task hello&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行命令<code>gradle -i :services:personService:hello</code>，输出如下</p>
<blockquote>
<p><code>-i</code> 是gradle的log等级的一种，输出较为详细的信息</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">Initialized native services <span class="keyword">in</span>: /Users/zhangliang/.gradle/native</span><br><span class="line">The client will now receive all logging from the daemon (pid: 27188). The daemon <span class="built_in">log</span> file: /Users/zhangliang/.gradle/daemon/4.8.1/daemon-27188.out.log</span><br><span class="line">Starting 4th build <span class="keyword">in</span> daemon [uptime: 2 mins 55.761 secs, performance: 98%, no major garbage collections]</span><br><span class="line">Using 8 worker leases.</span><br><span class="line">Starting Build</span><br><span class="line">Settings evaluated using settings file <span class="string">&#x27;/Users/zhangliang/Projects/tools/learn-gradle/multi-project-build-lifecycle-demo/settings.gradle&#x27;</span>.</span><br><span class="line">Projects loaded. Root project using build file <span class="string">&#x27;/Users/zhangliang/Projects/tools/learn-gradle/multi-project-build-lifecycle-demo/build.gradle&#x27;</span>.</span><br><span class="line">Included projects: [root project <span class="string">&#x27;multi-project-build-lifecycle-demo&#x27;</span>, project <span class="string">&#x27;:api&#x27;</span>, project <span class="string">&#x27;:services&#x27;</span>, project <span class="string">&#x27;:shared&#x27;</span>, project <span class="string">&#x27;:services:personService&#x27;</span>]</span><br><span class="line"></span><br><span class="line">&gt; Configure project :</span><br><span class="line">Evaluating root project <span class="string">&#x27;multi-project-build-lifecycle-demo&#x27;</span> using build file <span class="string">&#x27;/Users/zhangliang/Projects/tools/learn-gradle/multi-project-build-lifecycle-demo/build.gradle&#x27;</span>.</span><br><span class="line">shared task hello</span><br><span class="line">api task hello</span><br><span class="line">personService task hello</span><br><span class="line"></span><br><span class="line">&gt; Configure project :api</span><br><span class="line">Evaluating project <span class="string">&#x27;:api&#x27;</span> using build file <span class="string">&#x27;/Users/zhangliang/Projects/tools/learn-gradle/multi-project-build-lifecycle-demo/api/build.gradle&#x27;</span>.</span><br><span class="line"></span><br><span class="line">&gt; Configure project :services</span><br><span class="line">Evaluating project <span class="string">&#x27;:services&#x27;</span> using build file <span class="string">&#x27;/Users/zhangliang/Projects/tools/learn-gradle/multi-project-build-lifecycle-demo/services/build.gradle&#x27;</span>.</span><br><span class="line"></span><br><span class="line">&gt; Configure project :shared</span><br><span class="line">Evaluating project <span class="string">&#x27;:shared&#x27;</span> using build file <span class="string">&#x27;/Users/zhangliang/Projects/tools/learn-gradle/multi-project-build-lifecycle-demo/shared/build.gradle&#x27;</span>.</span><br><span class="line"></span><br><span class="line">&gt; Configure project :services:personService</span><br><span class="line">Evaluating project <span class="string">&#x27;:services:personService&#x27;</span> using build file <span class="string">&#x27;/Users/zhangliang/Projects/tools/learn-gradle/multi-project-build-lifecycle-demo/services/personService/build.gradle&#x27;</span>.</span><br><span class="line">All projects evaluated.</span><br><span class="line">Selected primary task <span class="string">&#x27;:services:personService:hello&#x27;</span> from project :services:personService</span><br><span class="line">Tasks to be executed: [task <span class="string">&#x27;:services:personService:hello&#x27;</span>]</span><br><span class="line">:services:personService:hello (Thread[Task worker <span class="keyword">for</span> <span class="string">&#x27;:&#x27;</span>,5,main]) started.</span><br><span class="line"></span><br><span class="line">&gt; Task :services:personService:hello</span><br><span class="line">Task <span class="string">&#x27;:services:personService:hello&#x27;</span> is not up-to-date because:</span><br><span class="line">  Task has not declared any outputs despite executing actions.</span><br><span class="line">personService task hello -&gt; doLast</span><br><span class="line">:services:personService:hello (Thread[Task worker <span class="keyword">for</span> <span class="string">&#x27;:&#x27;</span>,5,main]) completed. Took 0.001 secs.</span><br><span class="line"></span><br><span class="line">BUILD SUCCESSFUL <span class="keyword">in</span> 0s</span><br><span class="line">1 actionable task: 1 executed</span><br></pre></td></tr></table></figure>
<p>从输出可以看出：</p>
<ol>
<li>Gradle首先查找<code>settings.gradle</code>文件进行初始化，确定根项目目录并创建所有<code>include</code>的项目实例。其中包括<code>services </code>。</li>
<li>配置<code>settings.gradle</code>中<code>include</code>的所有的项目。项目配置的顺序，首先是根项目，其次是子项目，多个子项目看来也是按照字母顺序依次进行的。<blockquote>
<p>当前配置排序是<br>[root project ‘multi-project-build-lifecycle-demo’, project ‘:api’, project ‘:services’, project ‘:shared’, project ‘:services:personService’]<br>当我将‘shared’项目重命名为‘ashared’后，配置排序变为<br>[root project ‘multi-project-build-lifecycle-demo’, project ‘:api’, project ‘:ashared’, project ‘:services’, project ‘:services:personService’]</p>
</blockquote>
</li>
</ol>
<ol start="3">
<li>最后执行任务<code>:services:personService:hello</code>。</li>
</ol>
<hr>
<br>



<h1 id="示例-按需配置的多项目构建"><a href="#示例-按需配置的多项目构建" class="headerlink" title="示例-按需配置的多项目构建"></a>示例-按需配置的多项目构建</h1><p>参考文档<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/multi_project_builds.html#example_build_script_of_water_parent_project">Build script of water (parent) project</a></p>
<p>创建一个多项目工程，目录结构如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── bluewhale/</span><br><span class="line">├── build.gradle</span><br><span class="line">├── krill/</span><br><span class="line">└── settings.gradle</span><br></pre></td></tr></table></figure>

<p><code>settings.gradle</code>文件</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rootProject.name = <span class="string">&#x27;water&#x27;</span></span><br><span class="line">include <span class="string">&#x27;bluewhale&#x27;</span>, <span class="string">&#x27;krill&#x27;</span></span><br></pre></td></tr></table></figure>

<p><code>build.gradle</code>文件</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">allprojects &#123;</span><br><span class="line">    task hello &#123;</span><br><span class="line">        doLast &#123; task -&gt;</span><br><span class="line">            println <span class="string">&quot;I&#x27;m $task.project.name&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根目录下执行<code>gradle -i :bluewhale:hello</code>，输出如下（省略部分无关信息）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Initialized native services <span class="keyword">in</span>: /Users/zhangliang/.gradle/native</span><br><span class="line">Included projects: [root project <span class="string">&#x27;water&#x27;</span>, project <span class="string">&#x27;:bluewhale&#x27;</span>, project <span class="string">&#x27;:krill&#x27;</span>]</span><br><span class="line"></span><br><span class="line">&gt; Configure project :</span><br><span class="line">&gt; Configure project :bluewhale</span><br><span class="line">&gt; Configure project :krill</span><br><span class="line">All projects evaluated.</span><br><span class="line"></span><br><span class="line">&gt; Task :bluewhale:hello</span><br><span class="line">I<span class="string">&#x27;m bluewhale</span></span><br></pre></td></tr></table></figure>

<p>从输出可以看出，所有的项目都进行了配置。</p>
<p>根目录下执行<code>gradle -i :bluewhale:hello --configure-on-demand</code>，输出如下（省略部分无关信息）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Initialized native services <span class="keyword">in</span>: /Users/zhangliang/.gradle/native</span><br><span class="line">Included projects: [root project <span class="string">&#x27;water&#x27;</span>, project <span class="string">&#x27;:bluewhale&#x27;</span>, project <span class="string">&#x27;:krill&#x27;</span>]</span><br><span class="line">Configuration on demand is an incubating feature.</span><br><span class="line"></span><br><span class="line">&gt; Configure project :</span><br><span class="line">&gt; Configure project :bluewhale</span><br><span class="line">All projects evaluated.</span><br><span class="line"></span><br><span class="line">&gt; Task :bluewhale:hello</span><br><span class="line">I<span class="string">&#x27;m bluewhale</span></span><br></pre></td></tr></table></figure>

<p>上面的输出中出现了一句话”Configuration on demand is an incubating feature”，表示当前的“按需配置模式”还只是实验中的功能。从输出中可以看出，没有配置与任务无关的“krill”项目。</p>
<hr>
<br>



<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a target="_blank" rel="noopener" href="https://gradle.org/">Gradle官网</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhangliangnbu.github.io/2018/08/27/android-build-03-gradle-start/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="章亮">
      <meta itemprop="description" content="Developer For Android">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="永恒的码流">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/27/android-build-03-gradle-start/" class="post-title-link" itemprop="url">Android构建03-Gradle基础</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-08-27 18:02:47" itemprop="dateCreated datePublished" datetime="2018-08-27T18:02:47+08:00">2018-08-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2018-10-17 14:52:48" itemprop="dateModified" datetime="2018-10-17T14:52:48+08:00">2018-10-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">Android开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Gradle是Android构建系统的重点，需要花费时间用心学习。学习资料主要是官方的<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/userguide.html">Gradle Docs</a>，有个社区版的<a target="_blank" rel="noopener" href="https://dongchuan.gitbooks.io/gradle-user-guide-/">中文翻译资料</a>，英语不好的同学可以看看，但不全。</p>
<p>这章首先对Gradle做一个简单的介绍，然后讲如何使用官方文档和API，接着讲解Gradle的基本概念、Wrapper和学习中需要使用到的命令行指令、插件等。有些知识点如插件应该放在之后的章节讲解，但为了保持文章的完整性，我放在了这一章，学习的过程中可能不能完全理解，没有关系，在以后的章节中如果有涉及的话，会具体解释。</p>
<hr>
<br>



<h1 id="Gradle简介"><a href="#Gradle简介" class="headerlink" title="Gradle简介"></a>Gradle简介</h1><p>Gradle是一个注重灵活性和性能的开源构建自动化工具，使用Groovy或Kotlin DSL来编写构建脚本。</p>
<blockquote>
<p>虽然支持Kotlin，但还是建议学习Groovy。因为：一，目前官方示例里有许多还没有kotlin方式；二，目前大多数项目的Gradle脚本都是用Groovy编写的。</p>
</blockquote>
<p>Gradle特点如下：</p>
<ol>
<li>高度可定制。Gradle使用了可定制和可扩展的设计思想，如使用插件。</li>
<li>快速。Gradle通过重用先前执行的输出，仅处理已更改的输入以及并行执行任务来快速完成任务。</li>
<li>强大。Gradle是Android的官方构建工具，并支持许多主流的编程语言和技术。</li>
</ol>
<p><strong>图形界面和命令行</strong> Gradle支持IDE或命令行两种方式来构建工程。支持主流的IDE，如Android Studio, Eclipse, IntelliJ IDEA, Visual Studio 2017, 和XCode等。</p>
<blockquote>
<p>提示：命令行方式构建是必须掌握的，因为命令行方式包含所有的功能，而图形界面方式却未必。在调试时，命令行方式尤其重要。</p>
</blockquote>
<p><strong>典型的工程目录</strong> 一个典型Gradle项目一般会包括两个脚本文件（<code>settings.gradle</code>和<code>build.gradle</code>）和Wrapper文件（gradle文件目录和gradlew、gradlew.bat可执行文件）。如下所示</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">├── settings.gradle </span><br><span class="line">├── build.gradle</span><br><span class="line">├── gradle</span><br><span class="line">│   └── wrapper</span><br><span class="line">│       ├── gradle-wrapper.jar  </span><br><span class="line">│       └── gradle-wrapper.properties  </span><br><span class="line">├── gradlew  </span><br><span class="line">└── gradlew.bat</span><br></pre></td></tr></table></figure>
<p>其中<code>settings.gradle</code>和<code>build.gradle</code>是项目构建时所需的脚本，Gradle会据此创建相应的Java实例。Wrapper文件用于管理<code>gradle</code>版本，一个终端上不同的项目可以使用不同配置和版本的Gradle，具体项目中使用<code>./gradlew</code>或<code>gradlew.bat</code>来替代<code>gradle</code>命令。</p>
<hr>
<br>



<h1 id="Gradle-Docs的使用"><a href="#Gradle-Docs的使用" class="headerlink" title="Gradle Docs的使用"></a>Gradle Docs的使用</h1><p><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/userguide.html">Gradle Docs</a>资料中，最重要的是User Manual（用户手册）和API文档（DSL Reference和Javadoc），其余的可以不用看。</p>
<p><strong>Gradle User Manual</strong> User Manual中最关键的一部分当属“Build Configuration Scripts”（官网经常换名字，可能已经不叫这个标题了）。这一部分内容相当多，内容也比较杂。可以先看<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/build_lifecycle.html">Build Lifecycle</a>和<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/multi_project_builds.html">Configuring Multi-Project Build</a>这两节，看懂这两节，就可以对Gradle构建的流程有一个清晰的了解了，之后再看其他章节就非常容易了。</p>
<p><strong>API文档</strong> API文档包括<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/dsl/">Gradle DSL Reference（Gradle特定语言指南）</a> 和 <a target="_blank" rel="noopener" href="https://docs.gradle.org/current/javadoc/">Javadoc（Java文档）</a>。Reference包含主要的接口和类，并做了描述和分类以利于学习，Javadoc包含所有的API，主要用于检索。就内容的覆盖面而言，Javadoc完全包含Reference。学习时可以看Reference，使用中具体查找Gradle的某个API文档时，用Javadoc。</p>
<hr>
<br>



<h1 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h1><p>使用Gradle构建项目时，会经常涉及到几个重要的概念：脚本(Script)、项目(Project)和任务(Task)。这几个概念出现的顺序如下：</p>
<ol>
<li>开发者编写脚本，如<code>settings.gradle</code>和<code>build.gradle</code>；</li>
<li>构建项目时，Gradle会根据构建脚本创建对应的Java实例，如<code>settings.gradle</code>对应<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/dsl/org.gradle.api.initialization.Settings.html">Setting</a>，<code>build.gradle</code>对应<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/dsl/org.gradle.api.Project.html">Project</a>，其中<code>Project</code>包含构建需要的任务集。然后，Gradle根据这些实例依次执行初始化、项目配置和任务执行等来构建项目。</li>
</ol>
<h2 id="脚本-Script"><a href="#脚本-Script" class="headerlink" title="脚本(Script)"></a><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/dsl/org.gradle.api.Script.html">脚本(Script)</a></h2><p>利用Gradle构建项目时，与开发者直接交互的就是脚本了。<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/dsl/">Gradle脚本有以下特点</a>：</p>
<ol>
<li>每个脚本都有一个对应的Java实例，称为代理对象，在脚本中可以直接使用代理对象的属性和方法。</li>
<li>Gradle脚本实现了<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/dsl/org.gradle.api.Script.html"><code>Script</code></a>接口。此接口定义了许多属性和方法，可以在脚本中直接使用。</li>
<li>Gradle脚本由零或多个语句和脚本块组成（statements and script blocks）。 语句包括方法调用、属性赋值和局部变量定义等。 脚本块是一种方法调用，它以闭包作为方法的参数，而闭包用来配置代理对象。</li>
</ol>
<h2 id="项目-Project"><a href="#项目-Project" class="headerlink" title="项目(Project)"></a><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/dsl/org.gradle.api.Project.html">项目(Project)</a></h2><p>项目是Gradle的最基本的概念之一。<br>Gradle通过<code>build.gradle</code>脚本生成实现了<code>Project</code>接口的项目实例，每个Gradle构建都由一个或多个项目组成。<code>Project</code>接口是脚本文件与Gradle交互的主要API，可以通过<code>Project</code>实例访问Gradle的所有功能。</p>
<h2 id="任务-Task"><a href="#任务-Task" class="headerlink" title="任务(Task)"></a><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/dsl/org.gradle.api.Task.html">任务(Task)</a></h2><p>项目由一个或多个任务组成。 每个任务执行一些基本工作，例如编译类、运行单元测试或压缩WAR文件等。<br>任务由一系列Action对象组成。 执行任务时，通过调用<code>Action.execute（T）</code>依次执行每个<code>Action</code>。 可以通过调用<code>Task.doFirst（org.gradle.api.Action）</code>或<code>Task.doLast（org.gradle.api.Action）</code>向任务添加<code>Action</code>。</p>
<p><strong>概念之间的关系</strong> Gradle中项目和任务、Action的关系如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">A[Gradle构建]</span><br><span class="line">A --&gt;B1(项目1)</span><br><span class="line">A --&gt;B2(项目2)</span><br><span class="line">A --&gt;B3(项目 ...)</span><br><span class="line">B1 --&gt; T11[任务 ...]</span><br><span class="line">T11 --&gt; A111[Action ...]</span><br><span class="line">B2 --&gt; T21[任务 ...]</span><br><span class="line">T21 --&gt; A211[Action ...]</span><br><span class="line">B3 --&gt; T31[任务 ...]</span><br><span class="line">T31 --&gt; A311[Action ...]</span><br></pre></td></tr></table></figure>

<p><strong>浏览官方文档</strong> 以上概念详细说明和使用，请见官方手册和指南：</p>
<ol>
<li>脚本。<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/writing_build_scripts.html">Writing Build Scripts</a>、<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/dsl/org.gradle.api.Script.html">Script Reference</a></li>
<li>项目。<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/dsl/org.gradle.api.Project.html">Project Reference</a></li>
<li>任务。<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/tutorial_using_tasks.html">Build Script Basics</a>、<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/more_about_tasks.html">Authoring Tasks</a>、<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/custom_tasks.html">Writing Custom Task Classes</a>、<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/dsl/org.gradle.api.Task.html">Task Reference</a></li>
</ol>
<p>以上文档可以不用深读，但需要浏览一遍，知道大概。</p>
<hr>
<br>



<h1 id="Gradle-Wrapper"><a href="#Gradle-Wrapper" class="headerlink" title="Gradle Wrapper"></a>Gradle Wrapper</h1><p>前言中已经提到了Wrapper，即一种管理当前项目的Gradle版本的工具。多人协作时，每个人安装的Gradle环境可能不一致（也没有必要一致），需要使用Wrapper管理项目的版本。官方强烈推荐使用Wrapper管理具体的项目，并以<code>./gradlew</code>(macOS)代替<code>gradle</code>执行命令。<br>Wrapper目录中有一个<code>gradle-wrapper.properties</code>文件，配置Gradle的版本号、本地存储地址等。</p>
<p><strong>引入Wrapper</strong> 使用命令行添加Wrapper有两种方式：</p>
<ol>
<li>使用<code>gradle init</code>创建新项目，则会初始化一个带有Wrapper的Gradle项目。</li>
<li>使用<code>gradle wrapper</code>在旧的项目中添加Wrapper。<blockquote>
<p><code>wrapper</code>是Gradle的内建任务</p>
</blockquote>
</li>
</ol>
<p>一般的IDE创建项目时都会自动生产Wrapper文件，如Android Studio。</p>
<p><strong>使用Wrapper执行任务</strong> 用Wrapper脚本替换掉<code>gradle</code>来执行任务即可。以macOS平台为例，在项目根目录下执行<code>./gradlew [task name] </code>即可，如列出当前项目的所有任务，项目根目录下执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./gradlew tasks</span></span><br></pre></td></tr></table></figure>

<p><strong>更新Wrapper</strong> 有两种方式更新Wrapper</p>
<ol>
<li>命令行方法。<code>.gradlew wrapper --gradle-version [要更新的版本号]</code>。</li>
<li>修改<code>gradle/wrapper/gradle-wrapper.properties</code>中的<code>distributionUrl</code>属性。</li>
</ol>
<p>关于Gradle Wrapper的详细说明请见官方手册<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/gradle_wrapper.html">The Gradle Wrapper</a></p>
<hr>
<br>



<h1 id="命令行"><a href="#命令行" class="headerlink" title="命令行"></a>命令行</h1><p><strong>指令形式</strong> Gradle命令行指令由三部分组成: 可执行文件<code>gradle</code>或<code>./gradlew</code>、一个或多个任务名、零或多个选项名，如下所示：。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gradle [taskName...] [--option-name...]</span></span><br></pre></td></tr></table></figure>
<p>指令的详细说明请见官方手册<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/command_line_interface.html">Command-Line Interface</a>，这里我只介绍学习或调试中常用的指令。部分常见命令行选项说明如下：</p>
<p><strong>固有任务类</strong></p>
<ul>
<li><code>gradle build</code>。生成所有的输出，并执行所有的检查。</li>
<li><code>gradle clean</code>。删除build文件目录。</li>
<li><code>gradle projects</code>。查看项目结构。</li>
<li><code>gradle tasks</code>。查看任务列表。查看某个任务详细信息，可用<code>gradle help --task someTask</code></li>
<li><code>gradle dependencies</code>。查看依赖列表。</li>
</ul>
<p><strong>调试类</strong></p>
<ul>
<li><code>-?</code>, <code>-h</code>, <code>--help</code>。查看帮助信息。</li>
<li><code>-v</code>,<code> --version</code>。查看版本信息。</li>
<li><code>-s</code>,<code> --stacktrace</code>。执行任务时，打印栈信息。如<code>gradle build -s</code></li>
</ul>
<p><strong>日志类</strong></p>
<ul>
<li><code>-q</code>, <code>--quiet</code>。只打印errors类信息。</li>
<li><code>-i</code>, <code>--info</code>。打印详细的信息。</li>
</ul>
<p>其中在学习的过程中，经常会用到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gradle [taskName...] -i</span><br></pre></td></tr></table></figure>
<p>这会打印比较详细的构建信息，用于帮助我们理解Gradle构建流程、项目配置和依赖、任务依赖等。</p>
<hr>
<br>



<h1 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h1><p>配置构建环境，主要配置Gradle构建参数和对应的JVM参数，如代理策略等。其目的是为了多人协作时，保持在一致的环境下进行项目开发。</p>
<p>配置环境有几种途径，优先级从高往低，列出如下：</p>
<ol>
<li>命令行。</li>
<li><code>GRADLE_USER_HOME</code>目录中的<code>gradle.properties</code>文件。</li>
<li>项目根目录中的<code>gradle.properties</code>文件。</li>
<li>环境变量。运行Gradle环境的变量，如JAVA_HOME等。</li>
</ol>
<p>具体参数的配置请见官方手册<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/build_environment.html">Build Environment</a></p>
<hr>
<br>



<h1 id="依赖管理"><a href="#依赖管理" class="headerlink" title="依赖管理"></a>依赖管理</h1><p>现在的项目基本上都需要使用第三方库，一般称其为依赖，这样说并不准确，<a href="(https://docs.gradle.org/current/userguide/dependency_management_terminology.html#sub:terminology_module)">官方的定义</a>是:</p>
<blockquote>
<p>A dependency is a pointer to another piece of software required to build, test or run a module</p>
<p>依赖是指向软件模块的指针，而非模块本身</p>
</blockquote>
<p>依赖管理是一种以自动方式声明、解析和使用项目所需的依赖的技术。</p>
<p><strong>依赖管理流程</strong> </p>
<ol>
<li>声明。在构建脚本中声明依赖和对应的仓库。 </li>
<li>解析。项目构建时，Gradle会定位依赖的本地路径或远程服务器路径并下载依赖（有必须要的话）。 </li>
<li>缓存。依赖解析后，Gradle会将从远程服务下载的依赖缓存到本地，避免下次构建时重复下载。 </li>
</ol>
<p><strong>依赖的类型</strong></p>
<ul>
<li>模块依赖（Module dependencies）。指向一个库中的模块，这是最常见的依赖类型。</li>
<li>文件依赖。指向无需仓库的一系列文件。</li>
<li>项目依赖。指向多项目工程主项目需要用到的其他项目。</li>
<li>特定分发的依赖。如API依赖、TestKit依赖和本地Groovy依赖等。 </li>
</ul>
<p><strong>常见的仓库</strong></p>
<ul>
<li>文件系统仓库。通过查找文件目录以解析依赖。</li>
<li>Maven Central 仓库。一般默认的Maven仓库。</li>
<li>JCenter Maven 仓库。Android默认的Maven仓库。</li>
<li>Google Maven 仓库。Google的支持库所在的Maven仓库。</li>
<li>本地 Maven仓库。就是你开发项目所用的主机中的仓库。</li>
<li>自定义Maven仓库。一些公司，如阿里，喜欢把阿里云OSS服务SDK等存储在自己搭建的Maven仓库中。</li>
<li>Ivy仓库。不常用。</li>
</ul>
<blockquote>
<p>Maven仓库是用<a href="javascript:void%200">Apache Maven</a>工具搭建的存储不同类型资源的本地或远程资源服务。Maven Central仓库、JCenter Maven仓库和Google Maven仓库都是Maven仓库，区别在于存储的服务器和管理的机构不一样。 </p>
</blockquote>
<hr>
<br>



<h1 id="插件-Plugin"><a href="#插件-Plugin" class="headerlink" title="插件(Plugin)"></a>插件(Plugin)</h1><p><strong>插件简介</strong> Gradle的一个非常大的特点就是灵活或者说可扩展性，它本身没有提供多少构建具体任务的逻辑，构建各类具体的项目都是通过增加插件实现的。插件可以添加新任务（例如JavaCompile），新的域对象（例如SourceSet），新的规定（例如Java源位于src/main/java）以及继承其他插件而获得的功能。<br>Gradle本身提供了一些基础的插件，只需要配置id即可使用，如<code> Java Plugin</code>。</p>
<p><strong>二进制插件及配置</strong> 插件分为两种，本地脚本插件和远程发布的二进制插件，一般我们常用的是后者。如Android项目中我们用到的Android插件，就是一种远程二进制插件。<br>Android项目添加插件示例：<br>在根目录<code>build.gradle</code>中添加仓库和插件路径</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath <span class="string">&#x27;com.android.tools.build:gradle:3.1.4&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在app目录<code>build.gradle</code>中应用插件</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="attr">plugin:</span> <span class="string">&#x27;com.android.application&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>插件的使用</strong> Gradle使用插件里的构建逻辑分为两步</p>
<ol>
<li>解析插件。即获取插件的jar包。插件被解析后，就可以在脚本文件中直接使用它的API，如Android项目脚本文件中的配置<code>android</code>、方法<code>compileSdkVersion</code>等。本地脚本插件和Gradle固有插件会自动解析。</li>
<li>应用插件。即执行插件的<code>Plugin.apply(T)</code>方法，这是插件的核心方法。在这个方法中，可以为当前项目添加一些新的任务。</li>
</ol>
<p>关于插件更详细的说明请见官方手册:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/plugins.html#sec:using_plugins">Using Gradle Plugins</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/standard_plugins.html">Standard Gradle plugins</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/plugin_reference.html">Core Plugin</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/custom_plugins.html">Writing Custom Plugins</a></li>
</ol>
<p>如何你想查看Gradle源码，看看插件是如何实现的，链接如下：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://github.com/gradle/gradle">Github上的Gradle源码</a></li>
<li><a target="_blank" rel="noopener" href="https://source.android.com/setup/build/downloading">Android插件源码-AOSP</a></li>
<li><a target="_blank" rel="noopener" href="http://repo.spring.io/libs-milestone/com/android/tools/build/gradle/">Andorid插件源码-repe.spring.io</a></li>
<li><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/tools/build/+/e49dcf3e1edbe40d945a24fee85c6422eb6221b9/">Android源码-android.google.source</a></li>
</ol>
<hr>
<br>



<h1 id="示例-单项目构建"><a href="#示例-单项目构建" class="headerlink" title="示例-单项目构建"></a>示例-单项目构建</h1><p>官方示例 <a target="_blank" rel="noopener" href="https://guides.gradle.org/creating-new-gradle-builds/?_ga=2.262531468.1022039991.1532854446-1803358189.1525999794">Creating New Gradle Builds</a><br>主要练习：初始化项目、执行任务、移动文件、添加Plugin等。</p>
<blockquote>
<p>提示：示例中使用了<code>./gradlew</code>来执行命令，如果因为下载失败导致该命令不可用，使用<code>gradle</code>命令即可。</p>
</blockquote>
<hr>
<br>



<h1 id="示例-多项目构建"><a href="#示例-多项目构建" class="headerlink" title="示例-多项目构建"></a>示例-多项目构建</h1><p>官方示例 <a target="_blank" rel="noopener" href="https://guides.gradle.org/creating-multi-project-builds/?_ga=2.39430567.560526946.1533349009-1803358189.1525999794">Creating Multi-project Builds</a></p>
<blockquote>
<p>提示：示例中需要下载依赖，国内网络直接访问可能导致下载失败，需要设置国外代理服务。我的代理服务走的通道是<code>shadowsocks</code>，有的资源使用<code>shadowsocks</code>协议是访问不了的，需要使用<code>http</code>或<code>https</code>协议才行，可以使用<code>privoxy</code>切换<code>shadowsocks</code>协议为<code>http</code>和<code>https</code>协议（实际上是在本地<code>shadowsocks</code>端口上再加了一层<code>privoxy</code>代理）。<br><code>shadowsocks</code>代理设置请参考<a target="_blank" rel="noopener" href="https://github.com/shadowsocks/shadowsocks/blob/master/README.md">Github shadowsocks</a><br><code>privoxy</code>代理设置请参考 <a target="_blank" rel="noopener" href="https://www.privoxy.org/">Privoxy 官网</a>、<a target="_blank" rel="noopener" href="http://lazybios.com/2016/11/transter-socks5-to-http-by-privoxy/">使用Privoxy桥接Http代理到SOCKS5代理</a>、<a target="_blank" rel="noopener" href="https://blog.zfanw.com/privoxy-tutorial/">Privoxy 教程</a><br>Gradle项目代理设置如下：在电脑中设置好<code>http</code>协议代理后，在当前项目根目录下创建<code>gradle.properties</code>文件（如果有就不用创建），编辑文件如下:</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">systemProp.http.proxyHost=<span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line">systemProp.http.nonProxyHosts=<span class="number">192.168</span>.*, &lt;localhost&gt;</span><br><span class="line">systemProp.http.proxyPort=<span class="number">8118</span></span><br><span class="line">systemProp.https.proxyHost=<span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line">systemProp.https.nonProxyHosts=<span class="number">192.168</span>.*, &lt;localhost&gt;</span><br><span class="line">systemProp.https.proxyPort=<span class="number">8118</span></span><br></pre></td></tr></table></figure>

<p>其中<code>8118</code>是<code>privoxy</code>的端口号<br>Gradle代理设置详细说明请参考官方文档<a target="_blank" rel="noopener" href="https://docs.gradle.org/4.0/userguide/build_environment.html#N10D07">Accessing the web via a proxy</a>（虽然也不够详细:p）</p>
</blockquote>
<hr>
<br>



<h1 id="示例-Android项目根目录-build-gradle语法分析"><a href="#示例-Android项目根目录-build-gradle语法分析" class="headerlink" title="示例-Android项目根目录 build.gradle语法分析"></a>示例-Android项目根目录 <code>build.gradle</code>语法分析</h1><p>利用<code>Android Studio</code>创建一个项目，根目录中<code>build.gradle</code>文件如下</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    ext.kotlin_version = <span class="string">&#x27;1.2.50&#x27;</span></span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath <span class="string">&#x27;com.android.tools.build:gradle:3.1.4&#x27;</span></span><br><span class="line">        classpath <span class="string">&quot;org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> Do not place your application dependencies here; they belong</span></span><br><span class="line">        <span class="comment">// in the individual module build.gradle files</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task clean(<span class="attr">type:</span> Delete) &#123;</span><br><span class="line">    delete rootProject.buildDir</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接使用API文档来分析上面的代码：</p>
<ul>
<li><p><code>Project</code>和方法。<code>build.gradle</code>脚本的代理对象是<code>Project</code>实例，<code>buildscript</code>、<code>allprojects</code>和<code>task</code>是<code>Project</code>中的三个方法（实际上，<code>task</code>在这里是关键字，不是方法，但<code>Project</code>中有方法与之对应）。</p>
</li>
<li><p><code>buildscript</code>。在<code>Android Studio</code>中(<code>Mac</code>平台 <code>Command+鼠标左键</code>)或者在文档中查看API详情，如下<br>￼￼<img src="https://upload-images.jianshu.io/upload_images/2658578-f4b3e247a668231b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="buildscript"><br>这个方法的作用是配置项目构建脚本的<code>classpath</code>，参数是一个闭包，闭包的代理对象是<code>ScriptHandler</code>，即如果<code>buildscript</code>代码块中的属性和方法，如果不能在<code>Project</code>中找到，就去<code>ScriptHandler</code>中去找。<br>再来分析下<code>buildscript</code>代码块里的内容。示例代码中，<code>repositories</code>和<code>dependencies</code>都是<code>ScriptHandler</code>的方法，可以直接在<code>Android Studio</code>中点击查看其API。但<code>ext</code>是什么，是谁的属性？<code>owner</code>（<code>Project</code>）的，还是<code>delegate</code>（<code>ScriptHandler</code>）的？由于不能在<code>Studio</code>里直接查看，我们先看看<code>Project</code>的API<br><img src="https://upload-images.jianshu.io/upload_images/2658578-df8c01595c625c03.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Project"><br>全局搜索<code>ext</code>或<code>setExt</code>、<code>getExt</code>，都没有结果。再看看其继承的接口，发现<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/javadoc/org/gradle/api/plugins/ExtensionAware.html">ExtensionAware</a>中可以搜索到，API文档说</p>
</li>
</ul>
<blockquote>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// All extension aware objects have a special “ext” extension of type &gt;ExtraPropertiesExtension</span></span><br><span class="line"><span class="keyword">assert</span> project.hasProperty(<span class="string">&quot;myProperty&quot;</span>) == <span class="literal">false</span></span><br><span class="line">project.ext.myProperty = <span class="string">&quot;myValue&quot;</span></span><br><span class="line"><span class="comment">// Properties added to the “ext” extension are promoted to the owning &gt;object</span></span><br><span class="line"><span class="keyword">assert</span> project.myProperty == <span class="string">&quot;myValue&quot;</span></span><br></pre></td></tr></table></figure>

<p>继承了<code>ExtensionAware</code>的对象都有一个特殊的<code>ext</code>扩展类型，可以直接添加属性<code>project.ext.myProperty = &quot;myValue&quot;</code>，之后使用属性<code>myProperty</code>时可以不用写<code>ext</code>，如<code>project.myProperty</code>。<br>因此示例代码中的<code>ext</code>是<code>owner</code>（<code>Project</code>）的属性。</p>
</blockquote>
<ul>
<li><p><code>allprojects</code>。分析方法同上，略。</p>
</li>
<li><p><code>task</code>。<code>Project</code>中有四个<code>task</code>方法</p>
</li>
</ul>
<blockquote>
<p><code>Task task(String name)</code><br><code>Task task(String name, Closure configureClosure)</code><br><code>Task task(Map&lt;String, ?&gt; args, String name)</code><br><code>Task task(Map&lt;String, ?&gt; args, String name, Closure configureClosure)</code></p>
</blockquote>
<p><code>Studio</code>中链接的是<code>Task task(String name)</code>，但后面的<code>clean(type: Delete) &#123; ​    delete rootProject.buildDir &#125;</code>是什么呢？开始以为是方法，实际上并不是，一是在<code>Project</code>中没有<code>clean</code>方法，二是<a target="_blank" rel="noopener" href="http://www.groovy-lang.org/semantics.html#_optional_parentheses">Groovy语法中不允许嵌套的方法省略括号</a>。</p>
<blockquote>
<p>Parentheses are required for method calls without parameters or ambiguous method calls:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">println(Math.max(5, 10))</span><br></pre></td></tr></table></figure>

<p>不是方法，但看起来又不是参数。查看<code>Task</code>API，有定义task的示例<br>You can also use the task keyword in your build file:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">task myTask</span><br><span class="line">task myTask &#123; configure closure &#125;</span><br><span class="line">task myTask(type: SomeType)</span><br><span class="line">task myTask(type: SomeType) &#123; configure closure &#125;</span><br></pre></td></tr></table></figure>

<p>也就是说<code>task</code>可以是一个关键字！去看Gradle官方文档<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/more_about_tasks.html#sec:defining_tasks">Defining tasks</a><br>There are a few variations on this style, which you may need to use in certain situations. For example, the keyword style does not work in expressions.</p>
</blockquote>
<p>有很多方式定义task，有关键字格式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">task copy(type: Copy) &#123;</span><br><span class="line">    from(file(&#x27;srcDir&#x27;))</span><br><span class="line">    into(buildDir)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们的示例就是这种格式的。<br>也有方法格式的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">task(&#x27;copy&#x27;, type: Copy) &#123;</span><br><span class="line">    from(file(&#x27;srcDir&#x27;))</span><br><span class="line">    into(buildDir)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这对应<code>Project</code>的方法<code>Task task(Map&lt;String, ?&gt; args, String name, Closure configureClosure)</code>。Groovy方法中的参数似乎是可以改变顺序的，有人写的<a target="_blank" rel="noopener" href="https://blog.csdn.net/cckevincyh/article/details/75094293">博客</a>中提到了这件事，但我没有找到相关的官方文档。<br>终于分析完了，初学者学习这些估计要抓狂，:p。</p>
<p>最后，把示例代码中省略的括号和<code>owner</code>、<code>delegate</code>补全，以提高可读性，如下</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">buildscript(&#123;</span><br><span class="line">    owner.ext.kotlin_version = <span class="string">&#x27;1.2.50&#x27;</span></span><br><span class="line">    delegate.repositories(&#123;</span><br><span class="line">        delegate.google()</span><br><span class="line">        delegate.jcenter()</span><br><span class="line">    &#125;)</span><br><span class="line">    dependencies(&#123;</span><br><span class="line">        delegate.add(<span class="string">&#x27;classpath&#x27;</span>, <span class="string">&#x27;com.android.tools.build:gradle:3.1.4&#x27;</span>)</span><br><span class="line">        delegate.add(<span class="string">&#x27;classpath&#x27;</span>, <span class="string">&quot;org.jetbrains.kotlin:kotlin-gradle-plugin:$&#123;owner.kotlin_version&#125;&quot;</span>)</span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> Do not place your application dependencies here; they belong</span></span><br><span class="line">        <span class="comment">// in the individual module build.gradle files</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">allprojects(&#123;</span><br><span class="line">    delegate.repositories(&#123;</span><br><span class="line">        delegate.google()</span><br><span class="line">        delegate.jcenter()</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">task clean(<span class="attr">type:</span> Delete) &#123;</span><br><span class="line">    delete rootProject.buildDir</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意: 其中的<code>classpath</code>，我暂时并没有理解清楚它是如何工作的，它不是方法，只能理解它是一个可以添加的配置属性。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dependency add(String configurationName, Object &gt;dependencyNotation);</span><br></pre></td></tr></table></figure>
</blockquote>
<hr>
<br>



<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a target="_blank" rel="noopener" href="https://gradle.org/">Gradle官网</a></li>
<li><a target="_blank" rel="noopener" href="https://dongchuan.gitbooks.io/gradle-user-guide-/">Gradle User Guide 中文版(非官方)</a></li>
<li><a target="_blank" rel="noopener" href="http://www.groovy-lang.org/learn.html">Groovy官网</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhangliangnbu.github.io/2018/08/27/android-build-02-groovy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="章亮">
      <meta itemprop="description" content="Developer For Android">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="永恒的码流">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/27/android-build-02-groovy/" class="post-title-link" itemprop="url">Android构建02-Groovy基础</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-08-27 17:52:09" itemprop="dateCreated datePublished" datetime="2018-08-27T17:52:09+08:00">2018-08-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2018-10-17 14:52:48" itemprop="dateModified" datetime="2018-10-17T14:52:48+08:00">2018-10-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">Android开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Groovy是JVM语言，与Java语法类似，如果你熟悉kotlin的话，你会发现它与kotlin更类似些。它可以作为Java平台的脚本语言使用。详细介绍请见<a target="_blank" rel="noopener" href="http://groovy-lang.org/index.html">Groovy官网</a>和<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Groovy">维基百科</a>。</p>
<blockquote>
<p>提示：“Groovy基础”这一部分建议不要花费太多时间，能看懂语法，尤其是闭包的语法，以及知道如何查阅API即可。</p>
</blockquote>
<hr>
<br>



<h1 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h1><p>对于语法的学习，我这里就不详细说了，请大家按照下面步骤去学习：</p>
<ol>
<li>浏览一遍官方文档的<a target="_blank" rel="noopener" href="http://www.groovy-lang.org/documentation.html">语言规范</a>，里面有示例，很容易看懂。要知道Groovy语言规范大致讲了哪些内容，以后遇到不懂的语法，可以回来快速查阅。</li>
<li>另外，也可以看下国人写的入门博客：<a target="_blank" rel="noopener" href="https://blog.csdn.net/singwhatiwanna/article/details/76084580">任玉刚 Gradle从入门到实战 - Groovy基础</a>、<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/ba55dc163dfd">使用Groovy开发之新特性</a>。</li>
</ol>
<p><strong>重点看的部分</strong></p>
<ol>
<li>闭包<a target="_blank" rel="noopener" href="http://www.groovy-lang.org/closures.html">Closures</a>。定义、使用、代理策略(<code>owner</code>, <code>delegate</code> and <code>this</code>)</li>
<li>语义<a target="_blank" rel="noopener" href="http://www.groovy-lang.org/semantics.html">Semantics</a>。重点看<code>Promotion and coercion</code>、<code>Optionality </code>和<code>Typing </code>部分，尤其是和闭包相关的部分。</li>
</ol>
<hr>
<br>



<h1 id="API文档使用说明"><a href="#API文档使用说明" class="headerlink" title="API文档使用说明"></a>API文档使用说明</h1><p>Groovy API包括两部分，一部分是Groovy化的JDK API(<code>groovy-jdk</code>)，另一部分是新增的纯Groovy API(<code>gapi</code>)。</p>
<p>文档入口：</p>
<ol>
<li><a target="_blank" rel="noopener" href="http://groovy-lang.org/documentation.html">官网Document</a>-&gt;API documentation<br><img src="https://upload-images.jianshu.io/upload_images/2658578-cae297c94add4e77.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Groovy API入口"></li>
</ol>
<ol start="2">
<li>直接进入<a target="_blank" rel="noopener" href="http://docs.groovy-lang.org/">API文档</a><br><img src="https://upload-images.jianshu.io/upload_images/2658578-0da24a5176f7dff8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Groovy Api Document"></li>
</ol>
<p><strong><a target="_blank" rel="noopener" href="http://docs.groovy-lang.org/docs/latest/html/groovy-jdk/">Groovy化的JDK API</a></strong></p>
<blockquote>
<p>This document describes the methods added to the JDK to make it more groovy.</p>
</blockquote>
<p>Groovy在JDK中增加了许多方法，如在<code>List</code>增加了<code>public List each(Closure closure)</code>、<code>public List dropWhile(Closure condition)</code>等方法，使其Groovy化。</p>
<p>查找API示例：查看<code>List</code>中<code>public List each(Closure closure)</code>方法详情。</p>
<ol>
<li><p>通过包(<code>Package</code>)查。<code>java.util</code> -&gt; <code>Interfaces</code> -&gt; <code>List</code> -&gt; <code>each(Closure closure)</code></p>
</li>
<li><p>通过索引(<code>Index</code>)查。<code>Index</code> -&gt; 页面搜索<code>each(groovy.lang.Closure)</code>(<code>Mac</code>版<code>Chrome</code>浏览器快捷键<code>Command+F</code>) -&gt; 找到<code>Method in interface java.util.List</code>一项</p>
</li>
</ol>
<p>最终结果如下：<br><img src="https://upload-images.jianshu.io/upload_images/2658578-23a786dc872d9aa0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="List的each方法详情"><br>描述说是迭代一个<code>List</code>，并将每个子项作为参数传递到闭包中进行处理。</p>
<p><strong><a target="_blank" rel="noopener" href="http://docs.groovy-lang.org/docs/latest/html/gapi/">新增的Groovy类 API</a></strong></p>
<blockquote>
<p>Groovy - An agile dynamic language for the Java Platform<br>(GroovyDoc for Groovy and Java classes)</p>
</blockquote>
<p>上面说的是<code>Groovy and Java classes</code>文档，包括<code>Groovy</code>类和原生<code>Java</code>类(可通过文档中的类的链接查看)。尤其要注意，这个文档中的<code>JDK API</code>点击后都会链接到原始的Java类，而不是Groovy化的Java类。<br>查看某个API详情的方法与上面的相同，略。</p>
<hr>
<br>



<h1 id="示例-Map语法"><a href="#示例-Map语法" class="headerlink" title="示例-Map语法"></a>示例-Map语法</h1><p>创建Gradle项目，并添加名为groovySyntax的任务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir groovy-syntax</span><br><span class="line">$ <span class="built_in">cd</span> groovy-syntax</span><br><span class="line">$ vi build.gradle</span><br></pre></td></tr></table></figure>
<p><code>build.gradle</code>文件</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">task(groovySyntax).doLast &#123;</span><br><span class="line">    println <span class="string">&#x27;start groovy syntax task&#x27;</span></span><br><span class="line">    doMap()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> doMap() &#123;</span><br><span class="line">    <span class="keyword">def</span> emptyMap = [:]</span><br><span class="line">    <span class="keyword">def</span> test = [<span class="string">&quot;id&quot;</span>:<span class="number">1</span>, <span class="string">&quot;name&quot;</span>:<span class="string">&quot;zhangliang&quot;</span>, <span class="string">&quot;isMale&quot;</span>:<span class="literal">true</span>]</span><br><span class="line">    test[<span class="string">&quot;id&quot;</span>] = <span class="number">2</span></span><br><span class="line">    test.id = <span class="number">900</span></span><br><span class="line">    println test.id</span><br><span class="line">    println test.isMale</span><br><span class="line">    println test</span><br><span class="line"></span><br><span class="line">    test.each &#123; key ,value -&gt;</span><br><span class="line">        println <span class="string">&quot;key=$key, value=$value&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    test.each &#123; entry -&gt;</span><br><span class="line">        println <span class="string">&quot;entry-&gt;$entry,$&#123;entry.key&#125;, $&#123;entry.value&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行<code>gradle groovySyntax</code>，输出如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Starting a Gradle Daemon (subsequent builds will be faster)</span><br><span class="line"></span><br><span class="line">&gt; Task :groovySyntax</span><br><span class="line">start groovy syntax task</span><br><span class="line">900</span><br><span class="line"><span class="literal">true</span></span><br><span class="line">&#123;id=900, name=zhangliang, isMale=<span class="literal">true</span>&#125;</span><br><span class="line">key=id, value=900</span><br><span class="line">key=name, value=zhangliang</span><br><span class="line">key=isMale, value=<span class="literal">true</span></span><br><span class="line">entry-&gt;id=900,id, 900</span><br><span class="line">entry-&gt;name=zhangliang,name, zhangliang</span><br><span class="line">entry-&gt;isMale=<span class="literal">true</span>,isMale, <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">BUILD SUCCESSFUL <span class="keyword">in</span> 2s</span><br><span class="line">1 actionable task: 1 executed</span><br></pre></td></tr></table></figure>
<p>上面的代码和输出结果不难理解，分析如下：</p>
<ol>
<li>方法没有嵌套时，括号可以省略。<code>println &#39;start groovy syntax task&#39;</code>和<code>test.each&#123;...&#125;</code>写全就是<code>println(&#39;start groovy syntax task)&#39;</code>和<code>test.each(&#123;...&#125;)</code></li>
<li><code>Map</code>的定义参见<a target="_blank" rel="noopener" href="http://www.groovy-lang.org/syntax.html#_maps">语言规范-Map</a>。</li>
<li><code>Map</code>的方法<code>each(Closure closure)</code>的API文档说明如下<blockquote>
<p>Allows a Map to be iterated through using a closure. If the closure takes one parameter then it will be passed the Map.Entry otherwise if the closure takes two parameters then it will be passed the key and the value.<br>可以用一个闭包来迭代<code>Map</code>，闭包的参数如果是一个就作为<code>Map.Entry</code>，如果两个参数就作为<code>key</code>和<code>value</code>。</p>
</blockquote>
</li>
</ol>
<hr>
<br>



<h1 id="示例-修改Android项目输出的APK名称"><a href="#示例-修改Android项目输出的APK名称" class="headerlink" title="示例-修改Android项目输出的APK名称"></a>示例-修改Android项目输出的APK名称</h1><p>Android开发中，打包完后修改apk的名称是一个比较常见的做法。之前开发的Android项目中，在<code>app/build.gradle</code>中加入了几行代码，每次打包后自动修改apk的名称，相关代码如下：<br><code>app/build.gradle</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">// 利用git commit count 作为构建号</span><br><span class="line">static def gitBuildCode() &#123;</span><br><span class="line">    def cmd = &#x27;git rev-list HEAD --first-parent --count&#x27;</span><br><span class="line">    cmd.execute().text.trim().toInteger()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static def appName() &#123;</span><br><span class="line">    return &quot;youchat&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 修改输出文件的名称</span><br><span class="line">android.applicationVariants.all &#123; variant -&gt;</span><br><span class="line">    variant.outputs.all &#123;</span><br><span class="line">        if (outputFileName != null &amp;&amp; outputFileName.endsWith(&#x27;.apk&#x27;)) &#123;</span><br><span class="line">            def endStr = outputFileName</span><br><span class="line">            if (outputFileName.contains(&quot;debug&quot;)) &#123;</span><br><span class="line">                endStr = &quot;debug.apk&quot;</span><br><span class="line">            &#125; else if (outputFileName.contains(&quot;preRelease&quot;)) &#123;</span><br><span class="line">                endStr = &quot;preRelease.apk&quot;</span><br><span class="line">            &#125; else if (outputFileName.contains(&quot;release&quot;)) &#123;</span><br><span class="line">                endStr = &quot;release.apk&quot;</span><br><span class="line">            &#125;</span><br><span class="line">            outputFileName = &quot;$&#123;appName()&#125;_$&#123;android.defaultConfig.versionName&#125;_$&#123;gitBuildCode()&#125;_$&#123;endStr&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>打包完后，可以得到类似下面的文件<br><code>app/build/outputs/apk/preRelease/youchat_7.5.0_999_preRelease.apk</code><br>上面的代码逻辑比较简单，简单分析如下：</p>
<ol>
<li>定义了两个方法。<code>gitBuildCode ()</code>方法没有写<code>return</code>关键字，因为在<code>Groovy</code>中，方法总会返回值的，如果没有写<code>return</code>，就返回最后一行产生的值。参见<a target="_blank" rel="noopener" href="http://www.groovy-lang.org/objectorientation.html#_methods">语言规范-Object orientation-Method</a><blockquote>
<p>Methods in Groovy always return some value. If no return statement is provided, the value evaluated in the last line executed will be returned</p>
</blockquote>
</li>
<li><code>android.applicationVariants.all(Closure var1)</code>和<code>variant.outputs.all(Closure var1)</code>是Gradle DSL语法，可以查看它的<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/javadoc/">javadoc</a><blockquote>
<p>Executes the given closure against all objects in this collection, and any objects subsequently added to this collection. The object is passed to the closure as the closure delegate. Alternatively, it is also passed as a parameter.<br>迭代容器中所有的对象，并传递给闭包进行处理。</p>
</blockquote>
</li>
<li><code>variant.outputs.all(Closure var1)</code>闭包中的代码逻辑是很简单的，只说下最后一行<code>outputFileName</code>的赋值语句，它使用了<a target="_blank" rel="noopener" href="http://groovy-lang.org/syntax.html#all-strings">字符串插值</a>语法<code>$&#123;&#125;</code>，与kotlin里字符串模板是类似的。</li>
</ol>
<hr>
<br>



<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a target="_blank" rel="noopener" href="http://www.groovy-lang.org/">Groovy 官网</a></li>
<li><a target="_blank" rel="noopener" href="http://docs.groovy-lang.org/">Apache Groovy Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/singwhatiwanna/article/details/76084580">任玉刚 Gradle从入门到实战 - Groovy基础</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/javadoc/">Gradle DSL Javadoc</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/ba55dc163dfd">使用Groovy开发之新特性</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/innost/article/details/48228651">Gradle构建</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhangliangnbu.github.io/2018/08/27/android-build-01-guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="章亮">
      <meta itemprop="description" content="Developer For Android">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="永恒的码流">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/27/android-build-01-guide/" class="post-title-link" itemprop="url">Android构建01-前言</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-08-27 14:52:48" itemprop="dateCreated datePublished" datetime="2018-08-27T14:52:48+08:00">2018-08-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2018-10-17 14:52:48" itemprop="dateModified" datetime="2018-10-17T14:52:48+08:00">2018-10-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">Android开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><p>开发Android应用，就离不开基于Gradle的Android构建系统。刚开始做Android开发的时候，遇到编译问题，一般上网搜索解决之。但一般很难知道问题产生的深层次原因，也不知道以后如何避免，更不知道如何快速解决一般性的编译异常问题。想去学习，但一般的博客或书籍的内容与Android开发者官网介绍的内容相似，没有关于Groovy和Gradle的内容，让人很难理解，只知道是这样，而不知道为什么是这样。于是，一直想对Android构建系统做一个系统性的学习和总结，最近终于能够抽出一些空来做这件事。</p>
<p>本来只想写一篇文章，但写到Gradle之后，发现篇幅太长，故分开写，当做一个系列。</p>
<p><strong>核心问题</strong></p>
<p>当我执行<code>./gradlew assemble</code>命令时，我需要知道Gradle做了哪些事情？它是如何做的（即源码是如何写的）？</p>
<p><strong>学习目标</strong><br>对于Android Build System，我们应该掌握哪些知识或技能点呢？</p>
<ol>
<li>Groovy。语言基础，尤其是闭包概念，API快速查阅等。</li>
<li>Gradle。项目构建流程、基础概念、基本命令行指令、插件、API和Reference的查阅等。</li>
<li>Android Plugin。基础概念、Reference的查阅等。</li>
<li>Android应用构建（编译和打包）流程。</li>
</ol>
<p>文章也将主要按照这个学习流程来写。</p>
<p><strong>参考资料</strong><br>主要参考官方文档</p>
<ol>
<li><a target="_blank" rel="noopener" href="http://www.groovy-lang.org/learn.html">Groovy 官网</a></li>
<li><a target="_blank" rel="noopener" href="https://gradle.org/">Gradle官网</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/studio/build/">Android开发者官网-Configure your build</a></li>
</ol>
<br>

<h1 id="Android构建系统与三大知识块"><a href="#Android构建系统与三大知识块" class="headerlink" title="Android构建系统与三大知识块"></a>Android构建系统与三大知识块</h1><p><strong>Android构建系统</strong><br>Android构建系统，即Android Build System，它的作用是编译app资源和源代码，并将它们打包成APK。之后我们可以对APK进行测试、部署、签名和发布。</p>
<blockquote>
<p>The Android build system compiles app resources and source code, and packages them into APKs that you can test, deploy, sign, and distribute</p>
</blockquote>
<p><br><strong>三大知识块</strong><br>整个Android Build System基于三大知识块：</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="http://groovy-lang.org/">Apache Groovy</a><br>一种功能强大的JVM语言，包含脚本编写、DSL（特定领域语言）创建、运行时和编译时元编程以及函数编程等功能。</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://gradle.org/">Gradle</a><br>一种项目自动化构建工具。综合了Ant和Maven的一些特点，并使用Groovy的DSL来声明项目设置，而不是传统的XML。包含插件（Plugin）等功能。</p>
<blockquote>
<p>提示：目前Gradle可以使用Kotlin语言来编写脚本，但建议初学者以Groovy为主，毕竟遗留项目以及当前大多数项目的Gradle脚本都是使用Groovy来编写的。</p>
</blockquote>
</li>
<li><p><a target="_blank" rel="noopener" href="http://google.github.io/android-gradle-dsl/current/">Android Plugin</a><br>Gradle的插件，用于增加一些特定于构建Android应用的功能。</p>
</li>
</ul>
<br>

<h1 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h1><ol>
<li><p>主流操作系统。Gradle能够运行在所有的主流操作系统上，我的系统是<code>masOS High Sierra Version 10.13.6</code> 。</p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">Java JDK</a> 7+。Gradle基于Groovy，Groovy需要Java开发环境，Gradle官网说Gradle运行的最低Java JDK版本是7。</p>
<p>我的Java版本如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ java -version</span><br><span class="line">java version &quot;1.8.0_91&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_91-b14)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.91-b14, mixed mode)</span><br></pre></td></tr></table></figure></li>
<li><p>Gradle。Gradle环境中包含Groovy，因此安装Gradle之后就不需要单独安装Groovy了。各平台以及不同安装方式见官网 <a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/installation.html">Installing Gradle</a>。macOS上可以使用<code>Homebrew</code>快速安装<code>$ brew install gradle</code>，安装成功后，查看版本信息如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ gradle -v</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">Gradle 4.8.1</span><br><span class="line">------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Build time:   2018-06-21 07:53:06 UTC</span><br><span class="line">Revision:     0abdea078047b12df42e7750ccba34d69b516a22</span><br><span class="line"></span><br><span class="line">Groovy:       2.4.12</span><br><span class="line">Ant:          Apache Ant(TM) version 1.9.11 compiled on March 23 2018</span><br><span class="line">JVM:          1.8.0_91 (Oracle Corporation 25.91-b14)</span><br><span class="line">OS:           Mac OS X 10.13.6 x86_64</span><br></pre></td></tr></table></figure></li>
</ol>
<br>

<h1 id="Hello-World示例"><a href="#Hello-World示例" class="headerlink" title="Hello World示例"></a>Hello World示例</h1><p>创建一个简单的Gradle项目：包含一个<code>build.gradle</code>文件的目录。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir hello-world</span><br><span class="line">$ <span class="built_in">cd</span> hello-world</span><br><span class="line">$ vim build.gradle</span><br></pre></td></tr></table></figure>


<p><code>build.gradle</code>文件</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">task helloworld &#123;</span><br><span class="line">  doLast &#123;</span><br><span class="line">      println<span class="string">&#x27;Hello World!&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行任务</p>
<figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ gradle helloworld</span><br><span class="line"><span class="comment"># 输出如下：</span></span><br><span class="line">Starting a Gradle Daemon (subsequent builds will be faster)</span><br><span class="line">&gt; Task :helloworld</span><br><span class="line">Hello World!</span><br><span class="line">BUILD SUCCESSFUL <span class="keyword">in</span> 2s</span><br><span class="line">1 actionable task: 1 executed</span><br></pre></td></tr></table></figure>

<p>简单解释下 <code>build.gradle</code>文件：</p>
<ol>
<li><code>build.gradle</code>是Gradle的编译脚本，在构建过程中Gradle会据此生成一个<code>Project</code>的Java实例。</li>
<li><code>task</code>是<code>Gradle DSL</code>的关键字，用于添加任务到当前那项目中。<code>helloworld</code>是任务的名称。后面连接的一个Groovy闭包，构建时，会返回一个名为‘helloworld’的任务。</li>
<li>闭包中的<code>doLast</code>是<code>Task</code>的方法，根据闭包的语法，省略了方法的对象，写全的话是<code>owner.doLast</code>。表示向任务中添加一个打印’Hello World!’字符串的<code>Action</code>到任务的<code>Action</code>列表的最后。</li>
<li>一个任务（<code>Task</code>）可以包含很多<code>Action</code>，执行任务的时候，顺序执行<code>Action</code>。</li>
</ol>
<br>

<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a target="_blank" rel="noopener" href="http://www.groovy-lang.org/learn.html">Groovy 官网</a></li>
<li><a target="_blank" rel="noopener" href="https://gradle.org/">Gradle官网</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/studio/build/">Android开发者官网-Configure your build</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/innost/article/details/48228651">Gradle轻松入门</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="章亮"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">章亮</p>
  <div class="site-description" itemprop="description">Developer For Android</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">50</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">52</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zhangliangnbu" title="GitHub → https://github.com/zhangliangnbu" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhangliangnbu@qq.com" title="E-Mail → mailto:zhangliangnbu@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">章亮</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">182k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">2:46</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
